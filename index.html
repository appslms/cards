<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GAME OVER · Rewards CRM</title>
  <style>
    /* Tema oscuro con acentos neón para máxima legibilidad */
    :root {
      --ink: #07090f;           /* fondo principal muy oscuro */
      --panel: #0f1424;         /* paneles */
      --neon-yellow: #f6f200;   /* amarillo ácido */
      --neon-cyan: #00e5ff;     /* cian eléctrico */
      --neon-pink: #ff2bbf;     /* magenta graffiti */
      --muted: #a7b0c0;
      --text: #f2f6ff;          /* texto alto contraste */
      --border: rgba(255,255,255,.12);
      --glow: 0 0 0 2px rgba(0,229,255,.25), 0 0 0 6px rgba(0,229,255,.12);
    }

    * { box-sizing: border-box; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    body { margin: 0; color: var(--text); background: var(--ink); }

    /* Fondo: grid oscuro con líneas neón sutiles */
    .bg-tech {
      position: fixed; inset: 0; z-index: -1; overflow: hidden;
      background:
        radial-gradient(800px 400px at 80% 0%, rgba(0,229,255,.14), transparent 60%),
        radial-gradient(600px 300px at 15% 100%, rgba(255,43,191,.14), transparent 60%),
        repeating-linear-gradient(90deg, rgba(0,229,255,.08), rgba(0,229,255,.08) 1px, transparent 1px, transparent 80px),
        repeating-linear-gradient(0deg, rgba(255,43,191,.06), rgba(255,43,191,.06) 1px, transparent 1px, transparent 80px),
        var(--ink);
    }
    .bg-tech::before, .bg-tech::after{ content:""; position:absolute; inset:auto; pointer-events:none; }
    .bg-tech::before{ bottom:0; left:0; right:0; height:34%; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01)); border-top: 1px solid rgba(255,255,255,.08); clip-path: polygon(0 10%, 68% 0, 100% 6%, 100% 100%, 0 100%); }
    .bg-tech::after{ top:8%; left:6%; width:160px; height:160px; border:2px dashed rgba(0,229,255,.45); border-radius:24px; transform: rotate(14deg); }

    .wrap { max-width: 1120px; margin: 0 auto; padding: 24px; }

    .hero { display: grid; gap: 6px; margin-bottom: 16px; }
    .gameover {
      font-weight: 900; font-size: 42px; letter-spacing: 1px; text-transform: uppercase;
      color: var(--neon-yellow);
      text-shadow:
        0 2px 0 #000,
        0 0 8px rgba(246,242,0,.6),
        0 0 22px rgba(246,242,0,.35);
    }
    .subtitle { color: var(--muted); opacity:.95; }

    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border: 1px solid var(--border); border-radius: 18px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .card h2 { margin: 0 0 8px; font-size: 18px; text-transform: uppercase; letter-spacing: .5px; color: var(--text); }
    .muted { color: var(--muted); font-size: 14px; }

    label { display: block; font-size: 13px; margin: 10px 0 6px; color: var(--muted); text-transform: uppercase; }
    input[type="text"], input[type="password"], textarea, select { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); background: #0b1120; color: var(--text); outline: none; }
    input:focus, textarea:focus { box-shadow: var(--glow); border-color: rgba(0,229,255,.45); }
    textarea { min-height: 86px; resize: vertical; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .btn { display: inline-flex; gap: 8px; align-items: center; padding: 10px 14px; color: var(--text); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; text-decoration: none; transition: transform .05s ease, filter .2s ease, box-shadow .2s ease; background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); }
    .btn:hover { filter: brightness(1.08); box-shadow: var(--glow); }
    .btn:active { transform: translateY(1px); }
    .btn.brand { background: linear-gradient(180deg, rgba(0,229,255,.22), rgba(0,229,255,.10)); border-color: rgba(0,229,255,.6); }
    .btn.accent { background: linear-gradient(180deg, rgba(255,43,191,.22), rgba(255,43,191,.10)); border-color: rgba(255,43,191,.6); }
    .btn.danger { background: linear-gradient(180deg, rgba(255,79,79,.2), rgba(255,79,79,.1)); border-color: rgba(255,79,79,.55); }

    /* Tiles de rewards con alto contraste */
    .tiles { display: grid; grid-template-columns: repeat(5, minmax(90px,1fr)); gap: 10px; }
    @media (max-width: 640px){ .tiles { grid-template-columns: repeat(3, minmax(90px,1fr)); } }

    .tile { position: relative; border-radius: 14px; border: 1px solid var(--border); overflow: hidden; background:#0d1222; cursor: pointer; }
    .tile.is-selected { box-shadow: var(--glow); outline: 2px solid rgba(0,229,255,.35); }
    .tile img { width: 100%; display: block; aspect-ratio: 2 / 3; object-fit: cover; filter: contrast(1.05); }
    .tile .tag { position: absolute; left: 8px; bottom: 8px; background: rgba(0,0,0,.72); color: #eaf8ff; border:1px solid rgba(0,229,255,.6); border-radius: 10px; font-size: 12px; padding: 4px 8px; }
    .tile.lock::after { content: 'EVENTO FINAL'; position: absolute; inset: 8px; display:flex; align-items:center; justify-content:center; font-weight:800; letter-spacing:.6px; color: var(--neon-cyan); background: rgba(0,0,0,.68); border:1px dashed var(--neon-cyan); border-radius: 10px; text-shadow: 0 0 10px rgba(0,229,255,.5); }
    .tile.lock { cursor: not-allowed; filter: grayscale(.15) contrast(.95) brightness(.85); }

    /* Galería para miembros */
    .gallery { display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:12px; }
    .gallery .cardart { border-radius: 16px; overflow:hidden; border:1px solid var(--border); box-shadow: 0 8px 20px rgba(0,0,0,.35); background:#0d1222; }
    .gallery .cardart img { width:100%; display:block; aspect-ratio: 2/3; object-fit: cover; filter: contrast(1.05); }
    .gallery .label { padding:6px 8px; font-size:12px; color:#0b0b0b; background: linear-gradient(90deg, var(--neon-yellow), var(--neon-cyan)); font-weight: 700; }

    .list { display: grid; gap: 8px; margin-top: 8px; max-height: 340px; overflow: auto; }
    .item { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.03); }
    .item small { color: var(--muted); }

    .sep { height: 1px; background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.22), rgba(255,255,255,.0)); margin: 12px 0; }

    .hidden { display: none !important; }
    .status { margin-top: 8px; font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="bg-tech"></div>
  <div class="wrap">
    <div class="hero">
      <div class="gameover">Game Over · Rewards</div>
      <div class="subtitle">Tema techno urbano con tarjetas coleccionables. Final Boss no se asigna a nadie hasta el evento final.</div>
      <p id="testStatus" class="status"></p>
    </div>

    <div class="grid" id="authGrid">
      <div class="card">
        <h2>Ingreso de miembro</h2>
        <p class="muted">Escribe tu nombre tal cual lo registró el admin.</p>
        <label>Nombre</label>
        <input id="memberName" type="text" placeholder="Ej. Ana López" />
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn brand" id="memberLoginBtn">Entrar</button>
          <button class="btn" id="demoUserBtn">Probar demo</button>
        </div>
        <p class="muted" id="memberMsg" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <h2>Ingreso admin</h2>
        <p class="muted">Usa la clave compartida en el grupo.</p>
        <label>Clave</label>
        <input id="adminPass" type="password" placeholder="Clave de admin" />
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn accent" id="adminLoginBtn">Entrar como admin</button>
          <button class="btn" id="demoAdminBtn">Probar demo</button>
        </div>
        <p class="muted" id="adminMsg" style="margin-top:8px"></p>
      </div>
    </div>

    <div class="grid hidden" id="memberGrid">
      <div class="card">
        <h2>Tus tarjetas</h2>
        <div id="memberCards" class="gallery"></div>
        <div class="sep"></div>
        <h2>Tus comentarios</h2>
        <div id="memberComments" class="list"></div>
        <div class="sep"></div>
        <button class="btn" id="memberLogoutBtn">Salir</button>
      </div>
    </div>

    <div class="grid hidden" id="adminGrid">
      <div class="card">
        <h2>Alta rápida</h2>
        <label>Nombre del usuario</label>
        <input id="newUserName" type="text" placeholder="Nuevo miembro" />
        <label>Selecciona tarjetas</label>
        <div id="newUserRewards" class="tiles"></div>
        <small class="muted">Final Boss se desbloquea en el evento final y no se asigna manualmente.</small>
        <button class="btn accent" id="addUserBtn" style="margin-top:12px">Crear usuario</button>
        <p class="muted" id="addUserMsg" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <h2>Gestión de usuarios</h2>
        <label>Buscar</label>
        <input id="search" type="text" placeholder="Filtra por nombre" />
        <div class="list" id="usersList"></div>
      </div>

      <div class="card">
        <h2>Editar usuario</h2>
        <div id="editPanel" class="hidden">
          <div class="muted" id="editUserTitle"></div>
          <label>Tarjetas</label>
          <div id="editRewards" class="tiles"></div>
          <label>Comentario para el usuario</label>
          <textarea id="editComment" placeholder="Mensaje breve"></textarea>
          <div class="row" style="margin-top:12px;">
            <button class="btn brand" id="saveRewardsBtn">Guardar</button>
            <button class="btn" id="addCommentBtn">Agregar comentario</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <button class="btn danger" id="deleteUserBtn">Eliminar usuario</button>
            <button class="btn" id="clearPanelBtn">Limpiar panel</button>
          </div>
          <p class="muted" id="editMsg" style="margin-top:8px"></p>
        </div>
        <div id="noUserSelected" class="muted">Selecciona un usuario para editar.</div>
      </div>

      <div class="card">
        <h2>Sesión</h2>
        <button class="btn" id="adminLogoutBtn">Cerrar sesión admin</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // 1) Configura Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBlevLcY3TKVYQpr4Hur1f7XeZoHLbXCC0",
      authDomain: "gameover-b6eb7.firebaseapp.com",
      projectId: "gameover-b6eb7",
      storageBucket: "gameover-b6eb7.firebasestorage.app",
      messagingSenderId: "522023719283",
      appId: "1:522023719283:web:3e5ce88c28a52b56a27506"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2) Parámetros del sistema y catálogo de tarjetas
    const ADMIN_SECRET = "admin-123"; // cambia esta clave
    const REWARDS = [
      { id: "r1", label: "Joker",    img: "assets/card1.png", assignable: true },
      { id: "r2", label: "Predator", img: "assets/card2.png", assignable: true },
      { id: "r3", label: "Alien",    img: "assets/card3.png", assignable: true },
      { id: "r4", label: "Jason",    img: "assets/card4.png", assignable: true }, // nivel máximo para usuarios
      { id: "r5", label: "Final Boss. Chucky", img: "assets/card5.png", assignable: false } // evento final
    ];

    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs = {}, children = []) => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => { if (k === 'class') n.className = v; else if (k === 'text') n.textContent = v; else n.setAttribute(k, v); });
      children.forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
      return n;
    };
    const kebab = s => s.toLowerCase().trim().replace(/\s+/g,'-');

    // Estado + listeners
    let currentMember = null;
    let unsubMember = null, unsubUsers = null, unsubEdit = null;
    let cacheUsers = [];

    const allow = rid => (REWARDS.find(r => r.id === rid)?.assignable !== false);

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,a), ms); }; }

    // Tiles con imagen y selector
    function renderRewardTiles(container, selected = new Set(), onToggle, opts = { enforceAssignable: false }){
      container.innerHTML = '';
      REWARDS.forEach(r => {
        const disabled = opts.enforceAssignable && !r.assignable;
        const tile = el('button', { class: 'tile' + (disabled ? ' lock' : '') , type: 'button', title: disabled ? 'Se activa en el evento final' : r.label });
        if (selected.has(r.id)) tile.classList.add('is-selected');
        const img = el('img', { src: r.img, alt: r.label });
        const tag = el('div', { class: 'tag', text: r.label });
        tile.appendChild(img); tile.appendChild(tag);
        if (!disabled) tile.addEventListener('click', () => onToggle(r.id));
        container.appendChild(tile);
      });
    }
    function makeTileToggle(container, selected, opts){
      function toggle(rid){
        if (selected.has(rid)) selected.delete(rid); else selected.add(rid);
        renderRewardTiles(container, selected, toggle, opts);
      }
      renderRewardTiles(container, selected, toggle, opts);
      return toggle;
    }

    // Miembro: tiempo real
    function startMemberListener(memberId){
      if (unsubMember) { unsubMember(); unsubMember = null; }
      if (!memberId) return;
      const ref = db.collection('users').doc(memberId);
      unsubMember = ref.onSnapshot(doc => {
        if (!doc.exists) { $('#memberMsg').textContent = 'Este usuario ya no existe.'; return; }
        currentMember = { id: memberId, ...doc.data() };
        renderMemberPanels(currentMember);
      }, err => console.error('member onSnapshot', err));
    }

    function renderMemberPanels(member){
      const rewards = member.rewards || [];
      const comments = member.comments || [];

      const cardsBox = $('#memberCards');
      cardsBox.innerHTML = '';
      if (rewards.length === 0) cardsBox.appendChild(el('div', { class: 'muted', text: 'Aún no tienes tarjetas.' }));
      rewards.forEach(rid => {
        const r = REWARDS.find(x => x.id === rid);
        const wrap = el('div', { class: 'cardart' }, [ el('img', { src: r?.img || '', alt: r?.label || rid }), el('div', { class: 'label', text: r?.label || rid }) ]);
        cardsBox.appendChild(wrap);
      });

      const commentsBox = $('#memberComments');
      commentsBox.innerHTML = '';
      if (comments.length === 0) commentsBox.appendChild(el('div', { class: 'muted', text: 'Sin comentarios por ahora.' }));
      comments.slice().reverse().forEach(c => {
        const item = el('div', { class: 'item' }, [
          el('div', {}, [ el('div', { text: c.text || '' }), el('small', {}, [new Date(c.ts || Date.now()).toLocaleString()]) ]),
          el('div', { class: 'tag' }, [c.author || 'admin'])
        ]);
        commentsBox.appendChild(item);
      });
    }

    // Admin: lista y edición en tiempo real
    function startUsersListener(){
      if (unsubUsers) { unsubUsers(); unsubUsers = null; }
      unsubUsers = db.collection('users').orderBy('name').onSnapshot(snap => {
        cacheUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderUsersList();
      }, err => console.error('users onSnapshot', err));
    }

    function renderUsersList(){
      const list = $('#usersList'); list.innerHTML = '';
      const q = ($('#search').value || '').toLowerCase().trim();
      cacheUsers.filter(u => !q || (u.name || '').toLowerCase().includes(q)).forEach(u => {
        const row = el('div', { class: 'item' }, [
          el('div', {}, [ el('div', { text: u.name || u.id }), el('small', {}, [(u.rewards?.length || 0) + ' tarjetas']) ]),
          el('div', {}, [ el('button', { class: 'btn', type: 'button' }, ['Editar']) ])
        ]);
        row.querySelector('button').addEventListener('click', () => selectUser(u.id, u.name || u.id));
        list.appendChild(row);
      });
    }

    const debouncedSearch = debounce(renderUsersList, 200);

    async function selectUser(id, name){
      if (unsubEdit) { unsubEdit(); unsubEdit = null; }
      $('#noUserSelected').classList.add('hidden');
      $('#editPanel').classList.remove('hidden');
      $('#editUserTitle').textContent = name + ' (' + id + ')';
      const ref = db.collection('users').doc(id);
      let selected = new Set();
      makeTileToggle($('#editRewards'), selected, { enforceAssignable: true });

      unsubEdit = ref.onSnapshot(doc => {
        if (!doc.exists) { $('#editMsg').textContent = 'El usuario fue eliminado.'; $('#editPanel').classList.add('hidden'); $('#noUserSelected').classList.remove('hidden'); return; }
        const data = doc.data();
        selected = new Set((data.rewards || []).filter(allow)); // limpia Final Boss si estaba por error
        makeTileToggle($('#editRewards'), selected, { enforceAssignable: true });
      });

      $('#saveRewardsBtn').onclick = async () => {
        await ref.update({ rewards: Array.from(selected).filter(allow) });
        $('#editMsg').textContent = 'Tarjetas guardadas.';
      };
      $('#addCommentBtn').onclick = async () => {
        const text = $('#editComment').value.trim(); if (!text) { $('#editMsg').textContent = 'Escribe un comentario.'; return; }
        await ref.update({ comments: firebase.firestore.FieldValue.arrayUnion({ text, ts: Date.now(), author: 'admin' }) });
        $('#editComment').value = ''; $('#editMsg').textContent = 'Comentario agregado.';
      };
      $('#deleteUserBtn').onclick = async () => {
        if (!confirm('¿Eliminar este usuario?')) return; if (unsubEdit) { unsubEdit(); unsubEdit = null; }
        await ref.delete(); $('#editMsg').textContent = 'Usuario eliminado.';
        $('#editPanel').classList.add('hidden'); $('#noUserSelected').classList.remove('hidden');
      };
      $('#clearPanelBtn').onclick = () => { if (unsubEdit) { unsubEdit(); unsubEdit = null; } $('#editPanel').classList.add('hidden'); $('#noUserSelected').classList.remove('hidden'); };
    }

    // Auth miembro
    $('#memberLoginBtn').addEventListener('click', async () => {
      const name = $('#memberName').value.trim(); if (!name) { $('#memberMsg').textContent = 'Escribe un nombre.'; return; }
      try {
        const id = kebab(name); const ref = db.collection('users').doc(id); const snap = await ref.get();
        if (!snap.exists) { $('#memberMsg').textContent = 'No existe este usuario. Pide alta al admin.'; return; }
        localStorage.setItem('member', id); $('#authGrid').classList.add('hidden'); $('#memberGrid').classList.remove('hidden'); startMemberListener(id);
      } catch(e){ $('#memberMsg').textContent = 'Error de conexión. Intenta de nuevo.'; console.error(e); }
    });
    $('#memberLogoutBtn').addEventListener('click', () => { localStorage.removeItem('member'); if (unsubMember) { unsubMember(); unsubMember = null; } $('#memberGrid').classList.add('hidden'); $('#authGrid').classList.remove('hidden'); });

    // Auth admin
    $('#adminLoginBtn').addEventListener('click', () => { const pass = $('#adminPass').value.trim(); if (pass !== ADMIN_SECRET) { $('#adminMsg').textContent = 'Clave incorrecta.'; return; } localStorage.setItem('admin','1'); showAdminView(); });
    $('#adminLogoutBtn').addEventListener('click', () => { localStorage.removeItem('admin'); if (unsubUsers) { unsubUsers(); unsubUsers = null; } if (unsubEdit) { unsubEdit(); unsubEdit = null; } $('#adminGrid').classList.add('hidden'); $('#authGrid').classList.remove('hidden'); });

    // Demo
    $('#demoUserBtn').addEventListener('click', async () => { $('#memberName').value = 'Demo User'; await ensureDemoData(); $('#memberLoginBtn').click(); });
    $('#demoAdminBtn').addEventListener('click', () => { $('#adminPass').value = ADMIN_SECRET; $('#adminLoginBtn').click(); });

    function showAdminView(){ $('#authGrid').classList.add('hidden'); $('#adminGrid').classList.remove('hidden'); setupCreateUser(); startUsersListener(); $('#search').focus(); }

    function setupCreateUser(){
      const selected = new Set();
      makeTileToggle($('#newUserRewards'), selected, { enforceAssignable: true });
      $('#addUserBtn').onclick = async () => {
        const name = $('#newUserName').value.trim(); if (!name) { $('#addUserMsg').textContent = 'Escribe un nombre.'; return; }
        const id = kebab(name); const ref = db.collection('users').doc(id); const doc = await ref.get();
        if (doc.exists) { $('#addUserMsg').textContent = 'Ese usuario ya existe.'; return; }
        await ref.set({ name, rewards: Array.from(selected).filter(allow), comments: [], createdAt: Date.now() });
        $('#addUserMsg').textContent = 'Usuario creado.'; $('#newUserName').value = ''; selected.clear(); makeTileToggle($('#newUserRewards'), selected, { enforceAssignable: true });
      };
    }

    $('#search').addEventListener('input', debounce(renderUsersList, 180));

    window.addEventListener('DOMContentLoaded', async () => {
      runSmokeTests();
      const m = localStorage.getItem('member'); const a = localStorage.getItem('admin');
      if (m) { $('#authGrid').classList.add('hidden'); $('#memberGrid').classList.remove('hidden'); startMemberListener(m); return; }
      if (a === '1') { showAdminView(); return; }
    });

    async function ensureDemoData(){
      const sample = [
        { name: 'Demo User', rewards: ['r1','r3'], comments: [{ text: 'Bienvenido a la comunidad', ts: Date.now()-86400000, author: 'admin' }] },
        { name: 'Ana López', rewards: ['r2'], comments: [] },
        { name: 'Carlos Pérez', rewards: ['r4'], comments: [{ text: 'Felicidades por el logro', ts: Date.now()-3600000, author: 'admin' }] }
      ];
      for (const u of sample) {
        const id = kebab(u.name); const ref = db.collection('users').doc(id); const snap = await ref.get(); if (!snap.exists) await ref.set({ ...u, createdAt: Date.now() });
      }
    }

    async function runSmokeTests(){
      const results = [];
      try {
        results.push(['Firebase cargó', typeof firebase !== 'undefined']);
        results.push(['DB inicializada', !!db]);
        results.push(['Catálogo 5 tarjetas', REWARDS.length === 5 && REWARDS.some(r=>!r.assignable)]);
        results.push(['Funciones clave', ['renderRewardTiles','makeTileToggle','startUsersListener','startMemberListener','selectUser'].every(k => typeof window[k] === 'function')]);
        await db.collection('users').limit(1).get(); results.push(['Permisos de lectura', true]);
      } catch(e){ console.warn('Smoke tests', e); results.push(['Autochequeo falló', false]); }
      const elStatus = document.getElementById('testStatus'); if (elStatus) elStatus.textContent = 'Autochequeo: ' + results.map(r=>`${r[0]}: ${r[1]?'✔':'✖'}`).join(' • ');
    }
  </script>
</body>
</html>
