<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#07090f" />
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preload" as="image" href="assets/card1.png"/>
  <link rel="preload" as="image" href="assets/card2.png"/>
  <link rel="preload" as="image" href="assets/card3.png"/>
  <link rel="preload" as="image" href="assets/card4.png"/>
  <link rel="preload" as="image" href="assets/background.jpg"/>
  <title>GAME OVER Â· Rewards CRM</title>
  <style>
    :root {
      --ink: #07090f;           /* fondo principal muy oscuro */
      --panel: #0f1424;         /* paneles */
      --neon-yellow: #f6f200;   /* amarillo Ã¡cido */
      --neon-cyan: #00e5ff;     /* cian elÃ©ctrico */
      --neon-pink: #ff2bbf;     /* magenta */
      --muted: #a7b0c0;
      --text: #f2f6ff;          /* texto alto contraste */
      --border: rgba(255,255,255,.12);
      --glow: 0 0 0 2px rgba(0,229,255,.25), 0 0 0 6px rgba(0,229,255,.12);
    }

    * { box-sizing: border-box; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    body { margin: 0; color: var(--text); background: var(--ink); }

    /* Fondo con imagen oscurecida + grid neÃ³n sutil */
    .bg-tech { position: fixed; inset: 0; z-index: -1; overflow: hidden; background:
      linear-gradient(rgba(7,9,15,.78), rgba(7,9,15,.82)),
      url('assets/background.jpg') center / cover no-repeat fixed,
      radial-gradient(800px 400px at 80% 0%, rgba(0,229,255,.10), transparent 60%),
      radial-gradient(600px 300px at 15% 100%, rgba(255,43,191,.10), transparent 60%),
      repeating-linear-gradient(90deg, rgba(0,229,255,.06), rgba(0,229,255,.06) 1px, transparent 1px, transparent 80px),
      repeating-linear-gradient(0deg, rgba(255,43,191,.05), rgba(255,43,191,.05) 1px, transparent 1px, transparent 80px),
      var(--ink);
      filter: saturate(.9) brightness(.9);
    }
    .bg-tech::before, .bg-tech::after{ content:""; position:absolute; inset:auto; pointer-events:none; }
    .bg-tech::before{ bottom:0; left:0; right:0; height:32%; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border-top: 1px solid rgba(255,255,255,.08); clip-path: polygon(0 10%, 68% 0, 100% 6%, 100% 100%, 0 100%); }
    .bg-tech::after{ top:8%; left:6%; width:160px; height:160px; border:2px dashed rgba(0,229,255,.35); border-radius:24px; transform: rotate(14deg); opacity:.6; }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }

    .hero { display: grid; gap: 6px; margin-bottom: 8px; }
    .gameover {
      font-weight: 900; font-size: clamp(36px, 5vw, 56px); letter-spacing: 1px; text-transform: uppercase; color: var(--neon-yellow);
      text-shadow: 0 2px 0 #000, 0 0 8px rgba(246,242,0,.6), 0 0 22px rgba(246,242,0,.35);
      position: relative;
    }
    /* Efecto glitch por capas RGB en el tÃ­tulo */
    .gameover::before,
    .gameover::after { content: attr(data-text); position: absolute; inset: 0; pointer-events:none; mix-blend-mode: screen; opacity: 0; }
    .gameover::before { color: #00e5ff; transform: translate(0,0); }
    .gameover::after  { color: #ff2bbf; transform: translate(0,0); }
    .gameover.glitching::before { animation: rgb-shift 480ms steps(2,end); }
    .gameover.glitching::after  { animation: rgb-shift 480ms steps(2,end) reverse; }

    @keyframes rgb-shift { 0%,100%{opacity:0; transform: translate(0,0);} 10%{opacity:.9; transform: translate(-1px,1px);} 20%{transform: translate(2px,-1px);} 30%{transform: translate(-1px,2px);} 40%{transform: translate(1px,-2px);} 50%{opacity:0;} }

    /* Landing fullscreen: dos columnas, login destacado */
    .landing { min-height: calc(100vh - 48px); display: grid; grid-template-columns: minmax(340px, 520px) 1fr; align-items: center; gap: clamp(16px, 4vw, 36px); }
    .login-col { display: grid; gap: 18px; align-content: start; }
    .art-col { position: relative; align-self: stretch; border-radius: 22px; overflow: hidden; border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); }
    .art-col::before { /* lÃ­neas diagonales suaves */ content:""; position:absolute; inset:-30% -10%; background: repeating-linear-gradient(45deg, rgba(0,229,255,.1), rgba(0,229,255,.1) 2px, transparent 2px, transparent 18px); filter: blur(10px); opacity:.35; }
    .art-col::after { /* halo */ content:""; position:absolute; width: 60vmin; height: 60vmin; left: 50%; top: 50%; transform: translate(-50%,-50%); background: radial-gradient(closest-side, rgba(255,43,191,.12), transparent 60%); }

    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border: 1px solid var(--border); border-radius: 18px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); position:relative; overflow:hidden; }
    .card.loginCard { padding: 22px; border-radius: 20px; }
    .card.loginCard::after { /* scanlines sutiles */ content:""; position:absolute; inset:0; pointer-events:none; background: repeating-linear-gradient(0deg, rgba(255,255,255,.03), rgba(255,255,255,.03) 1px, transparent 1px, transparent 3px); opacity:.18; mix-blend-mode:soft-light; animation: scan 6s linear infinite; }
    @keyframes scan { 0%{transform: translateY(-10%);} 100%{transform: translateY(10%);} }

    .card h2 { margin: 0 0 8px; font-size: 18px; text-transform: uppercase; letter-spacing: .5px; color: var(--text); }
    .muted { color: var(--muted); font-size: 14px; }

    /* Login minimalista con CTA embebido */
    .loginRow { display:flex; align-items:center; gap:12px; }
    .loginLabel { font-weight: 900; letter-spacing: 1px; color: var(--text); }
    .bracket { position: relative; flex: 1; background: #0b1120cc; border: 1px solid var(--border); border-radius: 16px; padding: 12px 12px; padding-right: 56px; box-shadow: var(--glow); backdrop-filter: blur(4px); }
    .bracket::before { content: '['; position: absolute; left: -18px; top: 50%; transform: translateY(-50%); color: var(--neon-cyan); font-weight: 900; font-size: 22px; text-shadow: 0 0 8px rgba(0,229,255,.6); }
    .bracket::after { content: '}'; position: absolute; right: -18px; top: 50%; transform: translateY(-50%); color: var(--neon-cyan); font-weight: 900; font-size: 22px; text-shadow: 0 0 8px rgba(0,229,255,.6); }
    .bracket input { width: 100%; border: 0; outline: 0; background: transparent; color: var(--text); font-size: 18px; letter-spacing:.3px; }
    .bracket .submit { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); border: 1px solid var(--border); background: rgba(255,255,255,.08); border-radius: 12px; padding: 8px 12px; cursor: pointer; color: var(--text); font-size:18px; }
    .bracket .submit:hover { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }
    .bracket.shake { animation: shakeX 420ms cubic-bezier(.36,.07,.19,.97) both; }

    @keyframes shakeX { 10%,90%{ transform: translateX(-1px);} 20%,80%{ transform: translateX(2px);} 30%,50%,70%{ transform: translateX(-4px);} 40%,60%{ transform: translateX(4px);} }

    /* Botones */
    .btn { display: inline-flex; gap: 8px; align-items: center; padding: 10px 14px; color: var(--text); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; text-decoration: none; transition: transform .05s ease, filter .2s ease, box-shadow .2s ease; background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); }
    .btn:hover { filter: brightness(1.08); box-shadow: var(--glow); }
    .btn:active { transform: translateY(1px); }
    .btn.brand { background: linear-gradient(180deg, rgba(0,229,255,.22), rgba(0,229,255,.10)); border-color: rgba(0,229,255,.6); }
    .btn.accent { background: linear-gradient(180deg, rgba(255,43,191,.22), rgba(255,43,191,.10)); border-color: rgba(255,43,191,.6); }
    .btn.danger { background: linear-gradient(180deg, rgba(255,79,79,.2), rgba(255,79,79,.1)); border-color: rgba(255,79,79,.55); }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    /* Campos visuales modernos */
    .field { position: relative; margin: 8px 0; }
    .field .icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: .85; font-size: 14px; pointer-events: none; }
    .neo { width: 100%; padding: 12px 12px 12px 36px; border-radius: 14px; border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); color: var(--text); outline: none; box-shadow: inset 0 1px 0 rgba(255,255,255,.04); transition: box-shadow .2s ease, border-color .2s ease, filter .2s ease; }
    .neo:focus { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); filter: brightness(1.02); }
    .neo::placeholder { color: var(--muted); opacity: .75; }
    textarea.neo { min-height: 96px; resize: vertical; padding-top: 12px; }

    /* Chips de admin (solo texto) */
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border); background: #0d1222; font-size: 13px; cursor: pointer; }
    .chip.is-selected { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }
    .chip.lock { cursor: not-allowed; opacity: .6; }

    /* GalerÃ­a para miembros */
    .gallery { display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:12px; }
    .gallery .cardart { border-radius: 16px; overflow:hidden; border:1px solid var(--border); box-shadow: 0 8px 20px rgba(0,0,0,.35); background:#0d1222; opacity:0; transform: translateY(6px) scale(.995); animation: card-in .5s ease forwards; }
    .gallery .cardart img { width:100%; display:block; aspect-ratio: 2/3; object-fit: cover; filter: contrast(1.05); }
    .gallery .label { padding:6px 8px; font-size:12px; color:#0b0b0b; background: linear-gradient(90deg, var(--neon-yellow), var(--neon-cyan)); font-weight: 700; }
    @keyframes card-in { to { opacity:1; transform: none; } }

    .list { display: grid; gap: 8px; margin-top: 8px; max-height: 340px; overflow: auto; }
    .item { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.03); }
    .item small { color: var(--muted); cursor: copy; }

    .sep { height: 1px; background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.22), rgba(255,255,255,.0)); margin: 12px 0; }

    .hidden { display: none !important; }

    /* Toasts */
    .toast { position: fixed; right: 16px; top: 16px; display: grid; gap: 8px; z-index: 50; }
    .toast-item { background: #0b1120; border: 1px solid rgba(255,255,255,.14); padding: 10px 12px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,.35); }

    /* Responsivo */
    @media (max-width: 860px){
      .landing { grid-template-columns: 1fr; align-content: center; }
      .art-col { display:none; }
    }

    /* Accesibilidad */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="bg-tech"></div>

  <!-- Filtros SVG para glitch/desplazamiento -->
  <svg aria-hidden="true" focusable="false" width="0" height="0" style="position:absolute; overflow:hidden">
    <filter id="g-noise">
      <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" seed="2" result="noise"/>
    </filter>
    <filter id="g-glitch">
      <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="1" seed="3" result="t"/>
      <feDisplacementMap in="SourceGraphic" in2="t" scale="18" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </svg>

  <div class="wrap">
    <div class="hero">
      <div class="gameover" id="title" data-text="Game Over Â· Rewards">Game Over Â· Rewards</div>
    </div>

    <!-- Landing fullscreen con login a la izquierda y arte a la derecha -->
    <section class="landing" id="authGrid">
      <div class="login-col">
        <div class="card loginCard">
          <div class="loginRow">
            <span class="loginLabel">LOGIN</span>
            <div class="bracket" id="loginBracket">
              <input id="loginKey" type="text" placeholder="Ingresa tu telÃ©fono" autocomplete="off" inputmode="numeric" aria-label="TelÃ©fono" aria-describedby="loginMsg" />
              <button id="loginBtn" class="submit" aria-label="Entrar">âš¡</button>
            </div>
          </div>
          <p class="muted" id="loginMsg" aria-live="polite" style="margin-top:6px"></p>
        </div>
      </div>
      <div class="art-col" aria-hidden="true"></div>
    </section>

    <!-- Vista miembro -->
    <div class="grid hidden" id="memberGrid">
      <div class="card">
        <h2>Tus tarjetas</h2>
        <div id="memberCards" class="gallery"></div>
        <div class="sep"></div>
        <h2>Comentarios</h2>
        <div id="memberComments" class="list"></div>
        <div class="sep"></div>
        <button class="btn" id="memberLogoutBtn">Salir</button>
      </div>
    </div>

    <!-- Vista admin -->
    <div class="grid hidden" id="adminGrid">
      <div class="card">
        <h2>Alta rÃ¡pida</h2>
        <label>Nombre</label>
        <div class="field"><span class="icon">ðŸ‘¤</span><input class="neo" id="newUserName" type="text" placeholder="Nuevo miembro" /></div>
        <label>TelÃ©fono</label>
        <div class="field"><span class="icon">ðŸ“±</span><input class="neo" id="newUserPhone" type="text" placeholder="Ej. +506 6004 8606" /></div>
        <label>Tarjetas</label>
        <div id="newUserRewards" class="chips"></div>
        <button class="btn accent" id="addUserBtn" style="margin-top:12px">Crear usuario</button>
      </div>

      <div class="card">
        <h2>GestiÃ³n</h2>
        <label>Buscar</label>
        <div class="field"><span class="icon">ðŸ”Ž</span><input class="neo" id="search" type="text" placeholder="Nombre o telÃ©fono" /></div>
        <div class="list" id="usersList"></div>
      </div>

      <div class="card">
        <h2>Editar</h2>
        <div id="editPanel" class="hidden">
          <div class="muted" id="editUserTitle"></div>
          <label>Tarjetas</label>
          <div id="editRewards" class="chips"></div>
          <label>Comentario</label>
          <div class="field"><span class="icon">ðŸ’¬</span><textarea class="neo" id="editComment" placeholder="Mensaje breve"></textarea></div>
          <div class="row" style="margin-top:12px;">
            <button class="btn brand" id="saveRewardsBtn">Guardar</button>
            <button class="btn" id="addCommentBtn">Agregar comentario</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <button class="btn danger" id="deleteUserBtn">Eliminar usuario</button>
            <button class="btn" id="clearPanelBtn">Limpiar panel</button>
          </div>
        </div>
        <div id="noUserSelected" class="muted"></div>
      </div>

      <div class="card">
        <h2>SesiÃ³n</h2>
        <button class="btn" id="adminLogoutBtn">Cerrar sesiÃ³n</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    'use strict';
    // 1) Configura Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBlevLcY3TKVYQpr4Hur1f7XeZoHLbXCC0",
      authDomain: "gameover-b6eb7.firebaseapp.com",
      projectId: "gameover-b6eb7",
      storageBucket: "gameover-b6eb7.firebasestorage.app",
      messagingSenderId: "522023719283",
      appId: "1:522023719283:web:3e5ce88c28a52b56a27506"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2) CatÃ¡logo de tarjetas (orden 1â†’4, Final Boss bloqueado)
    const REWARDS = [
      { id: "r1", label: "Joker",    img: "assets/card1.png", assignable: true },
      { id: "r2", label: "Predator", img: "assets/card2.png", assignable: true },
      { id: "r3", label: "Alien",    img: "assets/card3.png", assignable: true },
      { id: "r4", label: "Jason",    img: "assets/card4.png", assignable: true },
      { id: "r5", label: "Final Boss. Chucky", img: "assets/card5.png", assignable: false }
    ];
    const ORDER = Object.fromEntries(REWARDS.map((r, i) => [r.id, i]));

    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs = {}, children = []) => { const n = document.createElement(tag); Object.entries(attrs).forEach(([k,v]) => { if (k === 'class') n.className = v; else if (k === 'text') n.textContent = v; else n.setAttribute(k, v); }); children.forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c)); return n; };
    const phoneKey = s => (s || '').replace(/\D+/g, ''); // solo dÃ­gitos para ID

    // Admin key levemente ofuscada (evita lectura casual en cÃ³digo)
    const ADMIN_KEY_B64 = 'RmluYWxCb3Nz'; // "FinalBoss" en Base64

    // Estado + listeners
    let unsubMember = null, unsubUsers = null, unsubEdit = null;
    let cacheUsers = [];

    const allow = rid => (REWARDS.find(r => r.id === rid)?.assignable !== false);
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,a), ms); }; }

    function toast(msg){
      const host = document.getElementById('toast');
      const item = el('div', { class: 'toast-item' }, [msg]);
      host.appendChild(item);
      glitchPulse(item, 320);
      setTimeout(()=>{ item.style.opacity = '0'; item.style.transform = 'translateY(-4px)'; item.style.transition = 'opacity .4s ease, transform .4s ease'; }, 2000);
      setTimeout(()=> item.remove(), 2600);
    }

    // Chips de admin (solo nombres)
    function renderRewardChips(container, selected = new Set(), onToggle, { enforceAssignable = true } = {}){
      container.innerHTML = '';
      REWARDS.forEach(r => {
        const disabled = enforceAssignable && !r.assignable;
        const chip = el('button', { class: 'chip' + (disabled ? ' lock' : '') , type: 'button' }, [r.label]);
        if (selected.has(r.id)) chip.classList.add('is-selected');
        if (!disabled) chip.addEventListener('click', () => onToggle(r.id));
        container.appendChild(chip);
      });
    }
    function makeChipToggle(container, selected, opts){
      function toggle(rid){ if (selected.has(rid)) selected.delete(rid); else selected.add(rid); renderRewardChips(container, selected, toggle, opts); }
      renderRewardChips(container, selected, toggle, opts); return toggle;
    }

    // Miembro: tiempo real
    function startMemberListener(memberId){
      if (unsubMember) { unsubMember(); unsubMember = null; }
      if (!memberId) return;
      const ref = db.collection('users').doc(memberId);
      unsubMember = ref.onSnapshot(doc => {
        if (!doc.exists) { document.getElementById('loginMsg').textContent = 'Este usuario ya no existe.'; return; }
        const data = doc.data();
        renderMemberPanels({ id: memberId, ...data });
      }, err => console.error('member onSnapshot', err));
    }

    function sortRewards(ids){
      return (ids || []).slice().sort((a,b)=> (ORDER[a] ?? 999) - (ORDER[b] ?? 999));
    }

    function renderMemberPanels(member){
      const rewards = sortRewards(member.rewards || []);
      const comments = member.comments || [];

      const cardsBox = document.getElementById('memberCards');
      cardsBox.innerHTML = '';
      if (rewards.length === 0) cardsBox.appendChild(el('div', { class: 'muted', text: 'Sin tarjetas por ahora.' }));
      rewards.forEach(rid => {
        const r = REWARDS.find(x => x.id === rid);
        const wrap = el('div', { class: 'cardart' }, [ el('img', { src: r?.img || '', alt: r?.label || rid }), el('div', { class: 'label', text: r?.label || rid }) ]);
        cardsBox.appendChild(wrap);
      });

      const commentsBox = document.getElementById('memberComments');
      commentsBox.innerHTML = '';
      if (comments.length === 0) commentsBox.appendChild(el('div', { class: 'muted', text: 'Sin comentarios.' }));
      comments.slice().reverse().forEach(c => {
        const item = el('div', { class: 'item' }, [
          el('div', {}, [ el('div', { text: c.text || '' }), el('small', {}, [new Date(c.ts || Date.now()).toLocaleString()]) ]),
          el('div', { class: 'chip is-selected' }, [c.author || 'admin'])
        ]);
        commentsBox.appendChild(item);
      });
    }

    // Admin: lista y ediciÃ³n en tiempo real
    function startUsersListener(){
      if (unsubUsers) { unsubUsers(); unsubUsers = null; }
      unsubUsers = db.collection('users').orderBy('name').onSnapshot(snap => {
        cacheUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderUsersList();
      }, err => console.error('users onSnapshot', err));
    }

    function renderUsersList(){
      const list = document.getElementById('usersList'); list.innerHTML = '';
      const q = (document.getElementById('search').value || '').toLowerCase().trim();
      cacheUsers.filter(u => !q || (u.name || '').toLowerCase().includes(q) || (u.phone || '').includes(q.replace(/\D+/g,''))).forEach(u => {
        const phoneTxt = (u.phone ? ('ðŸ“± ' + u.phone) : u.id);
        const row = el('div', { class: 'item' }, [
          el('div', {}, [ el('div', { text: u.name || u.id }), el('small', { class: 'copyable', 'data-phone': (u.phone||'') }, [ phoneTxt + ' â€¢ ' + (u.rewards?.length || 0) + ' tarjetas' ]) ]),
          el('div', {}, [ el('button', { class: 'btn', type: 'button' }, ['Editar']) ])
        ]);
        row.querySelector('button').addEventListener('click', () => selectUser(u.id, u.name || u.id));
        list.appendChild(row);
      });
    }

    async function selectUser(id, name){
      if (unsubEdit) { unsubEdit(); unsubEdit = null; }
      document.getElementById('noUserSelected').classList.add('hidden');
      document.getElementById('editPanel').classList.remove('hidden');
      document.getElementById('editUserTitle').textContent = name + ' (' + id + ')';
      const ref = db.collection('users').doc(id);
      let selected = new Set();
      makeChipToggle(document.getElementById('editRewards'), selected, { enforceAssignable: true });

      unsubEdit = ref.onSnapshot(doc => {
        if (!doc.exists) {
          toast('Usuario eliminado');
          document.getElementById('editPanel').classList.add('hidden');
          document.getElementById('noUserSelected').classList.remove('hidden');
          return;
        }
        const data = doc.data();
        selected = new Set(sortRewards((data.rewards || []).filter(allow)));
        makeChipToggle(document.getElementById('editRewards'), selected, { enforceAssignable: true });
      });

      document.getElementById('saveRewardsBtn').onclick = async () => {
        await ref.update({ rewards: sortRewards(Array.from(selected).filter(allow)) });
        toast('Tarjetas guardadas');
      };
      document.getElementById('addCommentBtn').onclick = async () => {
        const text = document.getElementById('editComment').value.trim(); if (!text) { toast('Escribe un comentario'); return; }
        await ref.update({ comments: firebase.firestore.FieldValue.arrayUnion({ text, ts: Date.now(), author: 'admin' }) });
        document.getElementById('editComment').value = '';
        toast('Comentario agregado');
      };
      document.getElementById('deleteUserBtn').onclick = async () => {
        if (!confirm('Â¿Eliminar este usuario?')) return; if (unsubEdit) { unsubEdit(); unsubEdit = null; }
        await ref.delete();
        toast('Usuario eliminado');
        document.getElementById('editPanel').classList.add('hidden');
        document.getElementById('noUserSelected').classList.remove('hidden');
      };
      document.getElementById('clearPanelBtn').onclick = () => { if (unsubEdit) { unsubEdit(); unsubEdit = null; } document.getElementById('editPanel').classList.add('hidden'); document.getElementById('noUserSelected').classList.remove('hidden'); };
    }

    // Login unificado: Enter o botÃ³n âš¡
    async function doLogin(){
      const key = document.getElementById('loginKey').value.trim();
      const msg = document.getElementById('loginMsg');
      const bracket = document.getElementById('loginBracket');
      if (!key) { msg.textContent = 'Ingresa tu telÃ©fono.'; pulseTitle(); bracket.classList.add('shake'); setTimeout(()=>bracket.classList.remove('shake'), 450); return; }
      // Admin: palabra secreta (no visible en UI)
      if (key.toLowerCase() === atob(ADMIN_KEY_B64).toLowerCase()) {
        localStorage.setItem('admin','1');
        pulseTitle();
        showAdminView();
        return;
      }
      const id = phoneKey(key);
      if (!id) { msg.textContent = 'TelÃ©fono invÃ¡lido.'; pulseTitle(); bracket.classList.add('shake'); setTimeout(()=>bracket.classList.remove('shake'), 450); return; }
      try {
        const ref = db.collection('users').doc(id); const snap = await ref.get();
        if (!snap.exists) { msg.textContent = 'No existe este usuario.'; pulseTitle(); return; }
        localStorage.setItem('member', id);
        showMemberView(); startMemberListener(id);
      } catch(e){ msg.textContent = 'Error de conexiÃ³n.'; console.error(e); }
    }

    document.getElementById('loginKey').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doLogin(); });
    document.getElementById('loginBtn').addEventListener('click', doLogin);

    // Copiar telÃ©fono rÃ¡pido desde la lista
    document.getElementById('usersList').addEventListener('click', (e)=>{
      const tgt = e.target.closest('.copyable');
      if (tgt && tgt.dataset.phone) {
        navigator.clipboard?.writeText(tgt.dataset.phone).then(()=> toast('TelÃ©fono copiado'));
      }
    });

    // Micro-efectos: glitch del tÃ­tulo en momentos clave
    function pulseTitle() {
      const t = document.getElementById('title');
      t.classList.add('glitching');
      setTimeout(()=> t.classList.remove('glitching'), 520);
    }
    function glitchPulse(el, ms=360){
      el.style.filter = 'url(#g-glitch)';
      setTimeout(()=>{ el.style.filter = 'none'; }, ms);
    }

    // Controles de sesiÃ³n
    document.getElementById('memberLogoutBtn')?.addEventListener('click', () => { localStorage.removeItem('member'); if (unsubMember) { unsubMember(); unsubMember = null; } showAuth(); });
    document.getElementById('adminLogoutBtn')?.addEventListener('click', () => { localStorage.removeItem('admin'); if (unsubUsers) { unsubUsers(); unsubUsers = null; } if (unsubEdit) { unsubEdit(); unsubEdit = null; } showAuth(); });

    function showAuth(){ document.getElementById('adminGrid').classList.add('hidden'); document.getElementById('memberGrid').classList.add('hidden'); document.getElementById('authGrid').classList.remove('hidden'); document.getElementById('loginKey').focus(); pulseTitle(); }
    function showMemberView(){ document.getElementById('authGrid').classList.add('hidden'); document.getElementById('memberGrid').classList.remove('hidden'); }
    function showAdminView(){ document.getElementById('authGrid').classList.add('hidden'); document.getElementById('adminGrid').classList.remove('hidden'); setupCreateUser(); startUsersListener(); document.getElementById('search').focus(); }

    function setupCreateUser(){
      const selected = new Set();
      makeChipToggle(document.getElementById('newUserRewards'), selected, { enforceAssignable: true });
      document.getElementById('addUserBtn').onclick = async () => {
        const name = document.getElementById('newUserName').value.trim();
        const phone = phoneKey(document.getElementById('newUserPhone').value.trim());
        if (!name) { toast('Falta nombre'); return; }
        if (!phone) { toast('TelÃ©fono invÃ¡lido'); return; }
        const ref = db.collection('users').doc(phone); const doc = await ref.get();
        if (doc.exists) { toast('TelÃ©fono ya registrado'); return; }
        await ref.set({ name, phone, rewards: sortRewards(Array.from(selected).filter(allow)), comments: [], createdAt: Date.now() });
        toast('Usuario creado');
        document.getElementById('newUserName').value = ''; document.getElementById('newUserPhone').value = ''; selected.clear();
        makeChipToggle(document.getElementById('newUserRewards'), selected, { enforceAssignable: true });
      };
    }

    document.getElementById('search').addEventListener('input', debounce(renderUsersList, 180));

    async function ensureDemoUser(){
      // Crea un Ãºnico usuario demo si no existe (CR: +506 6004 8606)
      const phone = '50660048606';
      const ref = db.collection('users').doc(phone);
      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({ name: 'Demo CR', phone, rewards: ['r1'], comments: [{ text: 'Bienvenid@ ðŸ‘¾', ts: Date.now(), author: 'admin' }], createdAt: Date.now() });
        console.log('Demo user creado');
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // Chequeo silencioso
      try {
        const results = [];
        results.push(['Firebase', typeof firebase !== 'undefined']);
        results.push(['DB', !!db]);
        results.push(['Rewards', REWARDS.length === 5]);
        await db.collection('users').limit(1).get(); results.push(['Lectura Firestore', true]);
        console.log('Smoke:', results.map(([k,v])=>`${k}:${v?'âœ”':'âœ–'}`).join(' â€¢ '));
      } catch(e){ console.warn('Smoke tests', e); }

      // Semilla: Ãºnico demo
      try { await ensureDemoUser(); } catch(e) { console.warn('No se pudo crear demo', e); }

      const m = localStorage.getItem('member'); const a = localStorage.getItem('admin');
      if (a === '1') { showAdminView(); return; }
      if (m) { showMemberView(); startMemberListener(m); return; }
      showAuth();
    });
  </script>
</body>
</html>
