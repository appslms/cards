<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SR Monitor — HTML único</title>
  <style>
    :root { --fg:#111; --bg:#fff; --muted:#666; --card:#f4f4f4; }
    @media (prefers-color-scheme: dark) {
      :root { --fg:#eee; --bg:#0b0b0b; --muted:#9aa0a6; --card:#151515; }
    }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    header, footer { padding:12px 16px; }
    header { border-bottom:1px solid #0002; position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:color-mix(in oklab, var(--bg) 88%, transparent); }
    h1 { font-size:16px; margin:0 0 8px 0; }
    .row { display:flex; flex-wrap:wrap; gap:8px 12px; align-items:center; }
    label { font-size:12px; color:var(--muted); }
    input, select, button { font:inherit; color:inherit; background:var(--card); border:1px solid #0003; border-radius:6px; padding:8px 10px; }
    input[type="number"] { width:8em; }
    button { cursor:pointer; }
    main { padding:16px; display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); }
    .card { background:var(--card); border:1px solid #0003; border-radius:10px; overflow:hidden; display:flex; flex-direction:column; }
    .card header { display:flex; justify-content:space-between; align-items:center; border:0; padding:10px 12px; background:transparent; position:static; }
    .meta { font-size:12px; color:var(--muted); }
    .imgwrap { aspect-ratio: 4 / 3; display:grid; place-items:center; background:#000; }
    img { width:100%; height:100%; object-fit:contain; background:#000; }
    .err { color:#c33; font-size:12px; padding:10px 12px; display:none; }
    footer { border-top:1px solid #0002; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; flex-wrap:wrap; gap:8px; }
    .time { font-variant-numeric: tabular-nums; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; padding:2px 6px; border:1px solid #0003; border-radius:4px; background:var(--card); }
  </style>
</head>
<body>
  <header>
    <h1>Monitoreo en vivo de Schumann Resonances</h1>
    <div class="row">
      <label>Origen:
        <select id="base">
          <!-- Tomsk SOS RFF, rutas públicas de imágenes en “/new/” -->
          <option value="https://sosrff.tsu.ru/new" selected>Tomsk SOS RFF /new</option>
          <!-- Espejo alterno visto en algunas integraciones -->
          <option value="https://sosrff.tsu.ru/srimage1">Tomsk espejo /srimage1</option>
        </select>
      </label>
      <label>Auto-refresh s:
        <input id="secs" type="number" min="5" step="5" value="60" />
      </label>
      <label>
        <input id="auto" type="checkbox" checked /> activar
      </label>
      <button id="refresh">Actualizar ahora</button>
      <span class="meta">UTC <span id="utc" class="time"></span> · Local <span id="loc" class="time"></span> · Tomsk UTC+7 <span id="t7" class="time"></span></span>
    </div>
  </header>

  <main id="grid">
    <!-- Tarjetas para cada producto SR conocido de Tomsk -->
  </main>

  <footer>
    <div>Fuente: imágenes públicas del sistema de observación espacial de Tomsk. Los endpoints carecen de API JSON documentada.</div>
    <div>Atajos: <span class="kbd">r</span> recargar, <span class="kbd">a</span> alternar auto, <span class="kbd">+</span>/<span class="kbd">−</span> ajustar intervalo.</div>
  </footer>

  <script>
    // Definición de productos SR habituales en Tomsk
    const PRODUCTS = [
      { key:"shm", name:"Espectrograma compuesto", hint:"shm.jpg", desc:"Vista general tipo “power/spectrogram” 1–40 Hz aprox." },
      { key:"srf", name:"Frecuencias", hint:"srf.jpg", desc:"Picos modales f0≈7.8 Hz, f1≈14.3 Hz, f2≈20.8 Hz, f3≈27.3 Hz." },
      { key:"sra", name:"Amplitudes", hint:"sra.jpg", desc:"Amplitud relativa por modo. Sensible a actividad eléctrica global." },
      { key:"srq", name:"Factores Q", hint:"srq.jpg", desc:"Calidad de resonancia por modo. Influida por conductividad ionosférica." }
    ];

    const grid = document.getElementById('grid');
    const baseSel = document.getElementById('base');
    const secsInput = document.getElementById('secs');
    const autoChk = document.getElementById('auto');
    const btnRefresh = document.getElementById('refresh');
    const utcEl = document.getElementById('utc');
    const locEl = document.getElementById('loc');
    const t7El = document.getElementById('t7');

    let timer = null;

    function fmt(tzOffsetMinutes) {
      const d = new Date();
      if (tzOffsetMinutes !== undefined) {
        // Construye una fecha ajustada a un offset fijo
        const utcMs = d.getTime() + (d.getTimezoneOffset()*60000);
        const ms = utcMs + tzOffsetMinutes*60000;
        return new Date(ms).toISOString().replace('T',' ').slice(0,19) + " UTC" + (tzOffsetMinutes>=0?"+":"") + (tzOffsetMinutes/60);
      }
      return d.toISOString().replace('T',' ').slice(0,19) + "Z";
    }

    function drawClock() {
      utcEl.textContent = new Date().toISOString().replace('T',' ').slice(0,19) + "Z";
      const now = new Date();
      const local = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().replace('T',' ').slice(0,19);
      locEl.textContent = local;
      const utcMs = now.getTime() + (now.getTimezoneOffset()*60000);
      const tomsk = new Date(utcMs + 7*3600*1000).toISOString().replace('T',' ').slice(0,19);
      t7El.textContent = tomsk + " UTC+7";
    }
    setInterval(drawClock, 1000);
    drawClock();

    function cardTemplate(p) {
      const id = `card-${p.key}`;
      return `
        <section class="card" id="${id}">
          <header>
            <div>
              <div style="font-weight:600">${p.name}</div>
              <div class="meta">${p.desc}</div>
            </div>
            <div class="meta">Actualizado <span id="${id}-ts" class="time">—</span></div>
          </header>
          <div class="imgwrap">
            <img id="${id}-img" alt="${p.name} (${p.hint})" />
          </div>
          <div id="${id}-err" class="err">Error al cargar. Revisa la conectividad o cambia de origen.</div>
        </section>
      `;
    }

    function mount() {
      grid.innerHTML = PRODUCTS.map(cardTemplate).join('');
    }
    mount();

    function buildURL(key) {
      const base = baseSel.value.replace(/\/+$/,'');
      return `${base}/${key}.jpg?nocache=${Date.now()}`;
    }

    function loadOne(p) {
      const img = document.getElementById(`card-${p.key}-img`);
      const ts = document.getElementById(`card-${p.key}-ts`);
      const err = document.getElementById(`card-${p.key}-err`);
      const url = buildURL(p.key);
      err.style.display = 'none';
      img.onerror = () => { err.style.display = 'block'; };
      img.onload = () => {
        ts.textContent = new Date().toLocaleString();
      };
      img.src = url;
    }

    function loadAll() {
      PRODUCTS.forEach(loadOne);
    }

    function startAuto() {
      stopAuto();
      const s = Math.max(5, Number(secsInput.value)||60);
      secsInput.value = s;
      timer = setInterval(loadAll, s*1000);
    }
    function stopAuto() {
      if (timer) { clearInterval(timer); timer = null; }
    }

    // Inicial
    loadAll();
    startAuto();

    // Controles
    baseSel.addEventListener('change', () => { loadAll(); });
    secsInput.addEventListener('change', () => { if (autoChk.checked) startAuto(); });
    autoChk.addEventListener('change', () => { autoChk.checked ? startAuto() : stopAuto(); });
    btnRefresh.addEventListener('click', loadAll);

    // Atajos de teclado
    window.addEventListener('keydown', (e) => {
      if (e.key === 'r' || e.key === 'R') { loadAll(); }
      if (e.key === 'a' || e.key === 'A') { autoChk.checked = !autoChk.checked; autoChk.dispatchEvent(new Event('change')); }
      if (e.key === '+') { secsInput.value = Math.max(5, Number(secsInput.value||60) - 5); secsInput.dispatchEvent(new Event('change')); }
      if (e.key === '-') { secsInput.value = Math.max(5, Number(secsInput.value||60) + 5); secsInput.dispatchEvent(new Event('change')); }
    });

    // Descarga rápida de la imagen visible actual en cada tarjeta
    function downloadCurrent(imgEl, name) {
      const a = document.createElement('a');
      a.href = imgEl.src;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Clic derecho para descargar
    grid.addEventListener('contextmenu', (e) => {
      const img = e.target.closest('img');
      if (!img) return;
      e.preventDefault();
      const id = img.id.replace('-img','');
      const key = id.split('-').pop();
      downloadCurrent(img, `${key}-${Date.now()}.jpg`);
    }, false);
  </script>
</body>
</html>
