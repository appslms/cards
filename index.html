<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#07090f" />
  <title>GAME OVER · Rewards CRM</title>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preload" as="image" href="assets/card1.png"/>
  <link rel="preload" as="image" href="assets/card2.png"/>
  <link rel="preload" as="image" href="assets/card3.png"/>
  <link rel="preload" as="image" href="assets/card4.png"/>
  <link rel="preload" as="image" href="assets/card5.png"/>
  <link rel="preload" as="image" href="assets/background.png"/>
  <style>
    :root {
      --ink: #07090f;
      --panel: #0f1424;
      --neon-yellow: #f6f200;
      --neon-cyan: #00e5ff;
      --neon-pink: #ff2bbf;
      --muted: #a7b0c0;
      --text: #f2f6ff;
      --border: rgba(255,255,255,.12);
      --glow: 0 0 0 2px rgba(0,229,255,.25), 0 0 0 6px rgba(0,229,255,.12);
    }

    * { box-sizing: border-box; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    body { margin: 0; color: var(--text); background: var(--ink); }
    img { max-width: 100%; display: block; }

    .bg-tech { position: fixed; inset: 0; z-index: -1; overflow: hidden; background:
      linear-gradient(rgba(7,9,15,.80), rgba(7,9,15,.86)),
      url('assets/background.png') center / cover no-repeat fixed,
      radial-gradient(800px 400px at 80% 0%, rgba(0,229,255,.10), transparent 60%),
      radial-gradient(600px 300px at 15% 100%, rgba(255,43,191,.10), transparent 60%),
      repeating-linear-gradient(90deg, rgba(0,229,255,.06), rgba(0,229,255,.06) 1px, transparent 1px, transparent 80px),
      repeating-linear-gradient(0deg, rgba(255,43,191,.05), rgba(255,43,191,.05) 1px, transparent 1px, transparent 80px),
      var(--ink);
      filter: saturate(.9) brightness(.9);
    }

    .wrap { max-width: 1300px; margin: 0 auto; padding: 24px clamp(20px, 4vw, 40px); }

    .hero { display: grid; gap: 6px; margin-bottom: clamp(8px, 2vh, 20px); }
    .gameover {
      font-weight: 900; font-size: clamp(36px, 5vw, 56px); letter-spacing: 1px; text-transform: uppercase; color: var(--neon-yellow);
      text-shadow: 0 2px 0 #000, 0 0 8px rgba(246,242,0,.6), 0 0 22px rgba(246,242,0,.35);
      position: relative;
    }
    .gameover::before,
    .gameover::after { content: attr(data-text); position: absolute; inset: 0; pointer-events:none; mix-blend-mode: screen; opacity: 0; }
    .gameover::before { color: #00e5ff; transform: translate(0,0); }
    .gameover::after  { color: #ff2bbf; transform: translate(0,0); }
    .gameover.glitching::before { animation: rgb-shift 480ms steps(2,end); }
    .gameover.glitching::after  { animation: rgb-shift 480ms steps(2,end) reverse; }

    @keyframes rgb-shift { 0%,100%{opacity:0; transform: translate(0,0);} 10%{opacity:.9; transform: translate(-1px,1px);} 20%{transform: translate(2px,-1px);} 30%{transform: translate(-1px,2px);} 40%{transform: translate(1px,-2px);} 50%{opacity:0;} }

    /* Layout genérico para vistas de panel */
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .card { border: 1px solid var(--border); border-radius: 18px; padding: 16px; background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); box-shadow: 0 20px 48px rgba(0,0,0,.45); }
    .card h2 { margin: 0 0 8px 0; font-size: 18px; letter-spacing: .5px; }
    .muted { color: var(--muted); }

    /* Landing / Login */
    .landing { min-height: calc(100vh - 120px); display: grid; grid-template-columns: minmax(540px, 980px); justify-content: center; align-content: center; align-items: center; }
    .login-stack { display: grid; gap: 18px; justify-self: center; width: 100%; max-width: 560px; }

    .loginBox { position: relative; border-radius: 20px; padding: clamp(18px, 3vw, 28px); background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border: 1px solid var(--border); box-shadow: 0 20px 48px rgba(0,0,0,.45), var(--glow); overflow:hidden; }
    .loginBox::after { content:""; position:absolute; inset:-40%; background: radial-gradient(600px 220px at 10% 0%, rgba(0,229,255,.14), transparent 50%); pointer-events:none; }
    .loginTitle { font-size: 14px; letter-spacing: 1.5px; text-transform: uppercase; opacity:.9; margin-bottom: 10px; }

    .phoneInput { position: relative; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px; border: 1px solid var(--border); border-radius: 16px; padding: 12px 12px 12px 14px; background: #0b1120cc; backdrop-filter: blur(6px); box-shadow: var(--glow); }
    .ccBtn { display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background: linear-gradient(180deg, rgba(0,229,255,.16), rgba(0,229,255,.06)); color: var(--text); font-weight:800; cursor:pointer; }
    .ccBtn:hover { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }
    .ccMenu { position:absolute; top: calc(100% + 8px); left: 0; width: 280px; max-height: 260px; overflow:auto; background:#0b1120; border:1px solid var(--border); border-radius:12px; box-shadow: 0 16px 40px rgba(0,0,0,.55); z-index:5; }
    .ccItem { padding:8px 10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
    .ccItem:hover { background: rgba(0,229,255,.10); }
    #loginInput { width: 100%; border: 0; outline: 0; background: transparent; color: var(--text); font-size: 22px; letter-spacing: .6px; }
    #loginInput::placeholder { color: #93a0b3; opacity:.9; }
    .goBtn { border: 1px solid var(--border); border-radius: 12px; padding: 10px 14px; cursor: pointer; font-weight: 800; background: linear-gradient(180deg, rgba(0,229,255,.22), rgba(0,229,255,.08)); color: var(--text); }
    .goBtn:hover { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }
    .phoneInput.shake { animation: shakeX 420ms cubic-bezier(.36,.07,.19,.97) both; }

    .loginMeta { display:flex; gap:12px; align-items:center; color: var(--muted); font-size: 13px; min-height: 18px; }

    .art { position: relative; height: clamp(420px, 58vh, 640px); border-radius: 22px; overflow: hidden; border: 1px solid var(--border); background:
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015)); justify-self: center; width: 100%; max-width: 760px; }
    .art::before { content:""; position:absolute; inset:0; background:
      radial-gradient(80% 40% at 20% 10%, rgba(0,229,255,.14), transparent 60%),
      radial-gradient(60% 40% at 70% 80%, rgba(255,43,191,.16), transparent 60%),
      url('assets/background.png') center / cover no-repeat; filter: brightness(.7) contrast(1); }
    .art::after { content:""; position:absolute; inset:0; background: repeating-linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.05) 1px, transparent 1px, transparent 60px), repeating-linear-gradient(0deg, rgba(0,0,0,.12), rgba(0,0,0,.12) 1px, transparent 1px, transparent 60px); opacity:.25; mix-blend-mode: soft-light; }

    /* Overlay con efecto glass dentro de la tarjeta */
    .art { perspective: 900px; transform-style: preserve-3d; }
    .art .overlay { position: absolute; left: clamp(16px, 4vw, 32px); right: clamp(16px, 4vw, 32px); bottom: clamp(16px, 4vw, 32px); display: grid; gap: 12px; background: rgba(11,17,32,.72); backdrop-filter: blur(10px) saturate(1.1); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: var(--glow); transform: translateZ(30px); }
    .shine { position: absolute; inset: -20%; background:
      radial-gradient(40% 12% at 30% 0%, rgba(255,255,255,.08), transparent 60%),
      linear-gradient(115deg, transparent 40%, rgba(255,255,255,.06) 50%, transparent 60%);
      mix-blend-mode: screen; animation: sweep 6s linear infinite; pointer-events: none; }
    @keyframes sweep { from { transform: translateX(-20%) rotate(.001deg); } to { transform: translateX(20%) rotate(.001deg); } }

    @keyframes shakeX { 10%,90%{ transform: translateX(-1px);} 20%,80%{ transform: translateX(2px);} 30%,50%,70%{ transform: translateX(-4px);} 40%,60%{ transform: translateX(4px);} }

    .btn { display: inline-flex; gap: 8px; align-items: center; padding: 10px 14px; color: var(--text); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; text-decoration: none; transition: transform .05s ease, filter .2s ease, box-shadow .2s ease; background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); }
    .btn:hover { filter: brightness(1.08); box-shadow: var(--glow); }
    .btn:active { transform: translateY(1px); }
    .btn.brand { background: linear-gradient(180deg, rgba(0,229,255,.22), rgba(0,229,255,.10)); border-color: rgba(0,229,255,.6); }
    .btn.accent { background: linear-gradient(180deg, rgba(255,43,191,.22), rgba(255,43,191,.10)); border-color: rgba(255,43,191,.6); }
    .btn.danger { background: linear-gradient(180deg, rgba(255,79,79,.2), rgba(255,79,79,.1)); border-color: rgba(255,79,79,.55); }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .field { position: relative; margin: 8px 0; }
    .field .icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: .85; font-size: 14px; pointer-events: none; }
    .neo { width: 100%; padding: 12px 12px 12px 36px; border-radius: 14px; border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); color: var(--text); outline: none; box-shadow: inset 0 1px 0 rgba(255,255,255,.04); transition: box-shadow .2s ease, border-color .2s ease, filter .2s ease; }
    .neo:focus { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); filter: brightness(1.02); }
    .neo::placeholder { color: var(--muted); opacity: .75; }
    textarea.neo { min-height: 96px; resize: vertical; padding-top: 12px; }

    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border); background: #0d1222; font-size: 13px; cursor: pointer; }
    .chip.is-selected { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }
    .chip.lock { cursor: not-allowed; opacity: .6; }

    .gallery { display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:12px; }
    .gallery .cardart { border-radius: 16px; overflow:hidden; border:1px solid var(--border); box-shadow: 0 8px 20px rgba(0,0,0,.35); background:#0d1222; opacity:0; transform: translateY(6px) scale(.995); animation: card-in .5s ease forwards; }
    .gallery .cardart img { width:100%; display:block; aspect-ratio: 2/3; object-fit: cover; filter: contrast(1.05); }
    .gallery .label { padding:6px 8px; font-size:12px; color:#0b0b0b; background: linear-gradient(90deg, var(--neon-yellow), var(--neon-cyan)); font-weight: 700; }
    @keyframes card-in { to { opacity:1; transform: none; } }

    .list { display: grid; gap: 8px; margin-top: 8px; max-height: 340px; overflow: auto; }
    .item { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.03); }
    .item small { color: var(--muted); cursor: copy; }

    .sep { height: 1px; background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.22), rgba(255,255,255,.0)); margin: 12px 0; }

    .hidden { display: none !important; }

    .toast { position: fixed; right: 16px; top: 16px; display: grid; gap: 8px; z-index: 50; }
    .toast-item { background: #0b1120; border: 1px solid rgba(255,255,255,.14); padding: 10px 12px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,.35); }

    .adminLink { position: fixed; right: 14px; bottom: 10px; z-index: 60; opacity: .6; font-size: 12px; }
    .adminLink button { background: none; border: 0; color: #9feaff; text-decoration: underline; cursor: pointer; padding: 0; }
    .adminLink button:hover { opacity: .95; }
    .modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(7,9,15,.6); backdrop-filter: blur(2px); z-index: 80; }
    .modal .box { width: 320px; border-radius: 16px; border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); padding: 16px; box-shadow: 0 20px 48px rgba(0,0,0,.5); }

    @media (max-width: 1180px){ .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 980px){ .landing { grid-template-columns: 1fr; } .art { height: 38vh; } .grid { grid-template-columns: 1fr; } }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="bg-tech" aria-hidden="true"></div>

  <svg aria-hidden="true" focusable="false" width="0" height="0" style="position:absolute; overflow:hidden">
    <filter id="g-glitch">
      <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="1" seed="3" result="t"/>
      <feDisplacementMap in="SourceGraphic" in2="t" scale="18" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
  </svg>

  <div class="wrap">
    <div class="hero">
      <div class="gameover" id="title" data-text="Game Over · Rewards">Game Over · Rewards</div>
    </div>

    <section class="landing" id="authGrid">
      <div class="art" aria-label="Tarjeta de acceso">
        <span class="shine" aria-hidden="true"></span>
        <div class="overlay">
          <div class="loginTitle">Login</div>
          <div class="phoneInput" id="loginBox">
            <button class="ccBtn" id="ccBtn" type="button" aria-haspopup="listbox" aria-expanded="false"><span id="ccCode">CR</span>&nbsp;<span id="ccDial">+506</span>&nbsp;▾</button>
            <input id="loginInput" type="tel" inputmode="numeric" placeholder="6004 8606" autocomplete="one-time-code" aria-label="Teléfono" />
            <button id="loginGo" class="goBtn" aria-label="Entrar">ENTER</button>
            <div id="ccMenu" class="ccMenu hidden" role="listbox" aria-label="Seleccionar país"></div>
          </div>
          <div class="loginMeta" id="loginMsg" aria-live="polite"></div>
        </div>
      </div>
    </section>

    <div class="adminLink"><button id="adminOpen" type="button">[admin]</button></div>

    <div id="adminModal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="box">
        <div class="loginTitle">Admin</div>
        <input id="adminPwd" type="password" class="neo" placeholder="Contraseña" aria-label="Contraseña de administrador" />
        <div class="row" style="margin-top:10px;">
          <button class="btn brand" id="adminEnter">Entrar</button>
          <button class="btn" id="adminCancel">Cancelar</button>
        </div>
        <div class="loginMeta" id="adminMsg"></div>
      </div>
    </div>

    <!-- Vista miembro -->
    <div class="grid hidden" id="memberGrid">
      <div class="card">
        <h2>Tus tarjetas</h2>
        <div id="memberCards" class="gallery"></div>
        <div class="sep"></div>
        <h2>Comentarios</h2>
        <div id="memberComments" class="list"></div>
        <div class="sep"></div>
        <button class="btn" id="memberLogoutBtn">Salir</button>
      </div>
    </div>

    <!-- Vista admin -->
    <div class="grid hidden" id="adminGrid">
      <div class="card">
        <h2>Alta rápida</h2>
        <label for="newUserName">Nombre</label>
        <div class="field"><span class="icon">👤</span><input class="neo" id="newUserName" type="text" placeholder="Nuevo miembro" /></div>
        <label for="newUserPhone">Teléfono</label>
        <div class="field"><span class="icon">📱</span><input class="neo" id="newUserPhone" type="text" placeholder="Ej. +506 6004 8606" /></div>
        <label>Tarjetas</label>
        <div id="newUserRewards" class="chips"></div>
        <button class="btn accent" id="addUserBtn" style="margin-top:12px">Crear usuario</button>
      </div>

      <div class="card">
        <h2>Gestión</h2>
        <label for="search">Buscar</label>
        <div class="field"><span class="icon">🔎</span><input class="neo" id="search" type="text" placeholder="Nombre o teléfono" /></div>
        <div class="list" id="usersList"></div>
      </div>

      <div class="card">
        <h2>Editar</h2>
        <div id="editPanel" class="hidden">
          <div class="muted" id="editUserTitle"></div>
          <label>Tarjetas</label>
          <div id="editRewards" class="chips"></div>
          <label for="editComment">Comentario</label>
          <div class="field"><span class="icon">💬</span><textarea class="neo" id="editComment" placeholder="Mensaje breve"></textarea></div>
          <div class="row" style="margin-top:12px;">
            <button class="btn brand" id="saveRewardsBtn">Guardar</button>
            <button class="btn" id="addCommentBtn">Agregar comentario</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <button class="btn danger" id="deleteUserBtn">Eliminar usuario</button>
            <button class="btn" id="clearPanelBtn">Limpiar panel</button>
          </div>
        </div>
        <div id="noUserSelected" class="muted">Selecciona un usuario para editar.</div>
      </div>

      <div class="card">
        <h2>Sesión</h2>
        <button class="btn" id="adminLogoutBtn">Cerrar sesión</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    'use strict';
    // 1) Configura Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBlevLcY3TKVYQpr4Hur1f7XeZoHLbXCC0",
      authDomain: "gameover-b6eb7.firebaseapp.com",
      projectId: "gameover-b6eb7",
      storageBucket: "gameover-b6eb7.firebasestorage.app",
      messagingSenderId: "522023719283",
      appId: "1:522023719283:web:3e5ce88c28a52b56a27506"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2) Catálogo de tarjetas
    const REWARDS = [
      { id: "r1", label: "Joker",    img: "assets/card1.png", assignable: true },
      { id: "r2", label: "Predator", img: "assets/card2.png", assignable: true },
      { id: "r3", label: "Alien",    img: "assets/card3.png", assignable: true },
      { id: "r4", label: "Jason",    img: "assets/card4.png", assignable: true },
      { id: "r5", label: "Final Boss. Chucky", img: "assets/card5.png", assignable: false }
    ];
    const ORDER = Object.fromEntries(REWARDS.map((r, i) => [r.id, i]));

    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs = {}, children = []) => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if (k === 'class') n.className = v;
        else if (k === 'text') n.textContent = v;
        else if (k === 'dataset') Object.entries(v).forEach(([dk,dv])=> n.dataset[dk] = dv);
        else n.setAttribute(k, v);
      });
      children.forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
      return n;
    };
    const digits = s => (s || '').replace(/\D+/g, '');

    // Normaliza a clave basada en país seleccionado
    function buildIdFromInput(){
      const inp = document.getElementById('loginInput');
      const d = digits(inp?.value || '');
      if (!d) return '';
      const cc = currentCountry.cc;
      if (d.startsWith(cc)) return d;
      return cc + d;
    }

    // Admin key ofuscada (evita lectura casual)
    const ADMIN_KEY_B64 = 'RmluYWxCb3Nz'; // "FinalBoss"

    // Estado + listeners
    let unsubMember = null, unsubUsers = null, unsubEdit = null;
    let cacheUsers = [];

    const allow = rid => (REWARDS.find(r => r.id === rid)?.assignable !== false);
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,a), ms); }; }

    function toast(msg){
      const host = document.getElementById('toast');
      const item = el('div', { class: 'toast-item' }, [msg]);
      host.appendChild(item);
      // Efecto breve
      item.style.filter = 'url(#g-glitch)';
      setTimeout(()=>{ item.style.filter = 'none'; }, 360);
      setTimeout(()=>{ item.style.opacity = '0'; item.style.transform = 'translateY(-4px)'; item.style.transition = 'opacity .4s ease, transform .4s ease'; }, 2000);
      setTimeout(()=> item.remove(), 2600);
    }

    // Chips de admin
    function renderRewardChips(container, selected = new Set(), onToggle, { enforceAssignable = true } = {}){
      container.innerHTML = '';
      REWARDS.forEach(r => {
        const disabled = enforceAssignable && !r.assignable;
        const chip = el('button', { class: 'chip' + (disabled ? ' lock' : ''), type: 'button' }, [r.label]);
        if (selected.has(r.id)) chip.classList.add('is-selected');
        if (!disabled) chip.addEventListener('click', () => onToggle(r.id));
        container.appendChild(chip);
      });
    }
    function makeChipToggle(container, selected, opts){
      function toggle(rid){
        if (selected.has(rid)) selected.delete(rid); else selected.add(rid);
        renderRewardChips(container, selected, toggle, opts);
      }
      renderRewardChips(container, selected, toggle, opts);
      return toggle;
    }

    // Miembro: tiempo real
    function startMemberListener(memberId){
      if (unsubMember) { unsubMember(); unsubMember = null; }
      if (!memberId) return;
      const ref = db.collection('users').doc(memberId);
      unsubMember = ref.onSnapshot(doc => {
        if (!doc.exists) { document.getElementById('loginMsg').textContent = 'Este usuario ya no existe.'; return; }
        const data = doc.data();
        renderMemberPanels({ id: memberId, ...data });
      }, err => console.error('member onSnapshot', err));
    }

    function sortRewards(ids){
      return (ids || []).slice().sort((a,b)=> (ORDER[a] ?? 999) - (ORDER[b] ?? 999));
    }

    function renderMemberPanels(member){
      const rewards = sortRewards(member.rewards || []);
      const comments = member.comments || [];

      const cardsBox = document.getElementById('memberCards');
      cardsBox.innerHTML = '';
      if (rewards.length === 0) cardsBox.appendChild(el('div', { class: 'muted', text: 'Sin tarjetas por ahora.' }));
      rewards.forEach(rid => {
        const r = REWARDS.find(x => x.id === rid);
        const wrap = el('div', { class: 'cardart' }, [ el('img', { src: r?.img || '', alt: r?.label || rid }), el('div', { class: 'label', text: r?.label || rid }) ]);
        cardsBox.appendChild(wrap);
      });

      const commentsBox = document.getElementById('memberComments');
      commentsBox.innerHTML = '';
      if (comments.length === 0) commentsBox.appendChild(el('div', { class: 'muted', text: 'Sin comentarios.' }));
      comments.slice().reverse().forEach(c => {
        const item = el('div', { class: 'item' }, [
          el('div', {}, [ el('div', { text: c.text || '' }), el('small', {}, [new Date(c.ts || Date.now()).toLocaleString()]) ]),
          el('div', { class: 'chip is-selected' }, [c.author || 'admin'])
        ]);
        commentsBox.appendChild(item);
      });
    }

    // Admin: lista y edición en tiempo real
    function startUsersListener(){
      if (unsubUsers) { unsubUsers(); unsubUsers = null; }
      unsubUsers = db.collection('users').orderBy('name').onSnapshot(snap => {
        cacheUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderUsersList();
      }, err => console.error('users onSnapshot', err));
    }

    function renderUsersList(){
      const list = document.getElementById('usersList'); list.innerHTML = '';
      const q = (document.getElementById('search').value || '').toLowerCase().trim();
      cacheUsers
        .filter(u => !q || (u.name || '').toLowerCase().includes(q) || (u.phone || '').includes(q.replace(/\D+/g,'')))
        .forEach(u => {
          const phoneTxt = (u.phone ? ('📱 ' + u.phone) : u.id);
          const row = el('div', { class: 'item' }, [
            el('div', {}, [
              el('div', { text: u.name || u.id }),
              el('small', { class: 'copyable', dataset: { phone: (u.phone || '') } }, [ phoneTxt + ' • ' + (u.rewards?.length || 0) + ' tarjetas' ])
            ]),
            el('div', {}, [ el('button', { class: 'btn', type: 'button' }, ['Editar']) ])
          ]);
          row.querySelector('button').addEventListener('click', () => selectUser(u.id, u.name || u.id));
          row.querySelector('small.copyable').addEventListener('click', async (e) => {
            const p = e.currentTarget.dataset.phone || '';
            if (!p) return;
            try { await navigator.clipboard.writeText(p); toast('Teléfono copiado'); } catch(_) { /* noop */ }
          });
          list.appendChild(row);
        });
    }

    async function selectUser(id, name){
      if (unsubEdit) { unsubEdit(); unsubEdit = null; }
      document.getElementById('noUserSelected').classList.add('hidden');
      document.getElementById('editPanel').classList.remove('hidden');
      document.getElementById('editUserTitle').textContent = name + ' (' + id + ')';
      const ref = db.collection('users').doc(id);
      let selected = new Set();
      makeChipToggle(document.getElementById('editRewards'), selected, { enforceAssignable: true });

      unsubEdit = ref.onSnapshot(doc => {
        if (!doc.exists) {
          toast('Usuario eliminado');
          document.getElementById('editPanel').classList.add('hidden');
          document.getElementById('noUserSelected').classList.remove('hidden');
          return;
        }
        const data = doc.data();
        selected = new Set(sortRewards((data.rewards || []).filter(allow)));
        makeChipToggle(document.getElementById('editRewards'), selected, { enforceAssignable: true });
      });

      document.getElementById('saveRewardsBtn').onclick = async () => {
        await ref.update({ rewards: sortRewards(Array.from(selected).filter(allow)) });
        toast('Tarjetas guardadas');
      };
      document.getElementById('addCommentBtn').onclick = async () => {
        const text = document.getElementById('editComment').value.trim();
        if (!text) { toast('Escribe un comentario'); return; }
        await ref.update({ comments: firebase.firestore.FieldValue.arrayUnion({ text, ts: Date.now(), author: 'admin' }) });
        document.getElementById('editComment').value = '';
        toast('Comentario agregado');
      };
      document.getElementById('deleteUserBtn').onclick = async () => {
        if (!confirm('¿Eliminar este usuario?')) return;
        if (unsubEdit) { unsubEdit(); unsubEdit = null; }
        await ref.delete();
        toast('Usuario eliminado');
        document.getElementById('editPanel').classList.add('hidden');
        document.getElementById('noUserSelected').classList.remove('hidden');
      };
      document.getElementById('clearPanelBtn').onclick = () => {
        if (unsubEdit) { unsubEdit(); unsubEdit = null; }
        document.getElementById('editPanel').classList.add('hidden');
        document.getElementById('noUserSelected').classList.remove('hidden');
      };
    }

    // ----- LOGIN mejorado -----
    const COUNTRIES = [
      { code:'CR', cc:'506', name:'Costa Rica' },
      { code:'US', cc:'1',   name:'United States' },
      { code:'MX', cc:'52',  name:'México' },
      { code:'AR', cc:'54',  name:'Argentina' },
      { code:'CL', cc:'56',  name:'Chile' },
      { code:'CO', cc:'57',  name:'Colombia' },
      { code:'PE', cc:'51',  name:'Perú' },
      { code:'ES', cc:'34',  name:'España' },
      { code:'GT', cc:'502', name:'Guatemala' },
      { code:'SV', cc:'503', name:'El Salvador' },
      { code:'HN', cc:'504', name:'Honduras' },
      { code:'NI', cc:'505', name:'Nicaragua' },
      { code:'PA', cc:'507', name:'Panamá' },
      { code:'DO', cc:'1',   name:'Rep. Dominicana' },
      { code:'VE', cc:'58',  name:'Venezuela' },
      { code:'BR', cc:'55',  name:'Brasil' },
      { code:'EC', cc:'593', name:'Ecuador' },
      { code:'PY', cc:'595', name:'Paraguay' },
      { code:'UY', cc:'598', name:'Uruguay' },
      { code:'UK', cc:'44',  name:'Reino Unido' },
      { code:'FR', cc:'33',  name:'Francia' },
      { code:'DE', cc:'49',  name:'Alemania' },
      { code:'IT', cc:'39',  name:'Italia' },
      { code:'CA', cc:'1',   name:'Canadá' },
    ];
    let currentCountry = COUNTRIES[0]; // CR por defecto

    function setCountryByCC(cc){ const c = COUNTRIES.find(x=>x.cc===cc) || COUNTRIES[0]; currentCountry = c; document.getElementById('ccCode').textContent = c.code; document.getElementById('ccDial').textContent = '+'+c.cc; localStorage.setItem('cc', c.cc); const inp = document.getElementById('loginInput'); if (inp){ inp.placeholder = (c.cc==='506') ? '6004 8606' : '123 456 789'; inp.value = formatDisplayGeneric(inp.value); } }
    

    function buildCCMenu(){
      const menu = document.getElementById('ccMenu');
      if (!menu) return;
      menu.innerHTML='';
      COUNTRIES.forEach(c=>{
        const item = el('div', { class: 'ccItem', 'data-cc': c.cc }, [ el('span', { text: c.name }), el('span', { text: '+'+c.cc }) ]);
        item.addEventListener('click', ()=>{ setCountryByCC(c.cc); menu.classList.add('hidden'); document.getElementById('ccBtn').setAttribute('aria-expanded','false'); document.getElementById('loginInput').focus(); });
        menu.appendChild(item);
      });
    }

    function formatDisplayGeneric(val){
      const d = digits(val);
      const cc = currentCountry.cc;
      let core = d;
      if (d.startsWith(cc)) core = d.slice(cc.length);
      if (cc==='506'){
        core = core.slice(0,8);
        return (core.length<=4) ? core : (core.slice(0,4)+' '+core.slice(4));
      }
      const plain = d.startsWith(cc) ? d.slice(cc.length) : d;
      return plain.replace(/(\d{3})(?=\d)/g,'$1 ').slice(0,17);
    }

    async function doLogin(){
      const msg = document.getElementById('loginMsg');
      const box = document.getElementById('loginBox');
      const id = buildIdFromInput();
      if (!id){ msg.textContent = 'Ingresa tu teléfono.'; box?.classList.add('shake'); setTimeout(()=> box?.classList.remove('shake'), 450); pulseTitle(); return; }
      const localLen = id.startsWith(currentCountry.cc) ? id.slice(currentCountry.cc.length).length : id.length;
      if (localLen < 6 || id.length > 15){ msg.textContent = 'Teléfono inválido.'; box?.classList.add('shake'); setTimeout(()=> box?.classList.remove('shake'), 450); return; }
      try {
        const ref = db.collection('users').doc(id);
        const snap = await ref.get();
        if (!snap.exists) { msg.textContent = 'No existe este usuario.'; return; }
        localStorage.setItem('member', id);
        showMemberView();
        startMemberListener(id);
      } catch(e){ msg.textContent = 'Error de conexión.'; console.error(e); }
    }

    // UI Login
    (function setupLoginUI(){
      buildCCMenu();
      setCountryByCC(localStorage.getItem('cc') || '506');
      const input = document.getElementById('loginInput');
      if (input) {
        input.addEventListener('input', (e)=>{
          const cur = e.target.selectionStart;
          const f = formatDisplayGeneric(e.target.value);
          e.target.value = f;
          try{ e.target.setSelectionRange(cur, cur);}catch(_){/* noop */}
        });
        input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doLogin(); });
      }
      document.getElementById('loginGo')?.addEventListener('click', doLogin);
      const ccBtn = document.getElementById('ccBtn'); const ccMenu = document.getElementById('ccMenu');
      ccBtn?.addEventListener('click', ()=> { ccMenu?.classList.toggle('hidden'); ccBtn.setAttribute('aria-expanded', ccMenu.classList.contains('hidden') ? 'false' : 'true'); });
      document.addEventListener('click', (e)=>{ if (!e.target.closest('#ccBtn') && !e.target.closest('#ccMenu')) { ccMenu?.classList.add('hidden'); ccBtn?.setAttribute('aria-expanded','false'); } });
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ ccMenu?.classList.add('hidden'); ccBtn?.setAttribute('aria-expanded','false'); } });

      // Admin modal
      const open = document.getElementById('adminOpen'); const modal = document.getElementById('adminModal'); const pwd = document.getElementById('adminPwd');
      const enter = document.getElementById('adminEnter'); const cancel = document.getElementById('adminCancel'); const aMsg = document.getElementById('adminMsg');
      function close(){ modal.classList.add('hidden'); }
      function openModal(){ aMsg.textContent=''; pwd.value=''; modal.classList.remove('hidden'); setTimeout(()=> pwd.focus(), 50); }
      function tryAdmin(){ if (pwd.value.trim() === atob(ADMIN_KEY_B64)) { localStorage.setItem('admin','1'); close(); showAdminView(); } else { aMsg.textContent = 'Contraseña incorrecta'; } }
      open?.addEventListener('click', openModal);
      cancel?.addEventListener('click', close);
      enter?.addEventListener('click', tryAdmin);
      pwd?.addEventListener('keydown', (e)=>{ if (e.key==='Enter') tryAdmin(); if (e.key==='Escape') close(); });
    })();

    // Micro-efecto: glitch del título
    function pulseTitle() {
      const t = document.getElementById('title');
      t.classList.add('glitching');
      setTimeout(()=> t.classList.remove('glitching'), 520);
    }

    // Parallax suave de la tarjeta
    (function tiltCard(){
      const art = document.querySelector('.art');
      if (!art) return;
      const max = 8;
      function onMove(e){
        const r = art.getBoundingClientRect();
        const x = (e.clientX - r.left) / r.width;
        const y = (e.clientY - r.top) / r.height;
        const rx = ((0.5 - y) * max).toFixed(2);
        const ry = ((x - 0.5) * max).toFixed(2);
        art.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
      }
      function reset(){ art.style.transform = ''; }
      art.addEventListener('mousemove', onMove);
      art.addEventListener('mouseleave', reset);
    })();

    document.getElementById('adminLogoutBtn')?.addEventListener('click', () => { localStorage.removeItem('admin'); if (unsubUsers) { unsubUsers(); unsubUsers = null; } if (unsubEdit) { unsubEdit(); unsubEdit = null; } showAuth(); });

    function showAuth(){
      document.getElementById('adminGrid').classList.add('hidden');
      document.getElementById('memberGrid').classList.add('hidden');
      document.getElementById('authGrid').classList.remove('hidden');
      document.getElementById('loginInput')?.focus();
      pulseTitle();
    }
    function showMemberView(){
      document.getElementById('authGrid').classList.add('hidden');
      document.getElementById('memberGrid').classList.remove('hidden');
    }
    function showAdminView(){
      document.getElementById('authGrid').classList.add('hidden');
      document.getElementById('adminGrid').classList.remove('hidden');
      setupCreateUser();
      startUsersListener();
      document.getElementById('search').focus();
    }

    function setupCreateUser(){
      const selected = new Set();
      makeChipToggle(document.getElementById('newUserRewards'), selected, { enforceAssignable: true });
      document.getElementById('addUserBtn').onclick = async () => {
        const name = document.getElementById('newUserName').value.trim();
        const phoneRaw = document.getElementById('newUserPhone').value.trim();
        const phone = digits(phoneRaw);
        const id = phone.startsWith('506') && phone.length===11 ? phone : (phone.length===8 ? '506'+phone : phone);
        if (!name) { toast('Falta nombre'); return; }
        if (!(id && /^506\d{8}$/.test(id))) { toast('Teléfono inválido'); return; }
        const ref = db.collection('users').doc(id); const doc = await ref.get();
        if (doc.exists) { toast('Teléfono ya registrado'); return; }
        await ref.set({ name, phone: id, rewards: sortRewards(Array.from(selected).filter(allow)), comments: [], createdAt: Date.now() });
        toast('Usuario creado');
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserPhone').value = '';
        selected.clear();
        makeChipToggle(document.getElementById('newUserRewards'), selected, { enforceAssignable: true });
      };
    }

    document.getElementById('search').addEventListener('input', debounce(renderUsersList, 180));

    async function ensureDemoUser(){
      const id = '50660048606';
      const ref = db.collection('users').doc(id);
      try {
        const snap = await ref.get();
        if (!snap.exists) {
          await ref.set({ name: 'Demo CR', phone: id, rewards: ['r1'], comments: [{ text: 'Bienvenid@ 👾', ts: Date.now(), author: 'admin' }], createdAt: Date.now() });
          console.log('Demo user creado');
        }
      } catch(e){ console.warn('No se pudo crear demo', e); }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const results = [];
        results.push(['Firebase', typeof firebase !== 'undefined']);
        results.push(['DB', !!db]);
        results.push(['Rewards', REWARDS.length === 5]);
        await db.collection('users').limit(1).get(); results.push(['Lectura Firestore', true]);
        console.log('Smoke:', results.map(([k,v])=>`${k}:${v?'✔':'✖'}`).join(' • '));
      } catch(e){ console.warn('Smoke tests', e); }

      await ensureDemoUser();

      const m = localStorage.getItem('member'); const a = localStorage.getItem('admin');
      if (a === '1') { showAdminView(); return; }
      if (m) { showMemberView(); startMemberListener(m); return; }
      showAuth();
    });
  </script>
</body>
</html>
