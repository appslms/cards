<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#07090f" />
  <title>GAME OVER Â· Rewards CRM</title>
  
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  
  <link rel="preload" as="image" href="assets/background.png"/>
  <link rel="preload" as="image" href="logo.svg"/>
  
  <style>
    :root {
      --ink: #07090f;
      --panel: #0f1424;
      --neon-yellow: #f6f200;
      --neon-cyan: #00e5ff;
      --neon-pink: #ff2bbf;
      --muted: #a7b0c0;
      --text: #f2f6ff;
      --border: rgba(255,255,255,.12);
      --glow: 0 0 0 2px rgba(0,229,255,.25), 0 0 0 6px rgba(0,229,255,.12);
    }
    * { box-sizing: border-box; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    body { margin: 0; color: var(--text); background: var(--ink); }
    img { max-width: 100%; display: block; }

    .bg-tech { position: fixed; inset: 0; z-index: -1; overflow: hidden; background:
      linear-gradient(rgba(7,9,15,.80), rgba(7,9,15,.86)),
      url('assets/background.png') center / cover no-repeat fixed,
      radial-gradient(800px 400px at 80% 0%, rgba(0,229,255,.10), transparent 60%),
      radial-gradient(600px 300px at 15% 100%, rgba(255,43,191,.10), transparent 60%),
      var(--ink);
      filter: saturate(.9) brightness(.9);
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: clamp(16px, 4vw, 24px); }
    
    .landing {
      min-height: calc(100vh - 32px);
      display: grid;
      place-items: center;
    }
    .landing > * { grid-area: 1 / 1; }

    .art {
      perspective: 1000px;
      transform-style: preserve-3d;
      width: 100%;
      max-width: 760px;
      height: clamp(520px, 80vh, 700px);
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      z-index: 1;
      transition: transform 0.1s ease-out;
    }
    .art::before { content:""; position:absolute; inset:0; background: radial-gradient(80% 40% at 20% 10%, rgba(0,229,255,.14), transparent 60%), radial-gradient(60% 40% at 70% 80%, rgba(255,43,191,.16), transparent 60%), url('assets/background.png') center / cover no-repeat; filter: brightness(.7) contrast(1); z-index: 0; pointer-events:none; }
    .art::after { content:""; position:absolute; inset:0; background: repeating-linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.05) 1px, transparent 1px, transparent 60px), repeating-linear-gradient(0deg, rgba(0,0,0,.12), rgba(0,0,0,.12) 1px, transparent 1px, transparent 60px); opacity:.25; mix-blend-mode: soft-light; z-index: 1; pointer-events:none; }
    .shine { position: absolute; inset: -20%; background: radial-gradient(40% 12% at var(--gx,30%) var(--gy,10%), rgba(255,255,255,.10), transparent 60%), linear-gradient(115deg, transparent 40%, rgba(255,255,255,.06) 50%, transparent 60%); mix-blend-mode: screen; pointer-events: none; z-index: 2; opacity:.9; transition: opacity .2s ease; }

    .floating-content {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      max-width: 760px;
      max-height: clamp(520px, 80vh, 700px);
      pointer-events: none;
    }
    .floating-content > * { pointer-events: auto; }
    
    .floating-logo {
      position: absolute;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: clamp(280px, 50vw, 420px);
      height: auto;
      z-index: 11;
      transition: transform 0.1s ease-out;
    }
    
    .loginFloat {
      position: absolute;
      bottom: 15%;
      left: 50%;
      transform: translateX(-50%);
      display: grid;
      gap: 12px;
      width: 90%;
      max-width: 480px;
      background: rgba(11,17,32,.85);
      backdrop-filter: blur(12px) saturate(1.1);
      -webkit-backdrop-filter: blur(12px) saturate(1.1);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 32px rgba(0,0,0,.5), var(--glow);
      z-index: 10;
    }
    
    .loginTitle { font-size: 14px; letter-spacing: 1.5px; text-transform: uppercase; opacity:.9; margin-bottom: 10px; }
    .phoneInput { position: relative; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px; border: 1px solid var(--border); border-radius: 16px; padding: 12px 12px 12px 14px; background: #0b1120cc; box-shadow: var(--glow); }
    .ccBtn { display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background: linear-gradient(180deg, rgba(0,229,255,.16), rgba(0,229,255,.06)); color: var(--text); font-weight:800; cursor:pointer; }
    .ccMenu { position:absolute; top: calc(100% + 8px); left: 0; width: 280px; max-height: 260px; overflow:auto; background:#0b1120; border:1px solid var(--border); border-radius:12px; box-shadow: 0 16px 40px rgba(0,0,0,.55); z-index: 15; }
    .ccItem { padding:8px 10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
    .ccItem:hover { background: rgba(0,229,255,.10); }
    #loginInput {
      width: 100%;
      border: 0;
      outline: 0;
      background: transparent;
      color: var(--text);
      font-size: clamp(16px, 4vw, 20px);
      letter-spacing: .6px;
    }
    #loginInput::placeholder { color: #93a0b3; opacity:.9; }
    .goBtn { border: 1px solid var(--border); border-radius: 12px; padding: 10px 14px; cursor: pointer; font-weight: 800; background: linear-gradient(180deg, rgba(0,229,255,.22), rgba(0,229,255,.08)); color: var(--text); }
    .loginMeta { display:flex; gap:12px; align-items:center; color: var(--muted); font-size: 13px; min-height: 18px; }
    
    .hidden { display: none !important; }
    .toast { position: fixed; right: 16px; top: 16px; display: grid; gap: 8px; z-index: 999; }
    .toast-item { background: #0b1120; border: 1px solid rgba(255,255,255,.14); padding: 10px 12px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,.35); animation: card-in .3s ease; }
    @keyframes card-in { to { opacity:1; transform: none; } }

    @keyframes gentle-float {
      0% { transform: rotateX(4deg) rotateY(-5deg); }
      25% { transform: rotateX(-3deg) rotateY(4deg); }
      50% { transform: rotateX(3deg) rotateY(2deg); }
      75% { transform: rotateX(-4deg) rotateY(-3deg); }
      100% { transform: rotateX(4deg) rotateY(-5deg); }
    }
    
    @media (hover: hover) and (pointer: fine) {
      .art {
        animation: gentle-float 25s ease-in-out infinite alternate;
      }
    }

    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .card { border: 1px solid var(--border); border-radius: 18px; padding: 16px; background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); box-shadow: 0 20px 48px rgba(0,0,0,.45); }
    .card h2 { margin: 0 0 8px 0; font-size: 18px; letter-spacing: .5px; }
    .btn { display: inline-flex; gap: 8px; align-items: center; padding: 10px 14px; color: var(--text); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; text-decoration: none; }
    .btn:hover { filter: brightness(1.08); box-shadow: var(--glow); }
    .btn:active { transform: translateY(1px); }
    .btn.brand { background: linear-gradient(180deg, rgba(0,229,255,.22), rgba(0,229,255,.10)); border-color: rgba(0,229,255,.6); }
    .btn.accent { background: linear-gradient(180deg, rgba(255,43,191,.22), rgba(255,43,191,.10)); border-color: rgba(255,43,191,.6); }
    .btn.danger { background: linear-gradient(180deg, rgba(255,79,79,.2), rgba(255,79,79,.1)); border-color: rgba(255,79,79,.55); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .field { position: relative; margin: 8px 0; }
    .field .icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: .85; font-size: 14px; pointer-events: none; }
    .neo { width: 100%; padding: 12px 12px 12px 36px; border-radius: 14px; border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); color: var(--text); outline: none; }
    .neo:focus { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border); background: #0d1222; font-size: 13px; cursor: pointer; }
    .chip.is-selected { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }
    .chip.lock { cursor: not-allowed; opacity: .6; }
    .gallery { display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:12px; }
    .gallery .cardart { border-radius: 16px; overflow:hidden; border:1px solid var(--border); background:#0d1222; opacity:0; transform: translateY(6px) scale(.995); animation: card-in .5s ease forwards; }
    .gallery .cardart img { width:100%; display:block; aspect-ratio: 2/3; object-fit: cover; }
    .gallery .label { padding:6px 8px; font-size:12px; color:#0b0b0b; background: linear-gradient(90deg, var(--neon-yellow), var(--neon-cyan)); font-weight: 700; }
    .list { display: grid; gap: 8px; margin-top: 8px; max-height: 340px; overflow: auto; }
    .item { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.03); }
    .item small { color: var(--muted); cursor: copy; }
    .item small.copyable:hover { color: var(--neon-cyan); }
    .sep { height: 1px; background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.22), rgba(255,255,255,.0)); margin: 12px 0; }
    .adminLink { position: fixed; right: 14px; bottom: 10px; z-index: 60; opacity: .6; font-size: 12px; }
    .adminLink button { background: none; border: 0; color: #9feaff; text-decoration: underline; cursor: pointer; padding: 0; }
    .modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(7,9,15,.6); backdrop-filter: blur(2px); z-index: 80; }
    .modal .box { width: 320px; border-radius: 16px; border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); padding: 16px; }

    @media (max-width: 1180px){ .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }
    
    @media (max-width: 500px) {
      .art {
        display: flex;
        align-items: center;
        justify-content: center;
        height: auto;
        min-height: 90vh;
      }
      .floating-content {
        position: static;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 400px;
        height: auto;
        padding: 2rem 1rem;
        pointer-events: auto;
      }
      .floating-logo {
        position: static;
        transform: none;
        width: clamp(240px, 70vw, 320px);
        margin-bottom: 24px; /* CORRECCIÃN: Margen positivo para separar */
      }
      .loginFloat {
        position: static;
        transform: none;
        width: 100%;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="bg-tech" aria-hidden="true"></div>

  <div class="wrap">
    <main>
      <section class="landing" id="authGrid">
        <div class="art" aria-hidden="true">
          <span class="shine"></span>
        </div>
        
        <div class="floating-content">
          <img src="logo.svg" alt="Game Over Logo" class="floating-logo" />
          <div class="loginFloat" role="form" aria-labelledby="loginFormTitle">
            <div class="loginTitle" id="loginFormTitle"> </div>
            <div class="phoneInput" id="loginBox">
              <button class="ccBtn" id="ccBtn" type="button" aria-haspopup="listbox" aria-expanded="false"><span id="ccCode">CR</span>&nbsp;<span id="ccDial">+506</span>&nbsp;â¾</button>
              <input id="loginInput" type="tel" inputmode="numeric" placeholder="6666 8888" autocomplete="one-time-code" aria-label="TelÃ©fono" />
              <button id="loginGo" class="goBtn" aria-label="Entrar">ENTER</button>
              <div id="ccMenu" class="ccMenu hidden" role="listbox" aria-label="Seleccionar paÃ­s"></div>
            </div>
            <div class="loginMeta" id="loginMsg" aria-live="polite"></div>
          </div>
        </div>
      </section>

      <div class="adminLink"><button id="adminOpen" type="button">[admin]</button></div>
      <div id="adminModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="adminModalTitle">
        <div class="box">
          <div class="loginTitle" id="adminModalTitle">Admin</div>
          <input id="adminPwd" type="password" class="neo" placeholder="ContraseÃ±a" aria-label="ContraseÃ±a de administrador" />
          <div class="row" style="margin-top:10px;">
            <button class="btn brand" id="adminEnter">Entrar</button>
            <button class="btn" id="adminCancel">Cancelar</button>
          </div>
          <div class="loginMeta" id="adminMsg"></div>
        </div>
      </div>
      <div id="views-container" class="hidden">
        <section class="grid" id="memberGrid">
          <div class="card">
            <h2>Tus tarjetas</h2>
            <div id="memberCards" class="gallery"></div>
            <div class="sep"></div>
            <h2>Comentarios</h2>
            <div id="memberComments" class="list"></div>
            <div class="sep"></div>
            <button class="btn" id="memberLogoutBtn">Salir</button>
          </div>
        </section>
        <section class="grid" id="adminGrid">
          <div class="card">
            <h2>Alta rÃ¡pida</h2>
            <label for="newUserName">Nombre</label>
            <div class="field"><span class="icon">ð¤</span><input class="neo" id="newUserName" type="text" placeholder="Nuevo miembro" /></div>
            <label for="newUserPhone">TelÃ©fono</label>
            <div class="field"><span class="icon">ð±</span><input class="neo" id="newUserPhone" type="text" placeholder="Ej: +506 6004 8606" /></div>
            <label>Tarjetas</label>
            <div id="newUserRewards" class="chips"></div>
            <button class="btn accent" id="addUserBtn" style="margin-top:12px">Crear usuario</button>
          </div>
          <div class="card">
            <h2>GestiÃ³n</h2>
            <label for="search">Buscar</label>
            <div class="field"><span class="icon">ð</span><input class="neo" id="search" type="text" placeholder="Nombre o telÃ©fono" /></div>
            <div class="list" id="usersList"></div>
          </div>
          <div class="card">
            <h2>Editar</h2>
            <div id="editPanel" class="hidden">
              <div class="muted" id="editUserTitle"></div>
              <label>Tarjetas</label>
              <div id="editRewards" class="chips"></div>
              <label for="editComment">Comentario</label>
              <div class="field"><span class="icon">ð¬</span><textarea class="neo" id="editComment" placeholder="Mensaje breve"></textarea></div>
              <div class="row" style="margin-top:12px;">
                <button class="btn brand" id="saveRewardsBtn">Guardar</button>
                <button class="btn" id="addCommentBtn">Agregar comentario</button>
              </div>
              <div class="row" style="margin-top:8px;">
                <button class="btn danger" id="deleteUserBtn">Eliminar usuario</button>
                <button class="btn" id="clearPanelBtn">Limpiar panel</button>
              </div>
            </div>
            <div id="noUserSelected" class="muted">Selecciona un usuario para editar.</div>
          </div>
          <div class="card">
            <h2>SesiÃ³n</h2>
            <button class="btn" id="adminLogoutBtn">Cerrar sesiÃ³n</button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { 
        getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, 
        query, orderBy, arrayUnion, deleteDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBlevLcY3TKVYQpr4Hur1f7XeZoHLbXCC0",
      authDomain: "gameover-b6eb7.firebaseapp.com",
      projectId: "gameover-b6eb7",
      storageBucket: "gameover-b6eb7.appspot.com",
      messagingSenderId: "522023719283",
      appId: "1:522023719283:web:3e5ce88c28a52b56a27506"
    };

    const REWARDS = [
      { id: "r1", label: "Joker",    img: "assets/card1.png", assignable: true },
      { id: "r2", label: "Predator", img: "assets/card2.png", assignable: true },
      { id: "r3", label: "Alien",    img: "assets/card3.png", assignable: true },
      { id: "r4", label: "Jason",    img: "assets/card4.png", assignable: true },
      { id: "r5", label: "Final Boss. Chucky", img: "assets/card5.png", assignable: false }
    ];
    
    const REWARD_ORDER = Object.fromEntries(REWARDS.map((r, i) => [r.id, i]));
    const ADMIN_KEY_B64 = 'RmluYWxCb3Nz';

    const COUNTRIES = [
      { code:'CR', cc:'506', name:'Costa Rica', placeholder: '6004 8606' },
      { code:'US', cc:'1', name:'United States', placeholder: '202 555 0125' },
      { code:'MX', cc:'52', name:'MÃ©xico', placeholder: '55 1234 5678' },
      { code:'ES', cc:'34', name:'EspaÃ±a', placeholder: '612 345 678' },
      { code:'CO', cc:'57', name:'Colombia', placeholder: '300 1234567' },
      { code:'AR', cc:'54',  name:'Argentina' }, { code:'CL', cc:'56',  name:'Chile' },
      { code:'PE', cc:'51',  name:'PerÃº' }, { code:'GT', cc:'502', name:'Guatemala' },
      { code:'SV', cc:'503', name:'El Salvador' }, { code:'HN', cc:'504', name:'Honduras' },
      { code:'NI', cc:'505', name:'Nicaragua' }, { code:'PA', cc:'507', name:'PanamÃ¡' },
    ];

    let db;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (e) {
      console.error("Error al inicializar Firebase.", e);
      document.body.innerHTML = '<h1>Error de conexiÃ³n con la base de datos.</h1>';
    }
    
    const UI = {
        authGrid: document.getElementById('authGrid'),
        viewsContainer: document.getElementById('views-container'),
        loginBox: document.getElementById('loginBox'), loginInput: document.getElementById('loginInput'),
        loginGo: document.getElementById('loginGo'), loginMsg: document.getElementById('loginMsg'),
        ccBtn: document.getElementById('ccBtn'), ccCode: document.getElementById('ccCode'),
        ccDial: document.getElementById('ccDial'), ccMenu: document.getElementById('ccMenu'),
        adminOpen: document.getElementById('adminOpen'), adminModal: document.getElementById('adminModal'),
        adminPwd: document.getElementById('adminPwd'), adminEnter: document.getElementById('adminEnter'),
        adminCancel: document.getElementById('adminCancel'), adminMsg: document.getElementById('adminMsg'),
        memberGrid: document.getElementById('memberGrid'), memberCards: document.getElementById('memberCards'),
        memberComments: document.getElementById('memberComments'), memberLogoutBtn: document.getElementById('memberLogoutBtn'),
        adminGrid: document.getElementById('adminGrid'), newUserName: document.getElementById('newUserName'),
        newUserPhone: document.getElementById('newUserPhone'), newUserRewards: document.getElementById('newUserRewards'),
        addUserBtn: document.getElementById('addUserBtn'), search: document.getElementById('search'),
        usersList: document.getElementById('usersList'), editPanel: document.getElementById('editPanel'),
        editUserTitle: document.getElementById('editUserTitle'), editRewards: document.getElementById('editRewards'),
        editComment: document.getElementById('editComment'), saveRewardsBtn: document.getElementById('saveRewardsBtn'),
        addCommentBtn: document.getElementById('addCommentBtn'), deleteUserBtn: document.getElementById('deleteUserBtn'),
        clearPanelBtn: document.getElementById('clearPanelBtn'), noUserSelected: document.getElementById('noUserSelected'),
        adminLogoutBtn: document.getElementById('adminLogoutBtn'), toast: document.getElementById('toast'),
        art: document.querySelector('.art'), shine: document.querySelector('.shine'),
        floatingLogo: document.querySelector('.floating-logo'),
    };

    let unsubMember = null, unsubUsers = null, unsubEdit = null;
    let cacheUsers = [];
    let currentCountry = COUNTRIES[0];
    
    const el = (tag, attrs = {}, children = []) => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if (k === 'class') n.className = v;
        else if (k === 'text') n.textContent = v;
        else if (k === 'dataset') Object.assign(n.dataset, v);
        else n.setAttribute(k, v);
      });
      children.forEach(c => n.append(c));
      return n;
    };
    const getDigits = s => (s || '').replace(/\D+/g, '');
    const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn.apply(null,a), ms); }; };
    const sortRewards = (ids) => (ids || []).slice().sort((a,b) => (REWARD_ORDER[a] ?? 99) - (REWARD_ORDER[b] ?? 99));
    const isAssignable = rid => REWARDS.find(r => r.id === rid)?.assignable !== false;
    
    function toast(msg) {
      const item = el('div', { class: 'toast-item', text: msg });
      UI.toast.appendChild(item);
      setTimeout(() => { item.style.transition = 'opacity .4s ease'; item.style.opacity = '0'; }, 2000);
      setTimeout(() => item.remove(), 2600);
    }
    
    function switchView(viewName) {
        UI.authGrid.classList.add('hidden');
        UI.viewsContainer.classList.add('hidden');
        
        if (unsubMember) { unsubMember(); unsubMember = null; }
        if (unsubUsers) { unsubUsers(); unsubUsers = null; }
        if (unsubEdit) { unsubEdit(); unsubEdit = null; }

        switch (viewName) {
            case 'auth':
                UI.authGrid.classList.remove('hidden');
                UI.loginInput.focus();
                localStorage.removeItem('memberId');
                localStorage.removeItem('admin');
                break;
            case 'member':
                UI.viewsContainer.classList.remove('hidden');
                UI.memberGrid.classList.remove('hidden');
                UI.adminGrid.classList.add('hidden');
                startMemberListener(localStorage.getItem('memberId'));
                break;
            case 'admin':
                UI.viewsContainer.classList.remove('hidden');
                UI.adminGrid.classList.remove('hidden');
                UI.memberGrid.classList.add('hidden');
                setupCreateUserPanel();
                startUsersListener();
                UI.search.focus();
                break;
        }
    }
    
    function renderRewardChips(container, selected, onToggle, { enforceAssignable = true } = {}) {
      container.innerHTML = '';
      REWARDS.forEach(r => {
        const disabled = enforceAssignable && !r.assignable;
        const chip = el('button', { class: 'chip' + (disabled ? ' lock' : ''), type: 'button' }, [r.label]);
        if (selected.has(r.id)) chip.classList.add('is-selected');
        if (!disabled) chip.addEventListener('click', () => onToggle(r.id));
        container.appendChild(chip);
      });
    }

    function makeChipToggle(container, selected, opts){
      const toggle = (rid) => {
        if (selected.has(rid)) selected.delete(rid); else selected.add(rid);
        renderRewardChips(container, selected, toggle, opts);
      };
      renderRewardChips(container, selected, toggle, opts);
      return toggle;
    }

    function renderMemberPanels(member) {
      const rewards = sortRewards(member.rewards || []);
      const comments = member.comments || [];
      UI.memberCards.innerHTML = '';
      if (rewards.length === 0) UI.memberCards.appendChild(el('div', { class: 'muted', text: 'Sin tarjetas por ahora.' }));
      rewards.forEach(rid => {
        const r = REWARDS.find(x => x.id === rid);
        const img = el('img', { src: r?.img || '', alt: r?.label || rid, loading: 'lazy', decoding: 'async' });
        const wrap = el('div', { class: 'cardart' }, [img, el('div', { class: 'label', text: r?.label || rid })]);
        UI.memberCards.appendChild(wrap);
      });
      UI.memberComments.innerHTML = '';
      if (comments.length === 0) UI.memberComments.appendChild(el('div', { class: 'muted', text: 'Sin comentarios.' }));
      comments.slice().reverse().forEach(c => {
        const item = el('div', { class: 'item' }, [
          el('div', {}, [ el('div', { text: c.text || '' }), el('small', {}, [new Date(c.ts || Date.now()).toLocaleString()]) ]),
          el('div', { class: 'chip is-selected' }, [c.author || 'admin'])
        ]);
        UI.memberComments.appendChild(item);
      });
    }

    function renderUsersList() {
      UI.usersList.innerHTML = '';
      const q = UI.search.value.toLowerCase().trim();
      cacheUsers
        .filter(u => !q || (u.name || '').toLowerCase().includes(q) || (u.phone || '').includes(getDigits(q)))
        .forEach(u => {
          const phoneTxt = u.phone ? `ð± ${u.phone}` : u.id;
          const copyElem = el('small', { class: 'copyable', dataset: { phone: (u.phone || '') }, role: 'button', tabindex: '0' }, [ `${phoneTxt} â¢ ${u.rewards?.length || 0} tarjetas` ]);
          const row = el('div', { class: 'item' }, [
            el('div', {}, [ el('div', { text: u.name || u.id }), copyElem ]),
            el('div', {}, [ el('button', { class: 'btn', type: 'button' }, ['Editar']) ])
          ]);
          row.querySelector('button').addEventListener('click', () => selectUser(u.id, u.name || u.id));
          const copyAction = async () => {
              const p = copyElem.dataset.phone || '';
              if (!p || !navigator.clipboard) return;
              try { await navigator.clipboard.writeText(p); toast('TelÃ©fono copiado'); } catch(_) { toast('Error al copiar'); }
          };
          copyElem.addEventListener('click', copyAction);
          copyElem.addEventListener('keydown', (e) => { if(e.key === 'Enter') copyAction(); });
          UI.usersList.appendChild(row);
        });
    }

    function startMemberListener(memberId) {
      if (!memberId || !db) return;
      unsubMember = onSnapshot(doc(db, 'users', memberId), (doc) => {
        if (!doc.exists()) { UI.loginMsg.textContent = 'Este usuario ya no existe.'; switchView('auth'); return; }
        renderMemberPanels({ id: doc.id, ...doc.data() });
      }, err => { console.error('member onSnapshot', err); toast('Error de conexiÃ³n.'); });
    }

    function startUsersListener() {
      if (!db) return;
      const usersQuery = query(collection(db, 'users'), orderBy('name'));
      unsubUsers = onSnapshot(usersQuery, (snap) => {
        cacheUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderUsersList();
      }, err => { console.error('users onSnapshot', err); toast('Error al cargar usuarios.'); });
    }

    async function selectUser(id, name) {
      if (unsubEdit) unsubEdit();
      UI.noUserSelected.classList.add('hidden');
      UI.editPanel.classList.remove('hidden');
      UI.editUserTitle.textContent = `${name} (${id})`;
      let selectedRewards = new Set();
      makeChipToggle(UI.editRewards, selectedRewards, { enforceAssignable: true });
      const userRef = doc(db, 'users', id);
      unsubEdit = onSnapshot(userRef, (doc) => {
        if (!doc.exists()) { toast('Usuario eliminado remotamente.'); clearEditPanel(); return; }
        const data = doc.data();
        selectedRewards = new Set(sortRewards((data.rewards || []).filter(isAssignable)));
        makeChipToggle(UI.editRewards, selectedRewards, { enforceAssignable: true });
      });
      UI.saveRewardsBtn.onclick = async () => {
        try { await updateDoc(userRef, { rewards: sortRewards(Array.from(selectedRewards).filter(isAssignable)) }); toast('Tarjetas guardadas'); } catch(e) { console.error(e); toast('Error al guardar'); }
      };
      UI.addCommentBtn.onclick = async () => {
        const text = UI.editComment.value.trim();
        if (!text) { toast('Escribe un comentario'); return; }
        try { await updateDoc(userRef, { comments: arrayUnion({ text, ts: Date.now(), author: 'admin' }) }); UI.editComment.value = ''; toast('Comentario agregado'); } catch(e) { console.error(e); toast('Error al comentar'); }
      };
      UI.deleteUserBtn.onclick = async () => {
        if (!confirm(`Â¿EstÃ¡s seguro de que quieres eliminar a ${name}? Esta acciÃ³n no se puede deshacer.`)) return;
        if (unsubEdit) unsubEdit();
        try { await deleteDoc(userRef); toast('Usuario eliminado'); clearEditPanel(); } catch(e) { console.error(e); toast('Error al eliminar'); }
      };
    }

    function clearEditPanel() {
        if (unsubEdit) { unsubEdit(); unsubEdit = null; }
        UI.editPanel.classList.add('hidden'); UI.noUserSelected.classList.remove('hidden');
        UI.editUserTitle.textContent = ''; UI.editComment.value = '';
        makeChipToggle(UI.editRewards, new Set(), { enforceAssignable: true });
    }
    
    function setupCreateUserPanel() {
        let selected = new Set();
        makeChipToggle(UI.newUserRewards, selected, { enforceAssignable: true });
        UI.addUserBtn.onclick = async () => {
            const name = UI.newUserName.value.trim();
            const phone = getDigits(UI.newUserPhone.value);
            if (!name) { toast('Falta el nombre'); return; }
            if (phone.length < 8) { toast('TelÃ©fono invÃ¡lido'); return; }
            const userRef = doc(db, 'users', phone);
            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) { toast('Ese telÃ©fono ya estÃ¡ registrado'); return; }
                await setDoc(userRef, { name, phone, rewards: sortRewards(Array.from(selected).filter(isAssignable)), comments: [], createdAt: Date.now() });
                toast('Usuario creado con Ã©xito');
                UI.newUserName.value = ''; UI.newUserPhone.value = ''; selected.clear();
                makeChipToggle(UI.newUserRewards, selected, { enforceAssignable: true });
            } catch (e) { console.error("Error creando usuario:", e); toast('Error al crear usuario'); }
        };
    }
    
    function buildIdFromInput() {
      const inputDigits = getDigits(UI.loginInput.value);
      if (!inputDigits) return '';
      if (inputDigits.startsWith(currentCountry.cc)) return inputDigits;
      return currentCountry.cc + inputDigits;
    }
    
    function setCountry(country) {
      currentCountry = country;
      UI.ccCode.textContent = country.code;
      UI.ccDial.textContent = `+${country.cc}`;
      UI.loginInput.placeholder = country.placeholder || '123 456 789';
      localStorage.setItem('lastCountryCode', country.code);
    }
    
    function buildCCMenu() {
      UI.ccMenu.innerHTML = '';
      COUNTRIES.forEach(c => {
        const item = el('div', { class: 'ccItem', dataset: { code: c.code } }, [ el('span', { text: c.name }), el('span', { text: `+${c.cc}` }) ]);
        item.addEventListener('click', () => {
          setCountry(c);
          UI.ccMenu.classList.add('hidden');
          UI.ccBtn.setAttribute('aria-expanded', 'false');
          UI.loginInput.focus();
        });
        UI.ccMenu.appendChild(item);
      });
    }

    async function doLogin() {
      const id = buildIdFromInput();
      if (!id) {
        UI.loginMsg.textContent = 'Ingresa tu telÃ©fono.';
        return;
      }
      UI.loginMsg.textContent = 'Verificando...';
      try {
        const userRef = doc(db, 'users', id);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          localStorage.setItem('memberId', id);
          switchView('member');
        } else {
          UI.loginMsg.textContent = 'No se encontrÃ³ un usuario con ese telÃ©fono.';
        }
      } catch (e) { console.error("Error en login:", e); UI.loginMsg.textContent = 'Error de conexiÃ³n.'; }
    }
    
    function initGyroscope() {
      if (!('ontouchstart' in window) || !window.DeviceOrientationEvent) {
        return;
      }

      const handleOrientation = (event) => {
        const { beta, gamma } = event; 
        const tiltY = (gamma || 0) / 3.0;
        const tiltX = ((beta || 0) - 45) / -3.0;

        const maxTilt = 8;
        const finalTiltX = Math.max(-maxTilt, Math.min(maxTilt, tiltX));
        const finalTiltY = Math.max(-maxTilt, Math.min(maxTilt, tiltY));

        requestAnimationFrame(() => {
          UI.art.style.transform = `rotateX(${finalTiltX}deg) rotateY(${finalTiltY}deg)`;
          UI.floatingLogo.style.transform = `translateX(-50%) rotateX(${-finalTiltX / 2}deg) rotateY(${-finalTiltY / 2}deg) translateZ(20px)`;
        });
      };

      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        const requestPermission = () => {
          DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
              if (permissionState === 'granted') {
                window.addEventListener('deviceorientation', handleOrientation);
              }
            })
            .catch(console.error);
        };
        document.body.addEventListener('touchstart', requestPermission, { once: true });
      } else {
        window.addEventListener('deviceorientation', handleOrientation);
      }
    }
    
    function init() {
        UI.loginGo.addEventListener('click', doLogin);
        UI.loginInput.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
        UI.ccBtn.addEventListener('click', () => {
          const isHidden = UI.ccMenu.classList.toggle('hidden');
          UI.ccBtn.setAttribute('aria-expanded', String(!isHidden));
        });
        document.addEventListener('click', e => {
          if (!e.target.closest('#ccBtn') && !e.target.closest('#ccMenu')) {
            UI.ccMenu.classList.add('hidden');
            UI.ccBtn.setAttribute('aria-expanded', 'false');
          }
        });
        const closeModal = () => UI.adminModal.classList.add('hidden');
        const openModal = () => { UI.adminMsg.textContent=''; UI.adminPwd.value=''; UI.adminModal.classList.remove('hidden'); setTimeout(()=> UI.adminPwd.focus(), 50); };
        const tryAdmin = () => { if (UI.adminPwd.value.trim() === atob(ADMIN_KEY_B64)) { localStorage.setItem('admin','1'); closeModal(); switchView('admin'); } else { UI.adminMsg.textContent = 'ContraseÃ±a incorrecta'; } };
        UI.adminOpen.addEventListener('click', openModal);
        UI.adminCancel.addEventListener('click', closeModal);
        UI.adminEnter.addEventListener('click', tryAdmin);
        UI.adminPwd.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryAdmin(); if (e.key === 'Escape') closeModal(); });
        UI.memberLogoutBtn.addEventListener('click', () => switchView('auth'));
        UI.adminLogoutBtn.addEventListener('click', () => switchView('auth'));
        UI.search.addEventListener('input', debounce(renderUsersList, 200));
        UI.clearPanelBtn.addEventListener('click', clearEditPanel);
        
        initGyroscope();

        buildCCMenu();
        const lastCountry = COUNTRIES.find(c => c.code === localStorage.getItem('lastCountryCode')) || COUNTRIES[0];
        setCountry(lastCountry);
        const memberId = localStorage.getItem('memberId');
        const isAdmin = localStorage.getItem('admin') === '1';
        if (isAdmin) { switchView('admin'); } else if (memberId) { switchView('member'); } else { switchView('auth'); }
    }
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>