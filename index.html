<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#b42121" />
  <title>GAME OVER ¬∑ Rewards CRM</title>
  
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  
  <link rel="preload" as="image" href="assets/background.png"/>
  <link rel="preload" as="image" href="logo.svg"/>
  
  <style>
    :root {
      --ink: #07090f;
      --panel: #0f1424;
      --neon-yellow: #f6f200;
      --neon-cyan: #00e5ff;
      --neon-pink: #ff2bbf;
      --danger-glow: #ff2b2b;
      --muted: #a7b0c0;
      --muted-bright: #b8c1d1;
      --text: #f2f6ff;
      --border: rgba(255,255,255,.12);
      --glow: 0 0 0 2px rgba(0,229,255,.25), 0 0 0 6px rgba(0,229,255,.12);
    }
    * { box-sizing: border-box; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    body { margin: 0; color: var(--text); background: var(--ink); transition: background .4s ease; }
    img { max-width: 100%; display: block; }

    .bg-tech { position: fixed; inset: 0; z-index: -1; overflow: hidden; background:
      linear-gradient(rgba(7,9,15,.80), rgba(7,9,15,.86)),
      url('assets/background.png') center / cover no-repeat fixed;
      filter: saturate(.9) brightness(.9); transition: all .4s ease;
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: clamp(16px, 4vw, 24px); }
    
    .landing { min-height: calc(100vh - 32px); display: grid; place-items: center; position: relative; }
    .landing > * { grid-area: 1 / 1; }

    .art { position: relative; perspective: 1000px; transform-style: preserve-3d; width: 100%; max-width: 760px; height: clamp(520px, 80vh, 700px); border-radius: 22px; overflow: hidden; border: 1px solid var(--border); background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015)); z-index: 1; transition: transform 0.1s ease-out; }
    .art > .background-layer { position:absolute; inset:0; background: radial-gradient(80% 40% at 20% 10%, rgba(0,229,255,.14), transparent 60%), radial-gradient(60% 40% at 70% 80%, rgba(255,43,191,.16), transparent 60%), url('assets/background.png') center / cover no-repeat; filter: brightness(.7) contrast(1); z-index: 0; pointer-events:none; }
    
    /* -- INICIO: ESTILOS PARA LAS L√çNEAS DE ESCANEO -- */
    .art::after {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(to bottom, transparent 0, rgba(0,0,0,0.2) 1px, transparent 2px);
      background-size: 100% 3px;
      animation: scan-lines 30s linear infinite;
      opacity: 0.5;
      pointer-events: none;
      z-index: 3;
    }
    @keyframes scan-lines {
        from { background-position: 0 0; }
        to { background-position: 0 -60px; }
    }
    /* -- FIN: ESTILOS PARA LAS L√çNEAS DE ESCANEO -- */
    
    .shine { position: absolute; inset: -20%; background: radial-gradient(40% 12% at var(--gx,30%) var(--gy,10%), rgba(255,255,255,.10), transparent 60%), linear-gradient(115deg, transparent 40%, rgba(255,255,255,.06) 50%, transparent 60%); mix-blend-mode: screen; pointer-events: none; z-index: 2; opacity:.9; transition: opacity .2s ease; }
    .floating-content { position: relative; z-index: 10; width: 100%; height: 100%; max-width: 760px; max-height: clamp(520px, 80vh, 700px); pointer-events: none; }
    .floating-content > * { pointer-events: auto; }
    .logo-wrap { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); width: clamp(280px, 50vw, 420px); height: auto; z-index: 11; transition: transform 0.1s ease-out; }
    .logo-wrap img { animation: glitch-main 5s infinite; }
    
    /* -- INICIO: ESTILOS PARA EL EFECTO GLITCH EN EL LOGO -- */
    .logo-wrap::before, .logo-wrap::after {
      content: '';
      position: absolute;
      inset: 0;
      background: url('logo.svg') center / contain no-repeat;
      opacity: 0;
      mix-blend-mode: screen;
    }
    .logo-wrap::before {
      background-color: var(--neon-cyan);
      animation: logo-glitch-rgb1 5s infinite;
    }
    .logo-wrap::after {
      background-color: var(--neon-pink);
      animation: logo-glitch-rgb2 5s infinite;
    }
    @keyframes glitch-main {
      0%, 95%, 100% { transform: translate(0,0); }
      96% { transform: translate(-2px, 2px); }
      98% { transform: translate(2px, -2px); }
    }
    @keyframes logo-glitch-rgb1 {
      0%, 94%, 100% { opacity: 0; }
      95% { opacity: 0.8; transform: translate(-10px, -5px) skewX(-20deg) scale(1.05); clip-path: inset(30% 0 50% 0); }
      96% { opacity: 0.5; transform: translate(10px, 2px) skewX(0deg) scale(1); clip-path: inset(80% 0 10% 0); }
      97% { opacity: 0.7; transform: translate(0, 5px) skewX(10deg) scale(0.98); clip-path: inset(10% 0 80% 0); }
    }
    @keyframes logo-glitch-rgb2 {
      0%, 94%, 100% { opacity: 0; }
      95.5% { opacity: 0.7; transform: translate(8px, 3px) skewX(25deg) scale(0.95); clip-path: inset(60% 0 20% 0); }
      96.5% { opacity: 0.4; transform: translate(-8px, -1px) skewX(0deg) scale(1); clip-path: inset(25% 0 65% 0); }
      97.5% { opacity: 0.6; transform: translate(0, -6px) skewX(-15deg) scale(1.02); clip-path: inset(90% 0 5% 0); }
    }
    /* -- FIN: ESTILOS PARA EL EFECTO GLITCH EN EL LOGO -- */

    .loginFloat { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); display: grid; gap: 12px; width: 90%; max-width: 480px; background: rgba(11,17,32,.85); backdrop-filter: blur(12px) saturate(1.1); -webkit-backdrop-filter: blur(12px) saturate(1.1); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 12px 32px rgba(0,0,0,.5); z-index: 10; }
    .loginTitle { font-size: 14px; letter-spacing: 1.5px; text-transform: uppercase; opacity:.9; margin-bottom: 10px; }
    .phoneInput { position: relative; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 8px; border: 1px solid var(--border); border-radius: 16px; padding: 12px 14px; background: #0b1120cc; }
    .phone-prefix { color: var(--muted); font-size: 16px; pointer-events: none; }
    #loginInput { width: 100%; border: 0; outline: 0; background: transparent; color: var(--text); font-size: 16px; letter-spacing: .6px; }
    .goBtn { border: 1px solid var(--border); border-radius: 12px; padding: 10px 14px; cursor: pointer; font-weight: 800; background: linear-gradient(180deg, rgba(0,229,255,.22), rgba(0,229,255,.08)); color: var(--text); font-size: 18px; line-height: 1; }
    .loginMeta { display:flex; gap:12px; align-items:center; color: var(--muted); font-size: 13px; min-height: 18px; }
    .hidden { display: none !important; }
    .toast { position: fixed; right: 16px; top: 16px; display: grid; gap: 8px; z-index: 9999; }
    .toast-item { background: #0b1120; border: 1px solid rgba(255,255,255,.14); padding: 10px 16px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,.35); animation: card-in .3s ease; display: flex; align-items: center; gap: 10px; }
    .toast-item::before { font-size: 20px; }
    .toast-item.is-success { background-color: rgba(30, 192, 120, .2); border-color: rgba(30, 192, 120, .5); }
    .toast-item.is-success::before { content: '‚úÖ'; }
    .toast-item.is-error { background-color: rgba(255, 79, 79, .2); border-color: rgba(255, 79, 79, .5); }
    .toast-item.is-error::before { content: '‚ùå'; }
    .toast-item.is-info::before { content: '‚ÑπÔ∏è'; }

    @keyframes card-in { from { opacity:0; transform: translateX(20px); } to { opacity:1; transform: none; } }
    @keyframes gentle-float { 0% { transform: rotateX(4deg) rotateY(-5deg); } 25% { transform: rotateX(-3deg) rotateY(4deg); } 50% { transform: rotateX(3deg) rotateY(2deg); } 75% { transform: rotateX(-4deg) rotateY(-3deg); } 100% { transform: rotateX(4deg) rotateY(-5deg); } }
    @media (hover: hover) and (pointer: fine) { .art { animation: gentle-float 25s ease-in-out infinite alternate; } }

    /* --- ESTILOS GENERALES Y ADMIN UI --- */
    .card { border: 1px solid var(--border); border-radius: 18px; padding: 24px; background: var(--panel); box-shadow: 0 20px 48px rgba(0,0,0,.45); }
    .card h2 { margin: 0 0 20px 0; font-size: 20px; color: var(--text); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-header h2 { margin-bottom: 0; }
    .form-label { display: block; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--muted-bright); margin: 16px 0 8px 0; }
    .btn { display: inline-flex; gap: 8px; align-items: center; justify-content: center; padding: 10px 14px; color: var(--text); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; text-decoration: none; transition: all .2s ease; background-color: var(--panel); }
    .btn:hover { filter: brightness(1.1); box-shadow: var(--glow); }
    .btn:active { transform: translateY(1px); filter: brightness(1); }
    .btn.brand { background-color: rgba(0,229,255,.15); border-color: rgba(0,229,255,.6); color: #c2f5ff; }
    .btn.accent { background-color: rgba(255,43,191,.15); border-color: rgba(255,43,191,.6); color: #ffc2ee; }
    .btn.danger { background-color: rgba(255,79,79,.15); border-color: rgba(255,79,79,.55); color: #ffc2c2; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .field { position: relative; }
    .field .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: .85; font-size: 14px; pointer-events: none; }
    .neo { width: 100%; padding: 12px 12px 12px 40px; border-radius: 14px; border: 1px solid var(--border); background: var(--ink); color: var(--text); outline: none; transition: all .2s ease; font-size: 16px; }
    .neo:focus { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }
    .adminLink { position: absolute; right: 1rem; bottom: 1rem; z-index: 60; opacity: .6; font-size: 12px; transition: opacity .2s ease; }
    .adminLink:hover { opacity: 1; }
    .adminLink button { background: none; border: 0; color: #9feaff; text-decoration: underline; cursor: pointer; padding: 0; }
    .modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(7,9,15,.6); backdrop-filter: blur(4px); z-index: 80; opacity: 0; pointer-events: none; transition: opacity .2s ease; }
    .modal.is-open { opacity: 1; pointer-events: auto; }
    .modal .box { width: 100%; max-width: 420px; border-radius: 16px; border: 1px solid var(--border); background: var(--panel); padding: 24px; box-shadow: 0 20px 48px rgba(0,0,0,.5); }

    /* --- ADMIN UI ESPEC√çFICO --- */
    .admin-dashboard { display: grid; grid-template-columns: minmax(320px, 1fr) 2fr; gap: 16px; align-items: start; }
    .admin-reward-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .admin-reward-card { cursor: pointer; text-align: center; border-radius: 8px; border: 2px solid transparent; padding: 4px; transition: all .2s ease; }
    .admin-reward-card img { border-radius: 6px; width: 100%; aspect-ratio: 4/6; object-fit: cover; }
    .admin-reward-card span { font-size: 11px; color: var(--muted); }
    .admin-reward-card.is-selected { border-color: var(--neon-cyan); background-color: rgba(0,229,255,.1); }
    .admin-reward-card.is-selected span { color: var(--text); }
    .admin-reward-card:not(.is-selected) { opacity: 0.7; }
    .admin-reward-card:not(.is-selected):hover { opacity: 1; background-color: rgba(255,255,255,.05); }
    .list { display: grid; gap: 8px; overflow: auto; padding-right: 4px; }
    #usersList { max-height: calc(100vh - 280px); min-height: 300px; }
    .item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; border: 1px solid transparent; background-color: rgba(255,255,255,.03); cursor: pointer; transition: all .2s ease; }
    .item:hover { background-color: rgba(255,255,255,.06); border-color: var(--border); }
    .item.is-selected { color: var(--neon-cyan); background-color: rgba(0,229,255,.10); border-color: rgba(0,229,255,.6); }
    .item.is-selected small { color: var(--neon-cyan); opacity: .8; }
    .item-main { flex-grow: 1; }
    .item-meta { font-size: 12px; color: var(--muted); }
    .item small { color: var(--muted); }
    #noUserSelected { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; color: var(--muted); font-size: 16px; text-align: center; }
    #noUserSelected::before { content: 'üëÜ'; font-size: 48px; margin-bottom: 16px; }
    
    .comment-item { background-color: rgba(255, 255, 255, .04); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }
    .comment-header { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--muted); }
    .comment-author { font-weight: 700; color: var(--neon-pink); }
    .comment-text { font-size: 14px; line-height: 1.5; color: var(--text); margin: 0; }
    #memberCommentsContainer { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    #memberCommentsContainer.is-open { max-height: 500px; }


    /* --- MEMBER UI ESPEC√çFICO --- */
    .member-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
    .member-virtual-card { position: relative; aspect-ratio: 4 / 6; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,.4); transition: transform .3s ease, box-shadow .3s ease; cursor: pointer; }
    .member-virtual-card:hover { transform: translateY(-8px) scale(1.03); box-shadow: 0 20px 40px rgba(0,0,0,.5); }
    .member-virtual-card img { width: 100%; height: 100%; object-fit: cover; }
    .member-virtual-card .label { position: absolute; bottom: 0; left: 0; right: 0; padding: 8px 10px; font-size: 13px; font-weight: 700; color: #0b0b0b; background: linear-gradient(90deg, var(--neon-yellow), var(--neon-cyan)); text-shadow: 0 1px 1px rgba(0,0,0,.1); }
    .member-virtual-card:not(.is-owned) { filter: grayscale(1) saturate(0.5) brightness(0.5); opacity: 0.7; }
    .member-virtual-card.is-owned { filter: none; opacity: 1; }
    .comments-header { display: flex; justify-content: space-between; align-items: center; }

    /* --- EFECTO VENENO / GLITCH --- */
    #poison-overlay { position: fixed; inset: 0; z-index: 9998; background: rgba(100,0,0,.3); backdrop-filter: blur(2px); display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 24px; color: #ffc2c2; text-align: center; font-size: clamp(24px, 8vw, 48px); font-weight: 800; text-shadow: 0 0 10px red; pointer-events: auto; }
    
    body.is-poisoned-active main { animation: glitch-anim .8s infinite steps(2, end) alternate; }
    @keyframes glitch-anim { 0%, 100% { transform: translate(0); } 20% { transform: translate(-5px, 5px); } 40% { transform: translate(-5px, -5px); } 60% { transform: translate(5px, 5px); } 80% { transform: translate(5px, -5px); } }

    body.is-poisoned-accepted .bg-tech, body.is-poisoned-active .bg-tech {
        background: linear-gradient(rgba(40,7,15,.85), rgba(40,7,15,.9)), url('assets/background.png') center / cover no-repeat fixed;
        filter: saturate(1.5) brightness(.7) hue-rotate(330deg);
    }
    body.is-poisoned-accepted .card { background: #280f14; border-color: rgba(255, 79, 79, .55); }
    body.is-poisoned-accepted .card h2 { color: #ffc2c2; }
    body.is-poisoned-accepted .member-virtual-card:not(.is-owned) { opacity: 0.5; }
    body.is-poisoned-accepted #memberGrid .card { pointer-events: none; }
    body.is-poisoned-accepted #memberGrid .card * { pointer-events: none; }
    body.is-poisoned-accepted #memberLogoutBtn { pointer-events: auto !important; }

    /* Media Queries */
    @media (max-width: 980px) { .admin-dashboard { grid-template-columns: 1fr; } }
    @media (max-width: 500px) {
      .art { display: flex; align-items: center; justify-content: center; height: auto; min-height: 90vh; }
      .floating-content { position: static; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; max-width: 400px; height: auto; padding: 2rem 1rem; pointer-events: auto; }
      .logo-wrap { position: static; transform: none; width: clamp(340px, 90vw, 420px); margin-bottom: 24px; }
      .loginFloat { position: static; transform: none; width: 100%; }
    }
    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
  </style>
</head>
<body>
  <div id="poison-overlay" class="hidden">
    <span>Has sido envenenado ‚ò†Ô∏è</span>
    <button id="acceptPoisonBtn" class="btn danger">Aceptar Destino</button>
  </div>
  <div class="bg-tech" aria-hidden="true"></div>

  <div class="wrap">
    <main>
      <section class="landing" id="authGrid">
        <div class="art" aria-hidden="true">
          <div class="background-layer"></div>
          <span class="shine"></span>
        </div>
        <div class="floating-content">
          <div class="logo-wrap">
            <img src="logo.svg" alt="Game Over Logo" />
          </div>
          <div class="loginFloat" role="form" aria-labelledby="loginFormTitle">
            <div class="loginTitle" id="loginFormTitle">iniciar sesi√≥n</div>
            <div class="phoneInput" id="loginBox">
              <span class="phone-prefix">+506</span>
              <input id="loginInput" type="tel" inputmode="numeric" placeholder="8888 6666" autocomplete="one-time-code" aria-label="Tel√©fono" />
              <button id="loginGo" class="goBtn" aria-label="Entrar">&gt;</button>
            </div>
            <div class="loginMeta" id="loginMsg" aria-live="polite"></div>
          </div>
        </div>
        <div class="adminLink"><button id="adminOpen" type="button">[admin]</button></div>
      </section>

      <div id="views-container" class="hidden">
        <section id="memberGrid">
          <div class="card">
            <h2 id="memberGridTitle">Tus Recompensas</h2>
            <div id="memberCards" class="member-cards-grid"></div>
            <hr style="border-color: var(--border); margin: 24px 0;">
            <div class="comments-header">
                <h2>Comentarios</h2>
                <div>
                  <button class="btn" id="toggleCommentsBtn">Ver Comentarios</button>
                  <button class="btn" id="memberLogoutBtn" style="margin-left: 8px;">Salir</button>
                </div>
            </div>
            <div id="memberCommentsContainer">
              <div id="memberComments" class="list" style="margin-top: 1rem;"></div>
            </div>
          </div>
        </section>

        <section id="adminGrid">
          <div class="admin-dashboard">
            <div class="card">
              <div class="card-header">
                <h2>Usuarios</h2>
                <button class="btn accent" id="openAddUserModalBtn">+ A√±adir</button>
              </div>
              <div class="field"><span class="icon">üîé</span><input class="neo" id="search" type="text" placeholder="Buscar..." /></div>
              <div id="usersList" class="list"></div>
            </div>
            <div class="card">
              <div id="editPanel" class="hidden">
                <div class="card-header">
                  <h2>Editar Usuario</h2>
                </div>
                
                <form id="editUserForm">
                    <label class="form-label" for="editUserName">Nombre</label>
                    <div class="field"><span class="icon">üë§</span><input class="neo" id="editUserName" type="text" /></div>
                    <label class="form-label" for="editUserNumericId">ID Num√©rico</label>
                    <div class="field"><span class="icon">#Ô∏è‚É£</span><input class="neo" id="editUserNumericId" type="text" /></div>
                    <label class="form-label" for="editUserPhone">Tel√©fono (ID de Login)</label>
                    <div class="field"><span class="icon">üì±</span><input class="neo" id="editUserPhone" type="tel" /></div>
                    
                    <label class="form-label">Tarjetas del Usuario</label>
                    <div id="editRewards" class="admin-reward-selector"></div>

                    <button class="btn brand" id="saveUserBtn" type="submit" style="width: 100%;">Guardar Cambios</button>
                </form>

                <hr style="border-color: var(--border); margin: 20px 0;">
                
                <label class="form-label">Comentarios</label>
                <div class="field"><span class="icon">üí¨</span><textarea class="neo" id="editComment" placeholder="A√±adir comentario..." style="height: 60px;"></textarea></div>
                <button class="btn" id="addCommentBtn" style="width: 100%; margin-top: 8px;">A√±adir Comentario</button>

                <hr style="border-color: var(--border); margin: 20px 0;">

                <label class="form-label">Acciones Peligrosas</label>
                <div class="row">
                    <button class="btn danger" id="poisonBtn">‚ò†Ô∏è Envenenar</button>
                    <button class="btn danger" id="deleteUserBtn">Eliminar Usuario</button>
                </div>
              </div>
              <div id="noUserSelected">Selecciona un usuario de la lista<br>para ver o editar sus detalles.</div>
            </div>
          </div>
          <div class="card" style="margin-top: 16px;">
            <button class="btn" id="adminLogoutBtn">Cerrar Sesi√≥n de Administrador</button>
          </div>
        </section>
      </div>

      <div id="adminModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="adminModalTitle">
        <div class="box">
          <h2 id="adminModalTitle" class="loginTitle">Acceso de Administrador</h2>
          <label class="form-label" for="adminPwd">Contrase√±a</label>
          <input id="adminPwd" type="password" class="neo" aria-label="Contrase√±a de administrador" />
          <div class="row" style="margin-top:16px;">
            <button class="btn brand" id="adminEnter">Entrar</button>
            <button class="btn" id="adminCancel">Cancelar</button>
          </div>
          <div class="loginMeta" id="adminMsg" style="margin-top: 8px;"></div>
        </div>
      </div>
      <div id="addUserModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addUserModalTitle">
        <div class="box">
          <h2 id="addUserModalTitle" class="loginTitle">A√±adir Nuevo Usuario</h2>
          <label class="form-label" for="newUserName">Nombre</label>
          <div class="field"><span class="icon">üë§</span><input class="neo" id="newUserName" type="text" placeholder="Nombre completo" /></div>
          <label class="form-label" for="newUserNumericId">ID Num√©rico</label>
          <div class="field"><span class="icon">#Ô∏è‚É£</span><input class="neo" id="newUserNumericId" type="text" placeholder="Ej: 001, 042" /></div>
          <label class="form-label" for="newUserPhone">Tel√©fono</label>
          <div class="field"><span class="icon">üì±</span><input class="neo" id="newUserPhone" type="tel" placeholder="Ej: 8888 6666" /></div>
          <label class="form-label">Tarjetas Iniciales</label>
          <div id="newUserRewards" class="admin-reward-selector"></div>
          <div class="row" style="margin-top:16px;">
            <button class="btn accent" id="addUserBtn">Crear Usuario</button>
            <button class="btn" id="cancelAddUserBtn">Cancelar</button>
          </div>
        </div>
      </div>
       <div id="cardDetailModal" class="modal" role="dialog" aria-modal="true">
        <div class="box" style="text-align: center;">
            <img id="cardDetailImg" src="" alt="Detalle de la tarjeta" style="width: 200px; border-radius: 10px; margin-bottom: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.4);">
            <h2 id="cardDetailTitle" style="margin-bottom: 8px;"></h2>
            <p id="cardDetailDesc" style="color: var(--muted); max-width: 320px; margin-left: auto; margin-right: auto;"></p>
            <button class="btn" id="closeCardDetailBtn" style="margin-top: 20px;">Cerrar</button>
        </div>
    </div>
    </main>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { 
        getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, 
        query, orderBy, arrayUnion, deleteDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBlevLcY3TKVYQpr4Hur1f7XeZoHLbXCC0",
      authDomain: "gameover-b6eb7.firebaseapp.com",
      projectId: "gameover-b6eb7",
      storageBucket: "gameover-b6eb7.appspot.com",
      messagingSenderId: "522023719283",
      appId: "1:522023719283:web:3e5ce88c28a52b56a27506"
    };

    const REWARDS = [
      { id: "r1", label: "Joker",    img: "assets/card1.png", description: "Un agente del caos con una mente brillante y una risa inolvidable. Su √∫nico objetivo es demostrar que cualquiera puede caer en la locura." },
      { id: "r2", label: "Predator", img: "assets/card2.png", description: "Un cazador intergal√°ctico que viaja por el universo en busca de las presas m√°s peligrosas. Se rige por un estricto c√≥digo de honor." },
      { id: "r3", label: "Alien",    img: "assets/card3.png", description: "El xenomorfo, un organismo perfecto cuya supervivencia es su √∫nica ley. Una m√°quina de matar biol√≥gica, r√°pida, silenciosa y letal." },
      { id: "r4", label: "Jason",    img: "assets/card4.png", description: "Una fuerza de la naturaleza imparable, renacida de una tragedia en Crystal Lake. Silencioso, brutal e inmortal, persigue a sus v√≠ctimas sin descanso." }
    ];
    
    const REWARD_ORDER = Object.fromEntries(REWARDS.map((r, i) => [r.id, i]));
    const ADMIN_KEY_B64 = 'RmluYWxCb3Nz';

    let db;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (e) { console.error("Error al inicializar Firebase.", e); document.body.innerHTML = '<h1>Error de conexi√≥n.</h1>'; }
    
    const UI = {
        authGrid: document.getElementById('authGrid'),
        viewsContainer: document.getElementById('views-container'),
        loginBox: document.getElementById('loginBox'), loginInput: document.getElementById('loginInput'),
        loginGo: document.getElementById('loginGo'), loginMsg: document.getElementById('loginMsg'),
        adminOpen: document.getElementById('adminOpen'), adminModal: document.getElementById('adminModal'),
        adminPwd: document.getElementById('adminPwd'), adminEnter: document.getElementById('adminEnter'),
        adminCancel: document.getElementById('adminCancel'), adminMsg: document.getElementById('adminMsg'),
        memberGrid: document.getElementById('memberGrid'), memberGridTitle: document.getElementById('memberGridTitle'),
        memberCards: document.getElementById('memberCards'), toggleCommentsBtn: document.getElementById('toggleCommentsBtn'),
        memberCommentsContainer: document.getElementById('memberCommentsContainer'), memberComments: document.getElementById('memberComments'), 
        memberLogoutBtn: document.getElementById('memberLogoutBtn'),
        adminGrid: document.getElementById('adminGrid'),
        openAddUserModalBtn: document.getElementById('openAddUserModalBtn'),
        addUserModal: document.getElementById('addUserModal'),
        newUserName: document.getElementById('newUserName'), newUserNumericId: document.getElementById('newUserNumericId'),
        newUserPhone: document.getElementById('newUserPhone'), newUserRewards: document.getElementById('newUserRewards'),
        addUserBtn: document.getElementById('addUserBtn'), cancelAddUserBtn: document.getElementById('cancelAddUserBtn'),
        search: document.getElementById('search'), usersList: document.getElementById('usersList'),
        editPanel: document.getElementById('editPanel'), editUserForm: document.getElementById('editUserForm'),
        editUserName: document.getElementById('editUserName'), editUserNumericId: document.getElementById('editUserNumericId'),
        editUserPhone: document.getElementById('editUserPhone'),
        editRewards: document.getElementById('editRewards'), editComment: document.getElementById('editComment'),
        saveUserBtn: document.getElementById('saveUserBtn'),
        addCommentBtn: document.getElementById('addCommentBtn'),
        poisonBtn: document.getElementById('poisonBtn'), deleteUserBtn: document.getElementById('deleteUserBtn'),
        noUserSelected: document.getElementById('noUserSelected'),
        adminLogoutBtn: document.getElementById('adminLogoutBtn'),
        cardDetailModal: document.getElementById('cardDetailModal'), cardDetailImg: document.getElementById('cardDetailImg'),
        cardDetailTitle: document.getElementById('cardDetailTitle'), cardDetailDesc: document.getElementById('cardDetailDesc'),
        closeCardDetailBtn: document.getElementById('closeCardDetailBtn'),
        poisonOverlay: document.getElementById('poison-overlay'), acceptPoisonBtn: document.getElementById('acceptPoisonBtn'),
        toast: document.getElementById('toast'),
    };

    let unsubMember = null, unsubUsers = null, unsubEdit = null;
    let cacheUsers = [];
    let selectedUserId = null;
    
    const el = (tag, attrs = {}, children = []) => { const n = document.createElement(tag); Object.entries(attrs).forEach(([k,v]) => { if (k === 'class') n.className = v; else if (k === 'text') n.textContent = v; else if (k === 'dataset') Object.assign(n.dataset, v); else n.setAttribute(k, v); }); children.forEach(c => n.append(c)); return n; };
    const getDigits = s => (s || '').replace(/\D+/g, '');
    const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(()=>fn.apply(null,a), ms); }; };
    const sortRewards = (ids) => (ids || []).slice().sort((a,b) => (REWARD_ORDER[a] ?? 99) - (REWARD_ORDER[b] ?? 99));
    
    function toast(msg, type = 'info') { const item = el('div', { class: `toast-item is-${type}`, text: msg }); UI.toast.appendChild(item); setTimeout(() => { item.style.transition = 'opacity .4s ease, transform .4s ease'; item.style.opacity = '0'; item.style.transform = 'translateX(20px)'; }, 2500); setTimeout(() => item.remove(), 3000); }
    
    function switchView(viewName) {
        document.body.classList.remove('is-poisoned-active', 'is-poisoned-accepted');
        UI.poisonOverlay.classList.add('hidden');
        UI.authGrid.classList.add('hidden');
        UI.viewsContainer.classList.add('hidden');
        if (unsubMember) { unsubMember(); unsubMember = null; }
        if (unsubUsers) { unsubUsers(); unsubUsers = null; }
        clearEditPanel();
        switch (viewName) {
            case 'auth':
                UI.authGrid.classList.remove('hidden');
                UI.loginInput.focus();
                UI.loginMsg.textContent = '';
                localStorage.removeItem('memberId');
                localStorage.removeItem('admin');
                break;
            case 'member':
                UI.viewsContainer.classList.remove('hidden');
                UI.memberGrid.classList.remove('hidden');
                UI.adminGrid.classList.add('hidden');
                startMemberListener(localStorage.getItem('memberId'));
                break;
            case 'admin':
                UI.viewsContainer.classList.remove('hidden');
                UI.adminGrid.classList.remove('hidden');
                UI.memberGrid.classList.add('hidden');
                startUsersListener();
                break;
        }
    }
    
    function renderAdminRewardSelector(container, selected, onToggle) {
      container.innerHTML = '';
      REWARDS.forEach(r => {
        const card = el('div', { class: 'admin-reward-card', dataset: { id: r.id } }, [ el('img', { src: r.img, alt: r.label }), el('span', { text: r.label }) ]);
        if (selected.has(r.id)) card.classList.add('is-selected');
        card.addEventListener('click', () => onToggle(r.id));
        container.appendChild(card);
      });
    }

    function makeAdminRewardToggle(container, selected){
      const toggle = (rid) => { if (selected.has(rid)) selected.delete(rid); else selected.add(rid); renderAdminRewardSelector(container, selected, toggle); };
      renderAdminRewardSelector(container, selected, toggle); return toggle;
    }

    function renderMemberPanels(member) {
      const memberRewards = new Set(member.rewards || []);
      const comments = member.comments || [];
      const hasAllRewards = memberRewards.size === REWARDS.length;

      UI.memberGridTitle.textContent = hasAllRewards ? `üèÜ ¬°COLECCI√ìN COMPLETA! üèÜ` : `Recompensas de ${member.name}`;

      UI.memberCards.innerHTML = '';
      REWARDS.forEach(reward => {
        const isOwned = memberRewards.has(reward.id);
        const cardEl = el('div', { class: 'member-virtual-card', 'data-reward-id': reward.id }, [
            el('img', { src: reward.img, alt: reward.label }),
            el('div', { class: 'label', text: reward.label })
        ]);
        if (isOwned) cardEl.classList.add('is-owned');
        cardEl.addEventListener('click', () => showCardDetails(reward.id));
        UI.memberCards.appendChild(cardEl);
      });

      UI.memberComments.innerHTML = '';
      if (comments.length === 0) { UI.memberComments.appendChild(el('div', { class: 'muted', style: 'text-align: center; padding: 1rem;', text: 'Sin comentarios.' }));
      } else {
        comments.slice().reverse().forEach(c => {
          const item = el('div', { class: 'comment-item' }, [
              el('div', { class: 'comment-header' }, [ el('span', { class: 'comment-author', text: c.author || 'Admin' }), el('span', { text: new Date(c.ts || Date.now()).toLocaleString() }) ]),
              el('p', { class: 'comment-text', text: c.text || '' })
          ]);
          UI.memberComments.appendChild(item);
        });
      }
    }

    function renderUsersList() {
      UI.usersList.innerHTML = '';
      const q = UI.search.value.toLowerCase().trim();
      cacheUsers
        .filter(u => !q || (u.name || '').toLowerCase().includes(q) || (u.phone || '').includes(getDigits(q)) || (u.numericId || '').includes(q))
        .forEach(u => {
          const rewardsCount = (u.rewards || []).length;
          const isComplete = rewardsCount === REWARDS.length;
          const displayName = isComplete ? `üëë [${u.numericId || '???'}] ${u.name}` : `[${u.numericId || '???'}] ${u.name}`;
          const row = el('div', { class: 'item', 'data-id': u.id }, [
              el('div', {class: 'item-main'}, [ el('div', { text: displayName }), el('small', { text: u.phone || '' }) ]),
              el('div', {class: 'item-meta'}, [ el('span', {text: `${rewardsCount}/${REWARDS.length} üÉè`}) ])
          ]);
          if (u.id === selectedUserId) row.classList.add('is-selected');
          row.addEventListener('click', () => {
              if (u.id === selectedUserId) { clearEditPanel(); } else { selectUser(u.id); }
          });
          UI.usersList.appendChild(row);
        });
    }

    function startMemberListener(memberId) {
      if (!memberId || !db) return;
      unsubMember = onSnapshot(doc(db, 'users', memberId), (doc) => {
        if (!doc.exists()) { toast('Este usuario ya no existe.', 'error'); switchView('auth'); return; }
        const memberData = { id: doc.id, ...doc.data() };
        const poisonState = memberData.poisonState || 'none';
        
        document.body.classList.remove('is-poisoned-active', 'is-poisoned-accepted');
        UI.poisonOverlay.classList.add('hidden');

        switch(poisonState) {
          case 'active':
            document.body.classList.add('is-poisoned-active');
            UI.poisonOverlay.classList.remove('hidden');
            break;
          case 'accepted':
            document.body.classList.add('is-poisoned-accepted');
            break;
        }
        
        renderMemberPanels(memberData);
      }, err => { console.error('member onSnapshot', err); toast('Error de conexi√≥n.', 'error'); });
    }

    function startUsersListener() {
      if (!db) return;
      const usersQuery = query(collection(db, 'users'), orderBy('name'));
      unsubUsers = onSnapshot(usersQuery, (snap) => {
        cacheUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderUsersList();
        if (selectedUserId && !cacheUsers.some(u => u.id === selectedUserId)) {
          clearEditPanel();
        }
      }, err => { console.error('users onSnapshot', err); toast('Error al cargar usuarios.', 'error'); });
    }

    function selectUser(id) {
      if (unsubEdit) unsubEdit();
      selectedUserId = id;
      renderUsersList();
      const user = cacheUsers.find(u => u.id === id);
      if (!user) { clearEditPanel(); return; }

      UI.noUserSelected.classList.add('hidden');
      UI.editPanel.classList.remove('hidden');
      UI.editUserName.value = user.name || '';
      UI.editUserNumericId.value = user.numericId || '';
      UI.editUserPhone.value = user.phone ? getDigits(user.phone).substring(3) : '';

      const userRef = doc(db, 'users', id);
      let selectedRewards = new Set();
      makeAdminRewardToggle(UI.editRewards, selectedRewards);
      unsubEdit = onSnapshot(userRef, (doc) => {
        if (!doc.exists()) { toast('Usuario eliminado remotamente.', 'info'); clearEditPanel(); return; }
        const data = doc.data();
        selectedRewards = new Set(sortRewards(data.rewards || []));
        makeAdminRewardToggle(UI.editRewards, selectedRewards);
        const poisonState = data.poisonState || 'none';
        UI.poisonBtn.textContent = poisonState !== 'none' ? '‚úÖ Curar Usuario' : '‚ò†Ô∏è Envenenar';
        if (poisonState !== 'none') UI.poisonBtn.classList.remove('danger'); else UI.poisonBtn.classList.add('danger');
      });
    }

    function clearEditPanel() {
        if (unsubEdit) { unsubEdit(); unsubEdit = null; }
        selectedUserId = null;
        if (cacheUsers.length > 0) renderUsersList();
        UI.editPanel.classList.add('hidden');
        UI.noUserSelected.classList.remove('hidden');
    }
    
    function setupAddUserModal() {
        let selected = new Set();
        const openModal = () => {
          UI.newUserName.value = ''; UI.newUserNumericId.value = ''; UI.newUserPhone.value = ''; selected.clear();
          makeAdminRewardToggle(UI.newUserRewards, selected);
          UI.addUserModal.classList.add('is-open'); UI.newUserName.focus();
        };
        const closeModal = () => UI.addUserModal.classList.remove('is-open');

        UI.openAddUserModalBtn.addEventListener('click', openModal);
        UI.cancelAddUserBtn.addEventListener('click', closeModal);
        
        UI.addUserBtn.onclick = async () => {
            const name = UI.newUserName.value.trim();
            const numericId = UI.newUserNumericId.value.trim();
            const phone = `506${getDigits(UI.newUserPhone.value)}`;
            const initialRewards = Array.from(UI.newUserRewards.querySelectorAll('.is-selected')).map(el => el.dataset.id);

            if (!name || !numericId || phone.length <= 3) { toast('Todos los campos son requeridos.', 'error'); return; }

            const userRef = doc(db, 'users', phone);
            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) { toast('Ese tel√©fono ya est√° registrado', 'error'); return; }
                await setDoc(userRef, { name, numericId, phone, rewards: sortRewards(initialRewards), comments: [], poisonState: 'none', createdAt: Date.now() });
                toast(`Usuario #${numericId} creado con √©xito`, 'success'); closeModal();
            } catch (e) { console.error("Error creando usuario:", e); toast('Error al crear usuario', 'error'); }
        };
    }
    
    function showCardDetails(rewardId) {
      const reward = REWARDS.find(r => r.id === rewardId);
      if (!reward) return;
      UI.cardDetailImg.src = reward.img;
      UI.cardDetailImg.alt = reward.label;
      UI.cardDetailTitle.textContent = reward.label;
      UI.cardDetailDesc.textContent = reward.description;
      UI.cardDetailModal.classList.add('is-open');
    }

    async function handleSaveUser(event) {
        event.preventDefault();
        if (!selectedUserId) return;

        const originalUser = cacheUsers.find(u => u.id === selectedUserId);
        if (!originalUser) { toast('No se encontr√≥ el usuario original.', 'error'); return; }

        const newName = UI.editUserName.value.trim();
        const newNumericId = UI.editUserNumericId.value.trim();
        const newPhone = `506${getDigits(UI.editUserPhone.value)}`;
        const newRewards = sortRewards(Array.from(UI.editRewards.querySelectorAll('.is-selected')).map(el => el.dataset.id));

        if (!newName || !newNumericId || newPhone.length <= 3) { toast('Nombre, ID y tel√©fono no pueden estar vac√≠os.', 'error'); return; }
        
        const updatedData = { ...originalUser, name: newName, numericId: newNumericId, phone: newPhone, rewards: newRewards };
        
        if (newPhone === selectedUserId) {
            try {
                const { id, ...dataToUpdate } = updatedData;
                await updateDoc(doc(db, 'users', selectedUserId), dataToUpdate);
                toast('Usuario actualizado con √©xito.', 'success');
            } catch (e) { console.error(e); toast('Error al actualizar usuario.', 'error'); }
            return;
        }

        if (!confirm(`Est√°s a punto de cambiar el tel√©fono (ID) del usuario. Esta es una operaci√≥n compleja y puede requerir que el usuario vuelva a iniciar sesi√≥n.\n\n¬øDeseas continuar?`)) return;

        try {
            const newDocRef = doc(db, 'users', newPhone);
            const newDocSnap = await getDoc(newDocRef);
            if (newDocSnap.exists()) { toast('El nuevo n√∫mero de tel√©fono ya est√° registrado.', 'error'); return; }
            
            delete updatedData.id;
            await setDoc(newDocRef, updatedData);
            await deleteDoc(doc(db, 'users', selectedUserId));

            toast('Usuario migrado a nuevo ID con √©xito.', 'success');
            clearEditPanel();
        } catch (e) { console.error(e); toast('Error cr√≠tico durante la migraci√≥n.', 'error'); }
    }
    
    function buildIdFromInput() {
        const d = getDigits(UI.loginInput.value);
        return d ? `506${d}` : '';
    }

    async function doLogin() {
        const id = buildIdFromInput();
        if (!id) {
            UI.loginMsg.textContent = 'Ingresa tu n√∫mero de tel√©fono.';
            return;
        }
        UI.loginMsg.textContent = 'Verificando...';
        try {
            const ref = doc(db, 'users', id);
            const snap = await getDoc(ref);
            if (snap.exists()) {
                localStorage.setItem('memberId', id);
                switchView('member');
            } else {
                UI.loginMsg.textContent = 'No se encontr√≥ este usuario.';
            }
        } catch (e) {
            console.error("Error en login:", e);
            UI.loginMsg.textContent = 'Error de conexi√≥n.';
        }
    }
    
    function init() {
        UI.loginGo.addEventListener('click', doLogin);
        UI.loginInput.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
        
        const cM=()=>UI.adminModal.classList.remove('is-open'); const oM=()=>{ UI.adminMsg.textContent=''; UI.adminPwd.value=''; UI.adminModal.classList.add('is-open'); setTimeout(()=>UI.adminPwd.focus(), 50); }; const tA=()=>{ if(UI.adminPwd.value.trim()===atob(ADMIN_KEY_B64)){localStorage.setItem('admin','1'); cM(); switchView('admin');}else{UI.adminMsg.textContent='Contrase√±a incorrecta';}};
        UI.adminOpen.addEventListener('click', oM); UI.adminCancel.addEventListener('click', cM); UI.adminEnter.addEventListener('click', tA); UI.adminPwd.addEventListener('keydown', (e)=>{if(e.key==='Enter')tA();if(e.key==='Escape')cM();});
        UI.memberLogoutBtn.addEventListener('click', ()=>switchView('auth'));
        UI.adminLogoutBtn.addEventListener('click', ()=>switchView('auth'));
        UI.search.addEventListener('input', debounce(renderUsersList, 200));
        
        UI.cardDetailModal.addEventListener('click', (e) => { if(e.target === UI.cardDetailModal) UI.cardDetailModal.classList.remove('is-open'); });
        UI.closeCardDetailBtn.addEventListener('click', () => UI.cardDetailModal.classList.remove('is-open'));
        UI.toggleCommentsBtn.addEventListener('click', () => { UI.memberCommentsContainer.classList.toggle('is-open'); UI.toggleCommentsBtn.textContent = UI.memberCommentsContainer.classList.contains('is-open') ? 'Ocultar Comentarios' : 'Ver Comentarios'; });
        
        UI.acceptPoisonBtn.addEventListener('click', async () => {
          const memberId = localStorage.getItem('memberId');
          if (!memberId) return;
          try {
            await updateDoc(doc(db, 'users', memberId), { poisonState: 'accepted' });
          } catch(e) { toast('Error al aceptar.', 'error'); }
        });

        UI.editUserForm.addEventListener('submit', handleSaveUser);
        UI.addCommentBtn.onclick = async () => { if(!selectedUserId)return; const t=UI.editComment.value.trim(); if(!t){toast('Escribe un comentario', 'error');return;} const ref=doc(db,'users',selectedUserId); try{await updateDoc(ref,{comments:arrayUnion({text:t,ts:Date.now(),author:'admin'})});UI.editComment.value='';toast('Comentario agregado', 'success');}catch(e){console.error(e);toast('Error al comentar', 'error');}};
        UI.deleteUserBtn.onclick = async () => { if(!selectedUserId)return; const u=cacheUsers.find(u=>u.id===selectedUserId); if(!confirm(`¬øEliminar a ${u?.name || 'este usuario'}? Esta acci√≥n no se puede deshacer.`))return; const ref=doc(db,'users',selectedUserId); if(unsubEdit)unsubEdit(); try{await deleteDoc(ref);toast('Usuario eliminado', 'success');clearEditPanel();}catch(e){console.error(e);toast('Error al eliminar', 'error');}};
        UI.poisonBtn.onclick = async () => { if(!selectedUserId) return; const user = cacheUsers.find(u => u.id === selectedUserId); if(!user) return; const ref = doc(db, 'users', selectedUserId); const currentStatus = user.poisonState || 'none'; const newStatus = currentStatus !== 'none' ? 'none' : 'active'; try { await updateDoc(ref, {poisonState: newStatus}); toast(`Usuario ${newStatus === 'none' ? 'curado' : 'envenenado'}.`, 'success'); } catch(e) { toast('Error al cambiar estado.', 'error'); }};

        setupAddUserModal();
        const memberId=localStorage.getItem('memberId'); const isAdmin=localStorage.getItem('admin')==='1';
        if(isAdmin){switchView('admin');}else if(memberId){switchView('member');}else{switchView('auth');}
    }
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>