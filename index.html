<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini CRM de Rewards</title>
  <style>
    :root {
      --bg: #0f1221;
      --panel: #171a2e;
      --muted: #9aa3b2;
      --text: #e7ecf3;
      --brand: #62e0ff;
      --accent: #8ef6a0;
      --danger: #ff7b7b;
    }
    * { box-sizing: border-box; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    body { margin: 0; background: radial-gradient(1200px 600px at 70% -10%, #1a2142, var(--bg)); color: var(--text); }
    .wrap { max-width: 1024px; margin: 0 auto; padding: 24px; }
    .hero { display: grid; gap: 8px; margin-bottom: 16px; }
    .hero h1 { font-size: 28px; margin: 0; letter-spacing: .3px; }
    .hero p { margin: 0; color: var(--muted); }

    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border: 1px solid rgba(255,255,255,.07); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    .card h2 { margin: 0 0 8px; font-size: 18px; }
    .muted { color: var(--muted); font-size: 14px; }

    label { display: block; font-size: 14px; margin: 10px 0 6px; color: var(--muted); }
    input[type="text"], input[type="password"], textarea, select { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: #0e1324; color: var(--text); outline: none; }
    textarea { min-height: 86px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .btn { display: inline-flex; gap: 8px; align-items: center; padding: 10px 14px; background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); color: var(--text); border: 1px solid rgba(255,255,255,.14); border-radius: 12px; cursor: pointer; text-decoration: none; transition: transform .05s ease, filter .2s ease; }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn.brand { background: linear-gradient(180deg, rgba(98,224,255,.20), rgba(98,224,255,.10)); border-color: rgba(98,224,255,.5); }
    .btn.accent { background: linear-gradient(180deg, rgba(142,246,160,.18), rgba(142,246,160,.08)); border-color: rgba(142,246,160,.5); }
    .btn.danger { background: linear-gradient(180deg, rgba(255,123,123,.18), rgba(255,123,123,.08)); border-color: rgba(255,255,255,.5); }

    .badges { display: flex; flex-wrap: wrap; gap: 8px; }
    .badge { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12); background: #0d1222; font-size: 12px; }

    .list { display: grid; gap: 8px; margin-top: 8px; max-height: 340px; overflow: auto; }
    .item { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.02); }
    .item small { color: var(--muted); }

    .sep { height: 1px; background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.12), rgba(255,255,255,.0)); margin: 12px 0; }

    .hidden { display: none !important; }
    .center { text-align: center; }
    .status { margin-top: 8px; font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Mini CRM de Rewards</h1>
      <p class="muted">Login simple por nombre para miembros y un acceso de admin para gestionar usuarios, rewards y comentarios. Datos en Firestore para que todos vean cambios al instante.</p>
      <p id="testStatus" class="status"></p>
    </div>

    <div class="grid" id="authGrid">
      <div class="card">
        <h2>Ingreso de miembro</h2>
        <p class="muted">Escribe tu nombre tal cual lo registró el admin.</p>
        <label>Nombre</label>
        <input id="memberName" type="text" placeholder="Ej. Ana López" />
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn brand" id="memberLoginBtn">Entrar</button>
          <button class="btn" id="demoUserBtn">Probar demo</button>
        </div>
        <p class="muted" id="memberMsg" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <h2>Ingreso admin</h2>
        <p class="muted">Usa la clave compartida en el grupo.</p>
        <label>Clave</label>
        <input id="adminPass" type="password" placeholder="Clave de admin" />
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn accent" id="adminLoginBtn">Entrar como admin</button>
          <button class="btn" id="demoAdminBtn">Probar demo</button>
        </div>
        <p class="muted" id="adminMsg" style="margin-top:8px"></p>
      </div>
    </div>

    <div class="grid hidden" id="memberGrid">
      <div class="card">
        <h2>Tus rewards</h2>
        <div id="memberRewards" class="badges"></div>
        <div class="sep"></div>
        <h2>Tus comentarios</h2>
        <div id="memberComments" class="list"></div>
        <div class="sep"></div>
        <button class="btn" id="memberLogoutBtn">Salir</button>
      </div>
    </div>

    <div class="grid hidden" id="adminGrid">
      <div class="card">
        <h2>Alta rápida</h2>
        <label>Nombre del usuario</label>
        <input id="newUserName" type="text" placeholder="Nuevo miembro" />
        <label>Rewards</label>
        <div id="newUserRewards" class="badges"></div>
        <button class="btn accent" id="addUserBtn" style="margin-top:12px">Crear usuario</button>
        <p class="muted" id="addUserMsg" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <h2>Gestión de usuarios</h2>
        <label>Buscar</label>
        <input id="search" type="text" placeholder="Filtra por nombre" />
        <div class="list" id="usersList"></div>
      </div>

      <div class="card">
        <h2>Editar usuario</h2>
        <div id="editPanel" class="hidden">
          <div class="muted" id="editUserTitle"></div>
          <label>Rewards</label>
          <div id="editRewards" class="badges"></div>
          <label>Comentario para el usuario</label>
          <textarea id="editComment" placeholder="Mensaje breve"></textarea>
          <div class="row" style="margin-top:12px;">
            <button class="btn brand" id="saveRewardsBtn">Guardar rewards</button>
            <button class="btn" id="addCommentBtn">Agregar comentario</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <button class="btn danger" id="deleteUserBtn">Eliminar usuario</button>
            <button class="btn" id="clearPanelBtn">Limpiar panel</button>
          </div>
          <p class="muted" id="editMsg" style="margin-top:8px"></p>
        </div>
        <div id="noUserSelected" class="muted">Selecciona un usuario para editar.</div>
      </div>

      <div class="card">
        <h2>Sesión</h2>
        <button class="btn" id="adminLogoutBtn">Cerrar sesión admin</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // 1) Configura Firebase y rellena con tu propio config
    const firebaseConfig = {
      apiKey: "AIzaSyBlevLcY3TKVYQpr4Hur1f7XeZoHLbXCC0",
      authDomain: "gameover-b6eb7.firebaseapp.com",
      projectId: "gameover-b6eb7",
      storageBucket: "gameover-b6eb7.firebasestorage.app",
      messagingSenderId: "522023719283",
      appId: "1:522023719283:web:3e5ce88c28a52b56a27506"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2) Parámetros básicos del sistema
    const ADMIN_SECRET = "admin-123"; // cambia esta clave
    const REWARDS = [
      { id: "r1", label: "Tarjeta Verde" },
      { id: "r2", label: "Tarjeta Azul" },
      { id: "r3", label: "Tarjeta Dorada" },
      { id: "r4", label: "Tarjeta Platino" }
    ];

    // Helpers UI
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs = {}, children = []) => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if (k === 'class') n.className = v; else if (k === 'text') n.textContent = v; else n.setAttribute(k, v);
      });
      children.forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
      return n;
    };
    const kebab = s => s.toLowerCase().trim().replace(/\s+/g,'-');

    // Estado y listeners
    let currentMember = null;
    let isAdmin = false;
    let selectedUserId = null;
    let unsubMember = null;
    let unsubUsers = null;
    let unsubEdit = null;
    let cacheUsers = [];

    // Debounce simple para búsqueda
    function debounce(fn, ms){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), ms); };
    }

    // Render de chips de rewards reutilizable
    function renderRewardChips(container, selected = new Set(), onToggle) {
      container.innerHTML = '';
      REWARDS.forEach(r => {
        const active = selected.has(r.id);
        const chip = el('button', { class: 'badge', type: 'button' }, [r.label]);
        chip.style.borderColor = active ? 'rgba(142,246,160,.8)' : 'rgba(255,255,255,.12)';
        chip.style.background = active ? 'rgba(142,246,160,.15)' : '#0d1222';
        chip.addEventListener('click', () => onToggle(r.id));
        container.appendChild(chip);
      });
    }

    // Utilidad: crear un toggler estable para chips
    function makeRewardToggle(container, selected) {
      function toggle(rid) {
        if (selected.has(rid)) selected.delete(rid); else selected.add(rid);
        renderRewardChips(container, selected, toggle);
      }
      renderRewardChips(container, selected, toggle);
      return toggle;
    }

    // --- Miembro: listeners en tiempo real ---
    function startMemberListener(memberId){
      if (unsubMember) { unsubMember(); unsubMember = null; }
      if (!memberId) return;
      const ref = db.collection('users').doc(memberId);
      unsubMember = ref.onSnapshot(doc => {
        if (!doc.exists) {
          $('#memberMsg').textContent = 'Este usuario ya no existe.';
          return;
        }
        currentMember = { id: memberId, ...doc.data() };
        renderMemberPanels(currentMember);
      }, err => console.error('member onSnapshot', err));
    }

    function renderMemberPanels(member){
      const rewards = member.rewards || [];
      const comments = member.comments || [];

      const rewardsBox = $('#memberRewards');
      rewardsBox.innerHTML = '';
      if (rewards.length === 0) rewardsBox.appendChild(el('div', { class: 'muted', text: 'Sin rewards asignados todavía.' }));
      rewards.forEach(rid => {
        const r = REWARDS.find(x => x.id === rid);
        rewardsBox.appendChild(el('span', { class: 'badge' }, [r ? r.label : rid]));
      });

      const commentsBox = $('#memberComments');
      commentsBox.innerHTML = '';
      if (comments.length === 0) commentsBox.appendChild(el('div', { class: 'muted', text: 'Sin comentarios por ahora.' }));
      comments.slice().reverse().forEach(c => {
        const item = el('div', { class: 'item' }, [
          el('div', {}, [
            el('div', { text: c.text || '' }),
            el('small', {}, [new Date(c.ts || Date.now()).toLocaleString()])
          ]),
          el('div', { class: 'badge' }, [c.author || 'admin'])
        ]);
        commentsBox.appendChild(item);
      });
    }

    // --- Admin: lista en tiempo real + caché ---
    function startUsersListener(){
      if (unsubUsers) { unsubUsers(); unsubUsers = null; }
      unsubUsers = db.collection('users').orderBy('name').onSnapshot(snap => {
        cacheUsers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderUsersList();
      }, err => console.error('users onSnapshot', err));
    }

    function renderUsersList(){
      const list = $('#usersList');
      list.innerHTML = '';
      const q = ($('#search').value || '').toLowerCase().trim();
      cacheUsers.filter(u => !q || (u.name || '').toLowerCase().includes(q)).forEach(u => {
        const row = el('div', { class: 'item' }, [
          el('div', {}, [
            el('div', { text: u.name || u.id }),
            el('small', {}, [(u.rewards?.length || 0) + ' rewards'])
          ]),
          el('div', {}, [
            el('button', { class: 'btn', type: 'button' }, ['Editar'])
          ])
        ]);
        row.querySelector('button').addEventListener('click', () => selectUser(u.id, u.name || u.id));
        list.appendChild(row);
      });
    }

    const debouncedSearch = debounce(renderUsersList, 200);

    // --- Admin: panel de edición en tiempo real ---
    async function selectUser(id, name) {
      selectedUserId = id;
      if (unsubEdit) { unsubEdit(); unsubEdit = null; }
      $('#noUserSelected').classList.add('hidden');
      $('#editPanel').classList.remove('hidden');
      $('#editUserTitle').textContent = name + ' (' + id + ')';
      const ref = db.collection('users').doc(id);
      let selected = new Set();
      makeRewardToggle($('#editRewards'), selected);

      unsubEdit = ref.onSnapshot(doc => {
        if (!doc.exists) {
          $('#editMsg').textContent = 'El usuario fue eliminado.';
          $('#editPanel').classList.add('hidden');
          $('#noUserSelected').classList.remove('hidden');
          return;
        }
        const data = doc.data();
        selected = new Set(data.rewards || []);
        makeRewardToggle($('#editRewards'), selected);
      }, err => console.error('edit onSnapshot', err));

      $('#saveRewardsBtn').onclick = async () => {
        await ref.update({ rewards: Array.from(selected) });
        $('#editMsg').textContent = 'Rewards guardados.';
      };
      $('#addCommentBtn').onclick = async () => {
        const text = $('#editComment').value.trim();
        if (!text) { $('#editMsg').textContent = 'Escribe un comentario.'; return; }
        await ref.update({
          comments: firebase.firestore.FieldValue.arrayUnion({ text, ts: Date.now(), author: 'admin' })
        });
        $('#editComment').value = '';
        $('#editMsg').textContent = 'Comentario agregado.';
      };
      $('#deleteUserBtn').onclick = async () => {
        if (!confirm('¿Eliminar este usuario?')) return;
        if (unsubEdit) { unsubEdit(); unsubEdit = null; }
        await ref.delete();
        $('#editMsg').textContent = 'Usuario eliminado.';
        selectedUserId = null;
        $('#editPanel').classList.add('hidden');
        $('#noUserSelected').classList.remove('hidden');
      };
      $('#clearPanelBtn').onclick = () => {
        selectedUserId = null;
        if (unsubEdit) { unsubEdit(); unsubEdit = null; }
        $('#editPanel').classList.add('hidden');
        $('#noUserSelected').classList.remove('hidden');
      };
    }

    // Autenticación falsa de miembro
    $('#memberLoginBtn').addEventListener('click', async () => {
      const name = $('#memberName').value.trim();
      if (!name) { $('#memberMsg').textContent = 'Escribe un nombre.'; return; }
      try {
        const id = kebab(name);
        const ref = db.collection('users').doc(id);
        const snap = await ref.get();
        if (!snap.exists) { $('#memberMsg').textContent = 'No existe este usuario. Pide alta al admin.'; return; }
        localStorage.setItem('member', id);
        $('#authGrid').classList.add('hidden');
        $('#memberGrid').classList.remove('hidden');
        startMemberListener(id);
      } catch (e) {
        $('#memberMsg').textContent = 'Error de conexión. Intenta de nuevo.';
        console.error(e);
      }
    });

    $('#memberLogoutBtn').addEventListener('click', () => {
      currentMember = null; localStorage.removeItem('member');
      if (unsubMember) { unsubMember(); unsubMember = null; }
      $('#memberGrid').classList.add('hidden');
      $('#authGrid').classList.remove('hidden');
    });

    // Autenticación simple de admin
    $('#adminLoginBtn').addEventListener('click', async () => {
      const pass = $('#adminPass').value.trim();
      if (pass !== ADMIN_SECRET) { $('#adminMsg').textContent = 'Clave incorrecta.'; return; }
      isAdmin = true; localStorage.setItem('admin', '1');
      showAdminView();
    });

    $('#adminLogoutBtn').addEventListener('click', () => {
      isAdmin = false; localStorage.removeItem('admin');
      if (unsubUsers) { unsubUsers(); unsubUsers = null; }
      if (unsubEdit) { unsubEdit(); unsubEdit = null; }
      $('#adminGrid').classList.add('hidden');
      $('#authGrid').classList.remove('hidden');
    });

    // Demo rápida sin datos reales
    $('#demoUserBtn').addEventListener('click', async () => {
      $('#memberName').value = 'Demo User';
      await ensureDemoData();
      $('#memberLoginBtn').click();
    });
    $('#demoAdminBtn').addEventListener('click', () => {
      $('#adminPass').value = ADMIN_SECRET;
      $('#adminLoginBtn').click();
    });

    // Vista miembro
    function showMemberView() {
      $('#authGrid').classList.add('hidden');
      $('#memberGrid').classList.remove('hidden');
    }

    // Vista admin
    function showAdminView() {
      $('#authGrid').classList.add('hidden');
      $('#adminGrid').classList.remove('hidden');
      setupCreateUser();
      startUsersListener();
      $('#search').focus();
    }

    function setupCreateUser() {
      const selected = new Set();
      makeRewardToggle($('#newUserRewards'), selected);

      $('#addUserBtn').onclick = async () => {
        const name = $('#newUserName').value.trim();
        if (!name) { $('#addUserMsg').textContent = 'Escribe un nombre.'; return; }
        const id = kebab(name);
        const ref = db.collection('users').doc(id);
        const doc = await ref.get();
        if (doc.exists) { $('#addUserMsg').textContent = 'Ese usuario ya existe.'; return; }
        await ref.set({ name, rewards: Array.from(selected), comments: [], createdAt: Date.now() });
        $('#addUserMsg').textContent = 'Usuario creado.';
        $('#newUserName').value = '';
        selected.clear();
        makeRewardToggle($('#newUserRewards'), selected);
      };
    }

    // Búsqueda con debounce
    $('#search').addEventListener('input', debouncedSearch);

    // Restaurar sesión si existe
    window.addEventListener('DOMContentLoaded', async () => {
      runSmokeTests();
      const m = localStorage.getItem('member');
      const a = localStorage.getItem('admin');
      if (m) {
        showMemberView();
        startMemberListener(m);
        return;
      }
      if (a === '1') { showAdminView(); return; }
    });

    // Datos de ejemplo para la demo
    async function ensureDemoData() {
      const sample = [
        { name: 'Demo User', rewards: ['r1','r3'], comments: [{ text: 'Bienvenido a la comunidad', ts: Date.now()-86400000, author: 'admin' }] },
        { name: 'Ana López', rewards: ['r2'], comments: [] },
        { name: 'Carlos Pérez', rewards: ['r4'], comments: [{ text: 'Felicidades por el logro', ts: Date.now()-3600000, author: 'admin' }] }
      ];
      for (const u of sample) {
        const id = kebab(u.name);
        const ref = db.collection('users').doc(id);
        const snap = await ref.get();
        if (!snap.exists) await ref.set({ ...u, createdAt: Date.now() });
      }
    }

    // Pruebas rápidas (smoke tests)
    async function runSmokeTests() {
      const results = [];
      try {
        results.push(['Firebase cargó', typeof firebase !== 'undefined']);
        results.push(['DB inicializada', !!db]);
        results.push(['Funciones clave', ['showAdminView','selectUser','renderUsersList','renderMemberPanels','makeRewardToggle'].every(k => typeof window[k] === 'function')]);
        results.push(['Elementos UI', ['authGrid','memberGrid','adminGrid'].every(id => !!document.getElementById(id))]);
        try {
          await db.collection('users').limit(1).get();
          results.push(['Permisos de lectura', true]);
        } catch(e) {
          console.warn('Smoke read failed', e);
          results.push(['Permisos de lectura', false]);
        }
      } catch (e) {
        console.error('Smoke tests error', e);
        results.push(['Autochequeo falló', false]);
      }
      const ok = results.every(r => r[1]);
      const msg = results.map(r => `${r[0]}: ${r[1] ? '✔' : '✖'}`).join(' • ');
      const elStatus = document.getElementById('testStatus');
      if (elStatus) elStatus.textContent = `Autochequeo: ${msg}`;
      console.log('Smoke tests', results);
      return ok;
    }
  </script>
</body>
</html>
