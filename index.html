<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GAME OVER ¬∑ Rewards CRM</title>
  <style>
    /* Tema oscuro con acentos ne√≥n para m√°xima legibilidad */
    :root {
      --ink: #07090f;           /* fondo principal muy oscuro */
      --panel: #0f1424;         /* paneles */
      --neon-yellow: #f6f200;   /* amarillo √°cido */
      --neon-cyan: #00e5ff;     /* cian el√©ctrico */
      --neon-pink: #ff2bbf;     /* magenta graffiti */
      --muted: #a7b0c0;
      --text: #f2f6ff;          /* texto alto contraste */
      --border: rgba(255,255,255,.12);
      --glow: 0 0 0 2px rgba(0,229,255,.25), 0 0 0 6px rgba(0,229,255,.12);
    }

    * { box-sizing: border-box; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    body { margin: 0; color: var(--text); background: var(--ink); }

    /* Fondo: grid oscuro con l√≠neas ne√≥n sutiles */
    .bg-tech { position: fixed; inset: 0; z-index: -1; overflow: hidden; background:
      radial-gradient(800px 400px at 80% 0%, rgba(0,229,255,.14), transparent 60%),
      radial-gradient(600px 300px at 15% 100%, rgba(255,43,191,.14), transparent 60%),
      repeating-linear-gradient(90deg, rgba(0,229,255,.08), rgba(0,229,255,.08) 1px, transparent 1px, transparent 80px),
      repeating-linear-gradient(0deg, rgba(255,43,191,.06), rgba(255,43,191,.06) 1px, transparent 1px, transparent 80px),
      var(--ink);
    }
    .bg-tech::before, .bg-tech::after{ content:""; position:absolute; inset:auto; pointer-events:none; }
    .bg-tech::before{ bottom:0; left:0; right:0; height:34%; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01)); border-top: 1px solid rgba(255,255,255,.08); clip-path: polygon(0 10%, 68% 0, 100% 6%, 100% 100%, 0 100%); }
    .bg-tech::after{ top:8%; left:6%; width:160px; height:160px; border:2px dashed rgba(0,229,255,.45); border-radius:24px; transform: rotate(14deg); }

    .wrap { max-width: 1120px; margin: 0 auto; padding: 24px; }

    .hero { display: grid; gap: 6px; margin-bottom: 16px; }
    .gameover { font-weight: 900; font-size: 42px; letter-spacing: 1px; text-transform: uppercase; color: var(--neon-yellow); text-shadow: 0 2px 0 #000, 0 0 8px rgba(246,242,0,.6), 0 0 22px rgba(246,242,0,.35); }
    .subtitle { color: var(--muted); opacity:.95; }

    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border: 1px solid var(--border); border-radius: 18px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .card h2 { margin: 0 0 8px; font-size: 18px; text-transform: uppercase; letter-spacing: .5px; color: var(--text); }
    .muted { color: var(--muted); font-size: 14px; }

    /* Login minimalista tipo "LOGIN [ input }" con CTA discreto */
    .loginRow { display:flex; align-items:center; gap:12px; }
    .loginLabel { font-weight: 900; letter-spacing: 1px; color: var(--text); }
    .bracket { position: relative; flex: 1; background: #0b1120; border: 1px solid var(--border); border-radius: 14px; padding: 8px 12px; padding-right: 48px; box-shadow: var(--glow); }
    .bracket::before { content: '['; position: absolute; left: -16px; top: 50%; transform: translateY(-50%); color: var(--neon-cyan); font-weight: 900; font-size: 20px; }
    .bracket::after { content: '}'; position: absolute; right: -16px; top: 50%; transform: translateY(-50%); color: var(--neon-cyan); font-weight: 900; font-size: 20px; }
    .bracket input { width: 100%; border: 0; outline: 0; background: transparent; color: var(--text); font-size: 16px; }
    .bracket .submit { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); border: 1px solid var(--border); background: rgba(255,255,255,.06); border-radius: 10px; padding: 6px 10px; cursor: pointer; color: var(--text); }
    .bracket .submit:hover { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }

    /* Chips de admin (solo texto) */
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border); background: #0d1222; font-size: 13px; cursor: pointer; }
    .chip.is-selected { box-shadow: var(--glow); border-color: rgba(0,229,255,.6); }
    .chip.lock { cursor: not-allowed; opacity: .6; }

    /* Galer√≠a para miembros */
    .gallery { display:grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap:12px; }
    .gallery .cardart { border-radius: 16px; overflow:hidden; border:1px solid var(--border); box-shadow: 0 8px 20px rgba(0,0,0,.35); background:#0d1222; }
    .gallery .cardart img { width:100%; display:block; aspect-ratio: 2/3; object-fit: cover; filter: contrast(1.05); }
    .gallery .label { padding:6px 8px; font-size:12px; color:#0b0b0b; background: linear-gradient(90deg, var(--neon-yellow), var(--neon-cyan)); font-weight: 700; }

    .list { display: grid; gap: 8px; margin-top: 8px; max-height: 340px; overflow: auto; }
    .item { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.03); }
    .item small { color: var(--muted); }

    .sep { height: 1px; background: linear-gradient(90deg, rgba(255,255,255,.0), rgba(255,255,255,.22), rgba(255,255,255,.0)); margin: 12px 0; }

    .hidden { display: none !important; }
    .status { margin-top: 8px; font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="bg-tech"></div>
  <div class="wrap">
    <div class="hero">
      <div class="gameover">Game Over ¬∑ Rewards</div>
      <div class="subtitle">Tema techno urbano. Final Boss no se asigna a nadie hasta el evento final.</div>
      <p id="testStatus" class="status"></p>
    </div>

    <!-- Login unificado: un solo campo inteligente (tel√©fono o clave admin secreta) -->
    <div class="grid" id="authGrid">
      <div class="card">
        <div class="loginRow">
          <span class="loginLabel">LOGIN</span>
          <div class="bracket">
            <input id="loginKey" type="text" placeholder="Ingresa tu tel√©fono" autocomplete="off" inputmode="numeric" />
            <button id="loginBtn" class="submit" aria-label="Entrar">‚Üí</button>
          </div>
        </div>
        <p class="muted" id="loginHint" style="margin-top:8px">Presiona Enter o el bot√≥n para continuar.</p>
        <p class="muted" id="loginMsg" style="margin-top:4px"></p>
      </div>
    </div>

    <!-- Vista miembro -->
    <div class="grid hidden" id="memberGrid">
      <div class="card">
        <h2>Tus tarjetas</h2>
        <div id="memberCards" class="gallery"></div>
        <div class="sep"></div>
        <h2>Tus comentarios</h2>
        <div id="memberComments" class="list"></div>
        <div class="sep"></div>
        <button class="btn" id="memberLogoutBtn">Salir</button>
      </div>
    </div>

    <!-- Vista admin -->
    <div class="grid hidden" id="adminGrid">
      <div class="card">
        <h2>Alta r√°pida</h2>
        <label>Nombre del usuario</label>
        <input id="newUserName" type="text" placeholder="Nuevo miembro" />
        <label>Tel√©fono (login)</label>
        <input id="newUserPhone" type="text" placeholder="Ej. +52 55 1234 5678" />
        <label>Selecciona tarjetas</label>
        <div id="newUserRewards" class="chips"></div>
        <small class="muted">Final Boss se desbloquea en el evento final y no se asigna manualmente.</small>
        <button class="btn accent" id="addUserBtn" style="margin-top:12px">Crear usuario</button>
        <p class="muted" id="addUserMsg" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <h2>Gesti√≥n de usuarios</h2>
        <label>Buscar</label>
        <input id="search" type="text" placeholder="Filtra por nombre o tel√©fono" />
        <div class="list" id="usersList"></div>
      </div>

      <div class="card">
        <h2>Editar usuario</h2>
        <div id="editPanel" class="hidden">
          <div class="muted" id="editUserTitle"></div>
          <label>Tarjetas</label>
          <div id="editRewards" class="chips"></div>
          <label>Comentario para el usuario</label>
          <textarea id="editComment" placeholder="Mensaje breve"></textarea>
          <div class="row" style="margin-top:12px;">
            <button class="btn brand" id="saveRewardsBtn">Guardar</button>
            <button class="btn" id="addCommentBtn">Agregar comentario</button>
          </div>
          <div class="row" style="margin-top:8px;">
            <button class="btn danger" id="deleteUserBtn">Eliminar usuario</button>
            <button class="btn" id="clearPanelBtn">Limpiar panel</button>
          </div>
          <p class="muted" id="editMsg" style="margin-top:8px"></p>
        </div>
        <div id="noUserSelected" class="muted">Selecciona un usuario para editar.</div>
      </div>

      <div class="card">
        <h2>Sesi√≥n</h2>
        <button class="btn" id="adminLogoutBtn">Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // 1) Configura Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBlevLcY3TKVYQpr4Hur1f7XeZoHLbXCC0",
      authDomain: "gameover-b6eb7.firebaseapp.com",
      projectId: "gameover-b6eb7",
      storageBucket: "gameover-b6eb7.firebasestorage.app",
      messagingSenderId: "522023719283",
      appId: "1:522023719283:web:3e5ce88c28a52b56a27506"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2) Cat√°logo de tarjetas (orden 1‚Üí4, Final Boss bloqueado)
    const REWARDS = [
      { id: "r1", label: "Joker",    img: "assets/card1.png", assignable: true },
      { id: "r2", label: "Predator", img: "assets/card2.png", assignable: true },
      { id: "r3", label: "Alien",    img: "assets/card3.png", assignable: true },
      { id: "r4", label: "Jason",    img: "assets/card4.png", assignable: true },
      { id: "r5", label: "Final Boss. Chucky", img: "assets/card5.png", assignable: false }
    ];
    const ORDER = Object.fromEntries(REWARDS.map((r, i) => [r.id, i]));

    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs = {}, children = []) => { const n = document.createElement(tag); Object.entries(attrs).forEach(([k,v]) => { if (k === 'class') n.className = v; else if (k === 'text') n.textContent = v; else n.setAttribute(k, v); }); children.forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c)); return n; };
    const phoneKey = s => (s || '').replace(/\D+/g, ''); // solo d√≠gitos para ID

    // Estado + listeners
    let unsubMember = null, unsubUsers = null, unsubEdit = null;
    let cacheUsers = [];

    const allow = rid => (REWARDS.find(r => r.id === rid)?.assignable !== false);
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,a), ms); }; }

    // Chips de admin (solo nombres)
    function renderRewardChips(container, selected = new Set(), onToggle, { enforceAssignable = true } = {}){
      container.innerHTML = '';
      REWARDS.forEach(r => {
        const disabled = enforceAssignable && !r.assignable;
        const chip = el('button', { class: 'chip' + (disabled ? ' lock' : '') , type: 'button' }, [r.label]);
        if (selected.has(r.id)) chip.classList.add('is-selected');
        if (!disabled) chip.addEventListener('click', () => onToggle(r.id));
        container.appendChild(chip);
      });
    }
    function makeChipToggle(container, selected, opts){
      function toggle(rid){ if (selected.has(rid)) selected.delete(rid); else selected.add(rid); renderRewardChips(container, selected, toggle, opts); }
      renderRewardChips(container, selected, toggle, opts); return toggle;
    }

    // Miembro: tiempo real
    function startMemberListener(memberId){
      if (unsubMember) { unsubMember(); unsubMember = null; }
      if (!memberId) return;
      const ref = db.collection('users').doc(memberId);
      unsubMember = ref.onSnapshot(doc => {
        if (!doc.exists) { document.getElementById('loginMsg').textContent = 'Este usuario ya no existe.'; return; }
        const data = doc.data();
        renderMemberPanels({ id: memberId, ...data });
      }, err => console.error('member onSnapshot', err));
    }

    function sortRewards(ids){
      return (ids || []).slice().sort((a,b)=> (ORDER[a] ?? 999) - (ORDER[b] ?? 999));
    }

    function renderMemberPanels(member){
      const rewards = sortRewards(member.rewards || []);
      const comments = member.comments || [];

      const cardsBox = document.getElementById('memberCards');
      cardsBox.innerHTML = '';
      if (rewards.length === 0) cardsBox.appendChild(el('div', { class: 'muted', text: 'A√∫n no tienes tarjetas.' }));
      rewards.forEach(rid => {
        const r = REWARDS.find(x => x.id === rid);
        const wrap = el('div', { class: 'cardart' }, [ el('img', { src: r?.img || '', alt: r?.label || rid }), el('div', { class: 'label', text: r?.label || rid }) ]);
        cardsBox.appendChild(wrap);
      });

      const commentsBox = document.getElementById('memberComments');
      commentsBox.innerHTML = '';
      if (comments.length === 0) commentsBox.appendChild(el('div', { class: 'muted', text: 'Sin comentarios por ahora.' }));
      comments.slice().reverse().forEach(c => {
        const item = el('div', { class: 'item' }, [
          el('div', {}, [ el('div', { text: c.text || '' }), el('small', {}, [new Date(c.ts || Date.now()).toLocaleString()]) ]),
          el('div', { class: 'chip is-selected' }, [c.author || 'admin'])
        ]);
        commentsBox.appendChild(item);
      });
    }

    // Admin: lista y edici√≥n en tiempo real
    function startUsersListener(){
      if (unsubUsers) { unsubUsers(); unsubUsers = null; }
      unsubUsers = db.collection('users').orderBy('name').onSnapshot(snap => {
        cacheUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderUsersList();
      }, err => console.error('users onSnapshot', err));
    }

    function renderUsersList(){
      const list = document.getElementById('usersList'); list.innerHTML = '';
      const q = (document.getElementById('search').value || '').toLowerCase().trim();
      cacheUsers.filter(u => !q || (u.name || '').toLowerCase().includes(q) || (u.phone || '').includes(q.replace(/\D+/g,''))).forEach(u => {
        const row = el('div', { class: 'item' }, [
          el('div', {}, [ el('div', { text: u.name || u.id }), el('small', {}, [ (u.phone ? ('üì± ' + u.phone) : u.id) + ' ‚Ä¢ ' + (u.rewards?.length || 0) + ' tarjetas' ]) ]),
          el('div', {}, [ el('button', { class: 'btn', type: 'button' }, ['Editar']) ])
        ]);
        row.querySelector('button').addEventListener('click', () => selectUser(u.id, u.name || u.id));
        list.appendChild(row);
      });
    }

    async function selectUser(id, name){
      if (unsubEdit) { unsubEdit(); unsubEdit = null; }
      document.getElementById('noUserSelected').classList.add('hidden');
      document.getElementById('editPanel').classList.remove('hidden');
      document.getElementById('editUserTitle').textContent = name + ' (' + id + ')';
      const ref = db.collection('users').doc(id);
      let selected = new Set();
      makeChipToggle(document.getElementById('editRewards'), selected, { enforceAssignable: true });

      unsubEdit = ref.onSnapshot(doc => {
        if (!doc.exists) { document.getElementById('editMsg').textContent = 'El usuario fue eliminado.'; document.getElementById('editPanel').classList.add('hidden'); document.getElementById('noUserSelected').classList.remove('hidden'); return; }
        const data = doc.data();
        selected = new Set(sortRewards((data.rewards || []).filter(allow)));
        makeChipToggle(document.getElementById('editRewards'), selected, { enforceAssignable: true });
      });

      document.getElementById('saveRewardsBtn').onclick = async () => {
        await ref.update({ rewards: sortRewards(Array.from(selected).filter(allow)) });
        document.getElementById('editMsg').textContent = 'Tarjetas guardadas.';
      };
      document.getElementById('addCommentBtn').onclick = async () => {
        const text = document.getElementById('editComment').value.trim(); if (!text) { document.getElementById('editMsg').textContent = 'Escribe un comentario.'; return; }
        await ref.update({ comments: firebase.firestore.FieldValue.arrayUnion({ text, ts: Date.now(), author: 'admin' }) });
        document.getElementById('editComment').value = ''; document.getElementById('editMsg').textContent = 'Comentario agregado.';
      };
      document.getElementById('deleteUserBtn').onclick = async () => {
        if (!confirm('¬øEliminar este usuario?')) return; if (unsubEdit) { unsubEdit(); unsubEdit = null; }
        await ref.delete(); document.getElementById('editMsg').textContent = 'Usuario eliminado.';
        document.getElementById('editPanel').classList.add('hidden'); document.getElementById('noUserSelected').classList.remove('hidden');
      };
      document.getElementById('clearPanelBtn').onclick = () => { if (unsubEdit) { unsubEdit(); unsubEdit = null; } document.getElementById('editPanel').classList.add('hidden'); document.getElementById('noUserSelected').classList.remove('hidden'); };
    }

    // Login unificado: Enter o bot√≥n ‚Üí
    async function doLogin(){
      const key = document.getElementById('loginKey').value.trim();
      const msg = document.getElementById('loginMsg');
      if (!key) { msg.textContent = 'Ingresa tu tel√©fono.'; return; }
      // Admin: palabra secreta (no se muestra en UI)
      if (key.toLowerCase() === 'finalboss') {
        localStorage.setItem('admin','1'); showAdminView(); return;
      }
      const id = phoneKey(key);
      if (!id) { msg.textContent = 'Tel√©fono inv√°lido.'; return; }
      try {
        const ref = db.collection('users').doc(id); const snap = await ref.get();
        if (!snap.exists) { msg.textContent = 'No existe este usuario. Pide alta al admin.'; return; }
        localStorage.setItem('member', id); showMemberView(); startMemberListener(id);
      } catch(e){ msg.textContent = 'Error de conexi√≥n. Intenta de nuevo.'; console.error(e); }
    }

    document.getElementById('loginKey').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doLogin(); });
    document.getElementById('loginBtn').addEventListener('click', doLogin);

    // Controles de sesi√≥n
    document.getElementById('memberLogoutBtn').addEventListener('click', () => { localStorage.removeItem('member'); if (unsubMember) { unsubMember(); unsubMember = null; } showAuth(); });
    document.getElementById('adminLogoutBtn').addEventListener('click', () => { localStorage.removeItem('admin'); if (unsubUsers) { unsubUsers(); unsubUsers = null; } if (unsubEdit) { unsubEdit(); unsubEdit = null; } showAuth(); });

    function showAuth(){ document.getElementById('adminGrid').classList.add('hidden'); document.getElementById('memberGrid').classList.add('hidden'); document.getElementById('authGrid').classList.remove('hidden'); document.getElementById('loginKey').focus(); }
    function showMemberView(){ document.getElementById('authGrid').classList.add('hidden'); document.getElementById('memberGrid').classList.remove('hidden'); }
    function showAdminView(){ document.getElementById('authGrid').classList.add('hidden'); document.getElementById('adminGrid').classList.remove('hidden'); setupCreateUser(); startUsersListener(); document.getElementById('search').focus(); }

    function setupCreateUser(){
      const selected = new Set();
      makeChipToggle(document.getElementById('newUserRewards'), selected, { enforceAssignable: true });
      document.getElementById('addUserBtn').onclick = async () => {
        const name = document.getElementById('newUserName').value.trim();
        const phone = phoneKey(document.getElementById('newUserPhone').value.trim());
        if (!name) { document.getElementById('addUserMsg').textContent = 'Escribe un nombre.'; return; }
        if (!phone) { document.getElementById('addUserMsg').textContent = 'Escribe un tel√©fono v√°lido.'; return; }
        const ref = db.collection('users').doc(phone); const doc = await ref.get();
        if (doc.exists) { document.getElementById('addUserMsg').textContent = 'Ese tel√©fono ya est√° registrado.'; return; }
        await ref.set({ name, phone, rewards: sortRewards(Array.from(selected).filter(allow)), comments: [], createdAt: Date.now() });
        document.getElementById('addUserMsg').textContent = 'Usuario creado.';
        document.getElementById('newUserName').value = ''; document.getElementById('newUserPhone').value = ''; selected.clear();
        makeChipToggle(document.getElementById('newUserRewards'), selected, { enforceAssignable: true });
      };
    }

    document.getElementById('search').addEventListener('input', debounce(renderUsersList, 180));

    window.addEventListener('DOMContentLoaded', async () => {
      runSmokeTests();
      const m = localStorage.getItem('member'); const a = localStorage.getItem('admin');
      if (a === '1') { showAdminView(); return; }
      if (m) { showMemberView(); startMemberListener(m); return; }
      showAuth();
    });

    async function runSmokeTests(){
      const results = [];
      try {
        results.push(['Firebase carg√≥', typeof firebase !== 'undefined']);
        results.push(['DB inicializada', !!db]);
        results.push(['Cat√°logo 5 tarjetas', REWARDS.length === 5 && REWARDS.some(r=>!r.assignable)]);
        results.push(['Funciones clave', ['renderRewardChips','makeChipToggle','startUsersListener','startMemberListener','selectUser','sortRewards','doLogin'].every(k => typeof window[k] === 'function')]);
        await db.collection('users').limit(1).get(); results.push(['Permisos de lectura', true]);
      } catch(e){ console.warn('Smoke tests', e); results.push(['Autochequeo fall√≥', false]); }
      const elStatus = document.getElementById('testStatus'); if (elStatus) elStatus.textContent = 'Autochequeo: ' + results.map(r=>`${r[0]}: ${r[1]?'‚úî':'‚úñ'}`).join(' ‚Ä¢ ');
    }
  </script>
</body>
</html>
